const DEVEL=true;const CALENDAR_PLUGIN_DATE_FORMAT='DD/MM/YYYY';const MODAL_TIME_CLOSE=4000;const BTN_CLASS='btn';const BTN_SECONDARY_CLASS=BTN_CLASS+' btn-secondary';const BTN_PRIMARY_CLASS=BTN_CLASS+' btn-primary';const BTN_DANGER_CLASS=BTN_CLASS+' btn-danger';const BTN_LINK_CLASS=BTN_CLASS+' btn-link';const FORM_CONTROL_CLASS='form-control';const FORM_SELECT_CLASS='form-select';const TABLE_CLASS='table';const DEFAULT_LOADING_SPINNER='<div class="loading-document"><div class="spinner-border text-primary" role="status"></div></div>';const MEDIA_MOBILE=992;const COOKIE_GO_DESKTOP='goDesktop';const COOKIE_NEWSLETTER_POPUP='NEWSLETTERPOPUPALERT';const COOKIE_COMPARISON_CUSTOM_TAGS='COMPARISONCUSTOMTAGS';const COOKIE_COUNTRY_SELECTOR_POPUP='COUNTRYSELECTORPOPUP';const COOKIE_CONFIRM_AGE_POPUP='CONFIRMAGEPOPUPALERT';const COOKIE_SELECT_MAP_KIND_POPUP='SELECTMAPKINDMODALPOPUP';
'use strict';var LC=(window.LC={});if(logicommerceGlobal!==undefined){LC.global={session:logicommerceGlobal.session,settings:logicommerceGlobal.settings,avoidTrackings:logicommerceGlobal.avoidTrackings,languageSheet:logicommerceGlobal.languageSheet,routePaths:logicommerceGlobal.routePaths,countries:logicommerceGlobal.countries};if(LC.global.session.user==undefined){LC.global.session.user={userAdditionalInformation:{simulatedUser:false}};}}else{LC.global={session:session,settings:settings,avoidTrackings:avoidTrackings,languageSheet:languageSheet,routePaths:routePaths,countries:countries};}
LC.VERSION='2.0.0';LC.config={showModalBasket:true,notify:{type:'notes',speed:500,delay:3000,easing:'swing',effect:'fade',removeIcon:'<svg class="icon"><use xlink:href="#icon-close"></use></svg>',successIcon:'',dangerIcon:'',},notifyMode:true,forceLoad:false,avt:false,avoid:false,orderReturnRequestReload:true,productsFilterCustomTagGroupsExclusion:true,};LC.validateFormConf={borderColorOnError:'',addValidClassOnAll:true,scrollToTopOnError:false,onError:function($form){const form=$form[0],errorEl=form.querySelector('.has-error');window.scrollTo(0,LC.events.scrollTop);if(errorEl){const intoHeader=form.closest('header')!==null,isBuyForm=form.matches('[data-lc-form="buyProductForm"]');if(!intoHeader&&!isBuyForm){errorEl.scrollIntoView({block:"center",behavior:'smooth'});}}},};LC.require={css:function(source){var cssfile=document.createElement('link');cssfile.setAttribute('rel','stylesheet');cssfile.setAttribute('type','text/css');cssfile.setAttribute('href',source);if(typeof cssfile!='undefined')document.getElementsByTagName('head')[0].appendChild(cssfile);},js:function(source,load){if(!load)load=function(){};$.getScript(source,load);},cachedJs:function(url,options){options=$.extend(options||{},{dataType:'script',cache:true,url:url,});return jQuery.ajax(options);},};LC.extend=function(protoProps,staticProps){var parent=this;var child;if(protoProps&&protoProps.hasOwnProperty('constructor'))child=protoProps.constructor;else
child=function(){return parent.apply(this,arguments);};$.extend(child,parent);var Surrogate=function(){this.constructor=child;};Surrogate.prototype=parent.prototype;child.prototype=new Surrogate();if(protoProps)$.extend(child.prototype,protoProps,staticProps);child.__super__=parent.prototype;return child;};LC.uniqueId={objPrefixes:{},get:function(prefix){if(prefix in LC.uniqueId.objPrefixes)LC.uniqueId.objPrefixes[prefix]++;else LC.uniqueId.objPrefixes[prefix]=1;var id=LC.uniqueId.objPrefixes[prefix]+'';return prefix?prefix+id:id;}};LC.carryMethod=function(path,carry){if(!path)return false;carry=carry||window;var arrCall=path.split('.');for(var i=0;i<arrCall.length;i++){if(!carry[arrCall[i]])return false;if(typeof carry[arrCall[i]]==='function')return carry[arrCall[i]];carry=carry[arrCall[i]];}
return false;};LC.pluginEvents=[];LC.resources={initialize:function(){},parent:function(){return this.constructor.__super__;},superForm:function(method){if(!method)return;var args=Array.prototype.slice.call(arguments,1);var obj=this.constructor.__super__;if(obj&&$.isFunction(obj[method]))obj[method].apply(this,args);},trigger:function(triggerName){var result=false;var functionTrigger=this['custom_'+triggerName];var args=Array.prototype.slice.call(arguments,1);if(this&&$.isFunction(functionTrigger)){result=true;functionTrigger.apply(this,args);}
return result;},addPluginListener:function(listener,method,force){var allowedListeners=['onUserLogin','onUserSignUp','onAddProduct','onRemoveProduct','onProductClick','onAddWishList','onAddShoppingList','setPaymentSystem','setShippingSection','deleteRow','beforeSubmitEndOrder','initializePaymentsBefore','initializePaymentsCallback','beforeExpressCheckoutRedirect'];if(allowedListeners.indexOf(listener)<0)return false;if(!$.isFunction(method))return false;if(LC.pluginEvents.indexOf(listener)<0){LC.pluginEvents.push(listener);LC.pluginEvents[listener]=[];}
LC.config.forceLoad=force||false;LC.config.avt=LC.global.avoidTrackings||false;LC.config.avoid=LC.config.forceLoad?false:LC.config.avt;if(!LC.config.avoid)LC.pluginEvents[listener].push(method);return true;},pluginListener:function(listener){var allowedListeners=['onUserLogin','onUserSignUp','onAddProduct','onRemoveProduct','onProductClick','onAddWishList','onAddShoppingList','setPaymentSystem','setShippingSection','deleteRow','beforeSubmitEndOrder','initializePaymentsBefore','initializePaymentsCallback','beforeExpressCheckoutRedirect'];if(allowedListeners.indexOf(listener)<0)return false;if(!LC.pluginEvents[listener]||LC.pluginEvents.length==0)return false;var args=Array.prototype.slice.call(arguments,1);LC.pluginEvents[listener].forEach(function(el,index){if($.isFunction(el))el.apply(this,args);});},};LC.Form=function(form){this.name=this.name||'form';this.initCaptchaToken=false;this.inputCaptchaToken=null;this.el={form:form,$form:$(form),};if(this.el.form){this.el.$message=this.el.$form.find('.form-message');if(!this.el.$message.length)
this.el.$message=$('<div />',{class:'form-message',}).prependTo(this.el.$form);if(this.submit)this.el.$form.on('submit',this.submit.bind(this));this.inputCaptchaToken=this.el.$form.find('[name="captchaToken"]');}
this.initialize.apply(this,[form]);};$.extend(true,LC.Form.prototype,LC.resources,{setCaptchaToken:function(event){var form=this;function setCaptchaTokenCallback(token){form.inputCaptchaToken.val(token);form.submit(event);}
if(!this.initCaptchaToken&&this.inputCaptchaToken.length){this.inputCaptchaToken.val('');setCaptchaToken(setCaptchaTokenCallback);this.initCaptchaToken=true;return true;}
this.initCaptchaToken=false;return false;},submit:function(event){if(this.el.form.method.toLowerCase()=='get')return;event.preventDefault();if(!this.el.$form.isValid())return false;if(this.setCaptchaToken(event))return;if(this.el.$form.data('lcFormdata')){this.postFormData(event);return;}
var arrDataForm=this.el.$form.serializeArray();this.dataForm={};for(var i=0;i<arrDataForm.length;i++){if(!(arrDataForm[i].name in this.dataForm))this.dataForm[arrDataForm[i].name]=[];this.dataForm[arrDataForm[i].name].push(arrDataForm[i].value);}
for(var i in this.dataForm)this.dataForm[i]=this.dataForm[i].join();this.el.$form.find('button[type="submit"], input[type="submit"]').attr('disabled',true);if(this.el.form.method.toLowerCase()=='post'){this.trigger('submitBeforeSend',event);$.post(this.el.form.action,{data:JSON.stringify(this.dataForm),},this.onReceive.bind(this),'json').fail(this.onFail.bind(this)).always(this.onComplete(this));}},onFail:function(error){this.el.$form.find('button[type=submit], input[type=submit]').attr('disabled',false);if(this.callback&&typeof this.callback==='function')this.callback(error.responseJSON);},onReceive:function(data){this.el.$form.find('button[type=submit], input[type=submit]').attr('disabled',false);if(this.callback&&typeof this.callback==='function')this.callback(data);},onComplete:function(data){},callback:function(data){var message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
this.el.$message.text(message);if(success){this.el.$message.removeClass('alert-danger').addClass('alert alert-success');}else{this.el.$message.removeClass('alert-success').addClass('alert alert-danger');}
this.trigger('callback',data);},showMessage:function(message,type,notifyMode){if(!type)type='danger';if(typeof notifyMode!=='boolean')notifyMode=LC.config.notifyMode;if(notifyMode)LC.notify(message,{type:type});else
this.el.$message.html(message).removeClass('alert-danger alert-success alert-info').addClass('alert alert-'+type);},postFormData:function(event){event.preventDefault();var arrDataForm=this.el.$form.serializeArray();var formData=new FormData(this.el.$form[0]);for(var i=0;i<arrDataForm.length;i++){formData.append(arrDataForm[i].name,arrDataForm[i].value);}
var isValidFormInput=true;this.el.$form.find('input:file').each(function(index,el){if(el.files.length>0){var suffixes=$(el).data('lcAccept');joinedSuffixes=suffixes.split(',').join('|');var re=new RegExp('.*.('+joinedSuffixes+')','i');if(!re.test(el.value)){isValidFormInput=false;this.showMessage(LC.global.languageSheet.validExtensions+' '+suffixes.split(',').join(', '));}
maxFileSize=$(el).data('lcMaxSize');if(el.files[0].size/(1024*1024)>maxFileSize){isValidFormInput=false;this.showMessage(LC.global.languageSheet.validSize+' '+maxFileSize+'Mb');}
formData.append(el.name,el.files[0],el.value);}}.bind(this));if(!isValidFormInput)return;var callback=this.onReceive.bind(this);$.ajax({url:this.el.form.action,data:formData,async:true,mimeType:'multipart/form-data',processData:false,contentType:false,type:'POST',success:function(data){callback($.parseJSON(data));},});},});LC.Form.extend=LC.extend;LC.Form.addEvent=function(name,event){if(typeof name!=='string'||typeof event!=='function')return false;this.prototype['custom_'+name]=event;return true;};LC.userFormResources={setCountryFormFields:function(state,fieldName){if(!fieldName)return;if(!state)state=0;this.getPrefix();if(this.countryUserFields){this.countryUserFields[fieldName].state=state;if(this.countryUserFields[fieldName].formFields){var countryUserFields=this.countryUserFields[fieldName].formFields;for(var i=0;i<countryUserFields.length;i++){var fieldContainer=F('#'+this.prefix+'Field'+countryUserFields[i]+'Container');if(fieldContainer)fieldContainer.style.display=state?'block':'none';}}}},setValidationData:function($formField,required){var i,dataValidation,arrElements,arrValidation;dataValidation=$formField.data('validation')||'';arrElements=['email','phone','vat','idcard'];arrValidation=required?['required']:[];for(i=0;i<arrElements.length;i++)
if(dataValidation.toLowerCase().indexOf(arrElements[i])>=0)arrValidation.push(arrElements[i]);return arrValidation.join(',');},selectPostalCodeCallback:function(type,callback){if(!$.isFunction(callback))return;if(type==='userInfo')localizeEvents.selectPostalCode=callback.bind(this);else if(type==='shippingAddress')localizeEvents.selectShippingPostalCode=callback.bind(this);else if(type==='addressBook')localizeEvents.selectAddressBookPostalCode=callback.bind(this);},};LC.addressBookForm={userType:null,initializeBook:function(){this.el.$modal=$('#'+this.prefix+'AddressBookModal');this.initModalOnShow();this.el.$form.find('.addressUserCountryField').each(function(index,el){changeCountryFields.bind(el)(LC.global.session.countryId,true);});this.changeUserTypeEvent();this.selectAddressEvents();this.deleteAddressEvents($('.'+this.prefix+'Address [data-lc-action="deleteAddressBook"]'));this.type=this.el.$form.find('[name="type"]').val();this.module=this.el.$form.find('[name="module"]').val();},initializeForm:function(){var data=$.parseJSON(this.el.$form.attr('data-lc'));this.prefix=this.el.$form.attr('data-lc-address');this.module=this.el.$form.find('[name="module"]').val();this.fillFormData(data);this.changeUserTypeEvent();this.selectAddressEvents();},initModalOnShow:function(){var self=this;self.el.$modal.on('show.bs.modal',function(event){self.el.$form.find('.validAddress').remove();self.el.$form.find('.addressUserCountryField').each((index,el)=>{changeCountryFields.bind($(el))(LC.global.session.countryId,true);});var $button=$(event.relatedTarget);if($button.data('lc-action')=='editAddressBook'){self.actionEditAddress($button);}else if($button.data('lc-action')=='addAddressBook'){self.actionAddAddress($button);}});},actionAddAddress:function($trigger){var data=$trigger.data('lc-data');this.el.$form[0].reset();this.el.$form.find('.formField').not('[type="radio"]').val('');this.el.$form.find('[name="mode"]').val('add');this.el.$form.find('[name="id"]').val('');this.el.$form.selectMode=data.selectMode;this.fillFormData(data);$(this.el.$form.find('.userFieldGroupCountry')).each(function(index,el){resetCountrySelector($(el));});},actionEditAddress:function($trigger){var data=$.parseJSON($trigger.attr('data-lc-data'));this.el.$form[0].reset();this.el.$form.find('.formField').not('[type="radio"]').val('');this.el.$form.find('[name="mode"]').val('update');this.el.$form.find('[name="id"]').val(data.id);$(this.el.$form.find('.userFieldGroupCountry')).each(function(index,el){resetCountrySelector($(el));});this.fillFormData(data);},changeUserTypeEvent:function(){var self=this;this.el.$form.find('.userTypeNavTabs [data-toggle="tab"], .userTypeNavTabs [data-bs-toggle="tab"]').on('shown.bs.tab',function(event){self.el.$form.attr('data-lc-user-type',$(event.target).data('lc-user-type'));self.el.$form.data('lc-user-type',$(event.target).data('lc-user-type'));var $tabPane=$($(event.target).attr('href'));self.userType=self.el.$form.data('lc-user-type');self.el.$userFieldElements=$tabPane.find('.formField');self.setUserType();});},setUserType:function(){if(this.module==undefined){this.el.$form.find('[name*="userType"]').val(this.userType);this.el.$form.find('.formField').not(this.el.$userFieldElements).prop('disabled',true);this.el.$form.find('.locationField').not('[name^="'+this.userType+'"]').filter('input[type="hidden"]').prop('disabled',true);this.el.$form.find('.locationField[name^="'+this.userType+'"]').filter('input[type="hidden"]').prop('disabled',false);this.el.$userFieldElements.prop('disabled',function(){return $(this).data('lc-disabled');});}},selectAddressEvents:function(){var self=this;$(document).on('click','.'+self.prefix+'Address .addressBookAction.addressSelect',function(){var data=$(this).data('lc-data');self.selectAddressBook(data.id,data.type,data.action);});},deleteAddressEvents:function($button){$button.box({uid:'deleteAddressBookConfirm',showFooter:false,source:`
                <div class="titleDeleteAddressConfirm">${LC.global.languageSheet.deleteAddressBookConfirmTitle}</div>
                <div class="textDeleteAddressConfirm">${LC.global.languageSheet.deleteAddressBookConfirmText}</div>
                <div class="deleteAddressButtons">
                    <button type="button" class="${BTN_SECONDARY_CLASS} deleteAddressButton deleteAddressButtonDismiss" data-dismiss="modal" data-bs-dismiss="modal">${LC.global.languageSheet.cancel}</button>
                    <button type="button" class="${BTN_DANGER_CLASS} deleteAddressButton deleteAddressButtonConfirm">${LC.global.languageSheet.delete}</button>
                </div>`,type:'html',showClose:true,size:'small',callback:'deleteAddressBookConfirmCallback',});},selectAddressBook:function(addressId,type,action){var actionPath=LC.global.routePaths.CHECKOUT_INTERNAL_SELECT_ADDRESS_BOOK;if(action==='set_default_address'){actionPath=LC.global.routePaths.USER_INTERNAL_SET_ADDRESS_BOOK;}
if(LC.global.session.login){$.ajax({type:'POST',url:actionPath,data:{data:JSON.stringify({id:addressId,type:type,action:action,})},success:(response)=>{if(response.data.response.success!==0){this.selectAddressBookCallback(response);}
if(this.trigger){this.trigger('selectAddressBookCallback',response);}},async:false,dataType:'json'});}},selectAddressBookCallback:function(response){var data=response.data.data;var $address=$('#addressBookContainer_'+data.id),$allGroupAddresses=$('.'+data.type.toLowerCase()+'Address'),$radio=$address.find('[name="'+data.type.toLowerCase()+'Address"]');$allGroupAddresses.removeClass('addressBookActive').find('.addressSelect, .deleteAddressAction').removeClass('addressBookHidden');$allGroupAddresses.find('.default').addClass('addressBookHidden');$radio.prop('checked',true);$address.addClass('addressBookActive').find('.addressSelect, .deleteAddressAction').addClass('addressBookHidden');$address.find('.default').removeClass('addressBookHidden')
var $thisDataButtons=$address.find('[data-lc-action][data-lc-data]');$thisDataButtons.data('lc-data',data);$allGroupAddresses.find('[data-lc-action][data-lc-data]').not($thisDataButtons).each(function(index,el){$(el).data('lc-data').defaultAddress=false;});},callback:function(response){this.trigger('oscCallbackBefore',response);this.trigger('callbackBefore',response);if(typeof response==='undefined')return;var message=LC.global.languageSheet.error,success=0;if(response.data){message=response.data.response.message;success=response.data.response.success?response.data.response.success:0;}
if(success){var type=this.el.$form.find('[name="type"]').val(),mode=this.el.$form.find('[name="mode"]').val();if(Object.hasOwn(response.data.data.data,'valid')&&response.data.data.data.valid===false){let validationData=response.data.data.data;if(validationData.validAddresses.length){let $addressInput=this.el.$form.find(`[name="${this.userType}_${type}_address"]`),validAddresses='';$addressInput.parent().addClass('has-error');validAddresses+='<div class="validAddress">';validAddresses+=`<div class="validAddress validAddressTitle">${LC.global.languageSheet.userAddressSelectValidAdress}</div>`;validationData.validAddresses.forEach(validAddress=>{validAddresses+='<div type="button" class="selectValidAddress" >'+validAddress.address+'</div>';});validAddresses+='</div>';$addressInput.after(validAddresses);this.el.$form.find('.selectValidAddress').on('click',(event)=>{$addressInput.val(event.target.innerText);this.el.$form.find('.validAddress').remove();this.el.$form.submit();});this.showMessage(LC.global.languageSheet.userAddressInvalid,'danger');}else{let validationMessage='';validationData.messages.forEach(message=>{validationMessage+=message.detail+'<br>';})
this.showMessage(validationMessage,'danger');}}else{this.el.$form.closest('.addressBookModal').modal('hide');this.showMessage(LC.global.languageSheet.lblGenericUserAddressBookSaveData,'success');if(mode==='update'){this.updateAddressHtmlData(response.data.data);}else if(mode==='add'){var $html=this.addNewAddressBlock(response.data.data,type),$container=$('#'+type+'AddressContainer .content'),$lastAddress=$container.find('.addressBook').last();$container.find('.notAvailableAddress').remove();if($lastAddress.length){$lastAddress.after($html);}else{$container.prepend($html);}
if(response.data.data.data.defaultAddress){this.selectAddressBookCallback(response.data);}
this.deleteAddressEvents($html.find('[data-lc-action="deleteAddressBook"]'));}}}else{this.showMessage(message,'danger');}
this.trigger('oscCallback',response);this.trigger('callback',response);},updateAddressHtmlData:function(data){var defaultAlias=LC.global.languageSheet.noAliasAddress;if(data.data.defaultAddress){defaultAlias=LC.global.languageSheet.mainAddress;}
if(data&&!isNaN(data.id)&&data.id>0){var $address=$('#addressBookContainer_'+data.id),html=this.getAddressHtml(data.data);$address.find('label').html(data.data.alias.length?data.data.alias:defaultAlias);$address.find('.addressDataBox').html(html);$address.find('.editAddressAction').attr("data-lc-data",JSON.stringify(data.data));$address.find('.deleteAddressAction').attr("data-lc-data",JSON.stringify(data.data));}},getAddressHtml:function(data){var html='',showCompany=data.company.length&&data.userType=='BUSINESS'||data.userType=='FREELANCE',addresNameLabel=showCompany?LC.global.languageSheet.company:LC.global.languageSheet.addressBookName,addressName=showCompany?data.company:data.firstName+(data.lastName.length?' '+data.lastName:'');html+=addressName.length?'<div class="field name" data-lc-label="'+addresNameLabel+'">'+addressName+'</div>':'';html+='<div class="field address">';html+=data.address.length?'<span class="address" data-lc-label="'+LC.global.languageSheet.address+'">'+data.address+'</span>':'';html+=data.addressAdditionalInformation.length?'<span class="addressAdditionalInformation" data-lc-label="'+LC.global.languageSheet.addressAditionalInformation+'">'+data.addressAdditionalInformation+'</span>':'';html+=data.number.length?'<span class="number" data-lc-label="'+LC.global.languageSheet.number+'">'+data.number+'</span>':'';html+=data.city.length?'<span class="city" data-lc-label="'+LC.global.languageSheet.city+'">'+data.city+'</span>':'';html+=data.postalCode.length?'<span class="postalCode" data-lc-label="'+LC.global.languageSheet.postalCode+'">'+data.postalCode+'</span>':'';html+=data.state.length?'<span class="state" data-lc-label="'+LC.global.languageSheet.state+'">'+data.state+'</span>':'';html+=data.location.geographicalZone.countryCode.length?'<span class="location" data-lc-label="'+LC.global.languageSheet.country+'">'+LC.global.countries[data.location.geographicalZone.countryCode].name+'</span>':'';html+='</div>';html+='<div class="field extraInfo">';if(data.company.length&&data.userType=='BUSINESS'){html+=data.vat.length?'<span class="vat" data-lc-label="'+LC.global.languageSheet.vat+'">'+data.vat+'</span>':'';}else{html+=data.nif.length?'<span class="nif" data-lc-label="'+LC.global.languageSheet.nif+'">'+data.nif+'</span>':'';}
html+=data.phone.length?'<span class="phone" data-lc-label="'+LC.global.languageSheet.phone+'">'+data.phone+'</span>':'';html+=data.mobile.length?'<span class="mobile" data-lc-label="'+LC.global.languageSheet.mobile+'">'+data.mobile+'</span>':'';html+=data.fax.length?'<span class="fax" data-lc-label="'+LC.global.languageSheet.fax+'">'+data.fax+'</span>':'';html+='</div>';return html;},addNewAddressBlock:function(data,type){const $container=$('<div/>',{id:`addressBookContainer_${data.data.id}`,class:`addressBook ${type}Address${data.data.defaultAddress ? ' addressBookActive' : ''}`});const $wrap=$('<div/>',{class:'wrap'});let $default='',$defaultClass='default addressBookHidden',action='',selectedLabel='';if($('body').data('lc-page')=='userAddressBook'){action='set_default_address';selectedLabel=LC.global.languageSheet.defaultAddress;}else{action='select';selectedLabel=LC.global.languageSheet.selectedAddress;}
if(data.data.defaultAddress){$defaultClass='default';}
$default=$('<div/>',{class:$defaultClass,html:selectedLabel});const $label=$('<label/>',{name:`${type}Address_${data.data.id}`,for:`${type}Address_${data.data.id}`,class:'field',html:data.data.alias.length?data.data.alias:LC.global.languageSheet.mainAddress,});const $actionButtons=$('<div/>',{class:'actionButtons',});let $edit='',$delete='';let bs5=LC.global.settings.coreMode==='bootstrap5'?'-bs':'';$edit=$('<a/>',{href:'#',title:LC.global.languageSheet.editAddress,class:'addressBookAction editAddressAction',html:'<svg class="icon"><use xlink:href="#icon-pencil"></use></svg>','data-lc-data':JSON.stringify(data.data),'data-lc-action':'editAddressBook',[`data${bs5}-toggle`]:'modal',[`data${bs5}-target`]:`#${type}AddressBookModal`});$delete=$('<a/>',{href:'#',title:LC.global.languageSheet.deleteAddress,class:`addressBookAction deleteAddressAction${data.data.defaultAddress ? ' addressBookHidden' : ''}`,html:'<svg class="icon"><use xlink:href="#icon-trash"></use></svg>','data-lc-data':JSON.stringify(data.data),'data-lc-action':'deleteAddressBook'});const $dataBox=$('<div/>',{class:`addressDataBox ${type}AddressDataBox`,html:this.getAddressHtml(data.data)});let $selectButton='',$selectRadio='';if(this.el.$form.selectMode=='selectModeRadio'){$selectRadio=$('<div/>',{class:'form-check form-check-inline'});$selectRadio.append($('<input/>',{id:`${type}Address_${data.data.id}`,class:`form-check-input ${type}Address addressBookAction addressSelect${data.data.defaultAddress ? ' addressBookHidden' : ''}`,type:'radio',html:LC.global.languageSheet.selectAddressBook,name:`${type}Address`,'data-lc-data':JSON.stringify({id:data.data.id,type:type,mode:'update',action:action})}));}else{let btnClass=BTN_LINK_CLASS;$selectButton=$('<button/>',{class:`${type}Address addressBookAction addressSelect ${btnClass}${data.data.defaultAddress ? ' addressBookHidden' : ''}`,type:'button',html:LC.global.languageSheet.selectAddressBook,'data-lc-data':JSON.stringify({id:data.data.id,type:type,mode:'update',action:action})});}
$container.append($wrap.append([$default,$selectRadio,$label,$actionButtons.append([$edit,$delete]),$dataBox,$selectButton]));return $container;},fillFormData:function(data){if(this.module!=undefined){data.userType=this.module;}
this.el.$form.attr('lc-user-type',data.userType).data('lc-user-type',data.userType);var self=this;$.each(data,function(key,value){if(key==='location'){let fieldName=data.userType+'_'+self.el.$form.data('lc-address'),selector='[name="'+fieldName+'_country"]',$select=self.el.$form.find(selector);if(value!=null){$select.val(value.geographicalZone.countryCode);if(value.geographicalZone.locationId>0){selectLocationResult($select,value.geographicalZone.countryCode,value.geographicalZone.locationId,fieldName,false,data.city,data.postalCode);}}}else if(key=='re'){let selector='[id="'+data.userType+'_'+self.el.$form.data('lc-address')+'_'+key+'{{value}}'+'"]';if(value){self.el.$form.find(selector.replace("{{value}}",'1')).attr('checked',true);self.el.$form.find(selector.replace("{{value}}",'0')).attr('checked',false);}else{self.el.$form.find(selector.replace("{{value}}",'1')).attr('checked',false);self.el.$form.find(selector.replace("{{value}}",'0')).attr('checked',true);}}
else{let selector='[name="'+data.userType+'_'+self.el.$form.data('lc-address')+'_'+key+'"]';self.el.$form.find(selector).val(value);}});this.userType=this.el.$form.data('lc-user-type');var tabPane='#'+this.el.$form.data('lc-address')+'_tabPane_'+this.userType;this.el.$userTabPanes=this.el.$form.find('.tabPaneUserType');this.el.$userFieldElements=this.el.$form.find(tabPane+' .formField');this.el.$form.find('.formField').each(function(){if(typeof $(this).data('lc-disabled')==='undefined')
$(this).data('lc-disabled',$(this).prop('disabled'));});this.el.$form.find('.userTypeNavTabs [data-lc-user-type="'+data.userType+'"]').tab('show');this.setUserType();this.trigger('afterFillFormData',this.el.$form);},submit:function(event){if(this.el.$form.find('.address-complete:visible').length!=this.el.$form.find('.userFieldGroupCountry:visible').length){var $result=this.el.$form.find('.userFieldGroupCountry:visible').not('.address-complete:visible');$result.addClass('address-incomplete');$([document.documentElement,document.body]).animate({scrollTop:$result.offset().top-200},1000);return false;}else{this.el.$form.find('.userFieldGroupCountry:visible').removeClass('address-incomplete');}
this.superForm('submit',event);}};LC.MiniBasketClass=function(){this.el={};this.events={before:null,callback:null,};this.initialize.apply(this);};$.extend(true,LC.MiniBasketClass.prototype,{firstReload:true,initialize:function(){this.el.$container=$('#miniBasket');this.el.$miniBasketContent=$('#miniBasketContent');this.data=this.el.$miniBasketContent.data('lc-mini-basket');this.reload();this.el.$container.on('click','[data-lc-mini-basket-delete]',function(event){event.preventDefault();event.stopPropagation();let data={};data.id=$(event.currentTarget).parent().attr('id');data.hash=$(event.currentTarget).data('lc-mini-basket-delete');LC.resources.pluginListener('onRemoveProduct',event,data);this.deleteItem($(event.currentTarget).data('lc-mini-basket-delete'));}.bind(this));this.el.$container.on('click','[data-lc-mini-basket-delete-grid], [data-lc-basketdeleterows]',function(event){event.preventDefault();event.stopPropagation();let data={},hashes=$(event.currentTarget).data('lc-mini-basket-delete-grid');if(!hashes){hashes=$(event.currentTarget).data('lc-basketdeleterows');}
data.id=$(event.currentTarget).parent().attr('id');hashes.forEach(hash=>{data.hash=hash;LC.resources.pluginListener('onRemoveProduct',event,data);});this.deleteGrid(hashes);}.bind(this));this.initializeQuantityElements();},initializeQuantityElements:function(){try{this.el.$container.find('input[data-lc-quantity]').quantity();}catch(err){}
this.el.quantityElements=this.el.$container.find('input.basketQuantity:text');if(!this.el.quantityElements.length)
this.el.quantityElements=this.el.$container.find('select.basketQuantity');this.el.quantityElements.on('click',function(ev){ev.stopPropagation();});this.el.quantityElements.on('change',this.onChangeQuantity.bind(this));},exists:function(){return typeof this.data==='object';},addEvent:function(name,fn){if((name=='before'||name=='callback')&&fn&&typeof fn==='function')this.events[name]=fn;},onChangeQuantity:function(eventData){this.before();var qtText='quantity';var productHash=eventData.currentTarget.name.substring(qtText.length);if(productHash.startsWith('Grid')){let name=$(eventData.target).attr('name').replace('quantity',''),sendData={};if(name.length==0){name='grid'+$(eventData.target).data('lc-grid-combination-id');}
sendData[name]={mode:'UPDATE',type:$(eventData.target).data('lc-row-type'),quantity:$(eventData.target).val(),options:$(eventData.target).data('lc-row-options'),id:$(eventData.target).closest('[data-lc-grid-product-id]').data('lc-grid-product-id'),};$.post(LC.global.routePaths.CHECKOUT_INTERNAL_RECALCULATE_BASKET,{data:JSON.stringify({data:sendData})},function(response){if(response.data.response.success!=1){LC.notify(response.data.response.message,{type:'danger'});}
this.reload();}.bind(this),'json');return;}
var prodCombinationInput=$('form.buyForm input[data-lc-product-hash="'+productHash+'"]').get(0);if(prodCombinationInput){var itemForm=prodCombinationInput.closest('form');itemForm.module.updateCombinationsFields([productHash],eventData.currentTarget.value);itemForm.module.updateCombinationsFormType();}
if(!this.el.container)this.el.container=$('#miniBasket');this.el.container.load(LC.global.routePaths.BASKET_INTERNAL_MINI_BASKET+'?hash='+productHash+'&quantity='+eventData.currentTarget.value+'&type='+$(eventData.currentTarget).data('lc-row-type')+' #miniBasketContent',function(){this.oneStepCheckoutRefresh();this.loadComplete();}.bind(this));},reload:function(callback){if(this.firstReload){this.action='load';this.firstReload=false;}else{this.action='reload';}
this.before();var page=$('body').data('lc-page');if($('form.basketForm').length&&(page==='checkoutBasket'||page==='checkoutPaymentAndShipping')&&this.action=='reload'){$('html, body').animate({scrollTop:0},'slow',function(){window.location.reload(true);});}
var ncParam='nc='+Math.floor(100+Math.random()*899);if(!this.el.$container)this.el.$container=$('#miniBasket');this.el.$container.load(LC.global.routePaths.BASKET_INTERNAL_MINI_BASKET+'?'+ncParam+' #miniBasketContent',function(){this.loadComplete(callback);}.bind(this));},deleteItem:function(hash){this.action='delete';this.before();this.deleteRow=hash;if(!this.el.container)this.el.container=$('#miniBasket');this.el.container.load(LC.global.routePaths.BASKET_INTERNAL_MINI_BASKET+'?hash='+this.deleteRow+' #miniBasketContent',function(){this.oneStepCheckoutRefresh();this.loadComplete();}.bind(this));},deleteGrid:function(hashes){this.action='delete';this.before();if(!this.el.container)this.el.container=$('#miniBasket');this.el.container.load(LC.global.routePaths.BASKET_INTERNAL_MINI_BASKET+'?hashes='+hashes+' #miniBasketContent',function(){this.oneStepCheckoutRefresh();this.loadComplete();}.bind(this));},before:function(){if(!this.el.container)this.el.container=$('#miniBasket');this.el.$container.addClass('miniBasketLoading');if(this.events.before&&typeof this.events.before==='function')this.events.before.bind(this)();},loadComplete:function(callback){if(this.el.$container&&this.el.$container.hasClass('miniBasketLoading'))
this.el.$container.removeClass('miniBasketLoading');this.el.$miniBasketContent=this.el.$container.find('#miniBasketContent');this.data=this.el.$miniBasketContent.data('lc-mini-basket');var saveBasketForm=this.el.$miniBasketContent.find('form');if(saveBasketForm&&saveBasketForm.data('lcForm')=='saveBasketForm')
new LC.saveBasketForm(saveBasketForm[0]);if(this.events.callback&&typeof this.events.callback==='function')this.events.callback.bind(this)(this.data,this.action);LC.initializeCountdowns();LC.basketExpiration.checkNewExpirationDate();$('[data-lc-event]').dataEvent();if(this.deleteRow&&this.deleteRow.length){var hashes=this.deleteRow.split('-');this.deleteRow='';var prodCombinationInput=$('form.buyForm input[data-lc-row-hash="'+hashes[0]+'"]').get(0);if(prodCombinationInput){var itemForm=prodCombinationInput.closest('form');itemForm.module.updateCombinationsFields(hashes,0);itemForm.module.updateCombinationsFormType();}}
this.initializeQuantityElements();if(callback&&typeof callback==='function'){callback();}},onReceive:function(data){if(!this.el.container)this.el.container=$('#miniBasket');this.el.container.replaceWith(data);this.el.container=$('#miniBasket');if(this.events.callback&&typeof this.events.callback==='function')this.events.callback(data);},oneStepCheckoutRefresh:function(){if(this.oneStepCheckoutCallback&&typeof this.oneStepCheckoutCallback==='function'){this.oneStepCheckoutCallback(this);}},});LC.miniBasket=new LC.MiniBasketClass();LC.ProductComparisonDetailClass=function(){this.el={};this.events={before:null,callback:null,};this.initialize.apply(this);};$.extend(true,LC.ProductComparisonDetailClass.prototype,{initialize:function(){this.el.$container=$('#productComparisonDetailContent');this.action='load';this.reload();this.el.$container.on('click','[data-lc-function="deleteProductComparison"]',function(event){event.preventDefault();this.deleteItem($(event.currentTarget).data('lc-data'));}.bind(this));},addEvent:function(name,fn){var boolCheckEventName=name=='before'||name=='callback'||name=='beforeReloadBadge'||name=='callbackReloadBadge';if(boolCheckEventName&&fn&&typeof fn==='function')this.events[name]=fn;},reload:function(response){this.before();if(!this.el.$container)this.el.$container=$('#productComparisonDetailContent');var ncParam='nc='+Math.floor(100+Math.random()*899);this.el.$container.load(LC.global.routePaths.PRODUCT_COMPARISON_INTERNAL_PRODUCT_COMPARISON_PREVIEW+'?'+ncParam,function(){this.loadComplete();}.bind(this));},deleteItem:function(productId){this.before();if(!this.el.$container)this.el.$container=$('#productComparisonDetail');this.action='delete';$.post(LC.global.routePaths.PRODUCT_COMPARISON_INTERNAL_DELETE_COMPARISON_PRODUCT,{data:JSON.stringify({id:productId})},this.loadComplete.bind(this),'json').done(()=>{this.el.$container.find('.productComparisonPreviewItem'+productId).remove();if(this.el.$container.find('.preview-item').length==0){this.el.$container.find('.product-comparison-second-title, .items-wrapper, .product-comparison-link').remove();this.el.$container.append(`<div class="empty-text">${LC.global.languageSheet.noProductsInComparison}</div>`);}
this.deleteTableItem(productId);this.updateProductComparisonButtons(productId);this.updateBadge();});},deleteTableItem:function(productId){var $table=$('#comparison-table');$table.find(`[data-lc-product-comparison-item="${productId}"]`)?.fadeOut('slow',function(){this.remove();if($table.find('[data-lc-product-comparison-item]').length===0){$table.before(`<div class="empty-text">${LC.global.languageSheet.noProductsInComparison}</div>`);$table.remove();}});},before:function(){if(!this.el.$container)this.el.$container=$('#productComparisonDetailContent');if(this.events.before&&typeof this.events.before==='function')this.events.before.bind(this)();},loadComplete:function(callback){if(this.events.callback&&typeof this.events.callback==='function')this.events.callback.bind(this)(data,this.action);this.el.$container=$('#productComparisonDetailContent');this.updateBadge();},updateBadge:function(){let nComparisonProducts=document.querySelectorAll('#productComparisonDetailContent .preview-item').length;$('.product-comparison-number-badge').removeClass((i,className)=>(className.match(/n\-[0-9]*/g)||[]).join(' ')).addClass('n-'+nComparisonProducts).html(nComparisonProducts);},updateProductComparisonButtons:function(productId){var $comparablePageButtons=$('[data-product-comparison]').filter((i,item)=>{return JSON.parse(item.dataset.productComparison).id==productId;});if($comparablePageButtons.length!==0){$comparablePageButtons.each((index,item)=>{var nodeData=$(item).data('product-comparison');nodeData.type='add';$(item).removeClass('productComparisonButtonDelete').addClass('productComparisonButtonAdd');if(nodeData.showLabel){$(item).html(nodeData.labelDelete);}});}},});LC.productComparisonDetail=new LC.ProductComparisonDetailClass();LC.initializeCountdowns=function(){if(!('localServerOffsetTime'in LC.global.settings))
LC.global.settings.localServerOffsetTime=moment().unix()-moment(LC.global.settings.serverTime).unix();$('[data-lc-countdown]').each(function(index,element){new LC.productCountdown(element.id);});$(document.body).removeClass('basket-check-availability');$('[data-lock-countdown]').each(function(index,element){if(!element.basketLockCountdown)element.basketLockCountdown=new LC.basketLockCountdown(element);});$('[data-lc-basket-expires]').each(function(index,element){if(!element.basketCountdown)element.basketCountdown=new LC.basketCountdown(element);});};LC.initializeRangeSliders=function(){if(typeof $.fn.ionRangeSlider==='function'){$('[data-lc-range-slider]').ionRangeSlider({prettify:function(number){return outputHtmlCurrency(number);},onFinish:function(data){if($(data.input).closest('form').data('lc-autosubmit')){$(data.input).closest('form').submit();}}});}};LC.buyFormResources={filePlugin:[],filePluginIsOnError:new Map(),initializeFilePlugin:function(){this.el.$form.find('[data-lc-file-plugin]').each((index,element)=>{document.addEventListener('dragover',(e)=>e.preventDefault());document.addEventListener('drop',(e)=>e.preventDefault());let data=$(element).data('lc-file-plugin');this.filePlugin[data.optionId]=FilePond.create(element,{id:data.id,name:data.id,required:data.required,allowMultiple:data.maxValues>1?true:false,disable:data.disable,dropOnPage:false,allowPaste:false,server:null,credits:false,labelIdle:LC.global.languageSheet.jsInputFileIdle,labelInvalidField:LC.global.languageSheet.jsInputFileInvalidField,labelFileWaitingForSize:LC.global.languageSheet.jsInputFileFileWaitingForSize,labelFileSizeNotAvailable:LC.global.languageSheet.jsInputFileFileSizeNotAvailable,labelFileLoading:LC.global.languageSheet.jsInputFileFileLoading,labelFileLoadError:LC.global.languageSheet.jsInputFileFileLoadError,labelFileProcessing:LC.global.languageSheet.jsInputFileFileProcessing,labelFileProcessingComplete:LC.global.languageSheet.jsInputFileFileProcessingComplete,labelFileProcessingAborted:LC.global.languageSheet.jsInputFileFileProcessingAborted,labelFileProcessingError:LC.global.languageSheet.jsInputFileFileProcessingError,labelFileProcessingRevertError:LC.global.languageSheet.jsInputFileFileProcessingRevertError,labelFileRemoveError:LC.global.languageSheet.jsInputFileFileRemoveError,labelTapToCancel:LC.global.languageSheet.jsInputFileTapToCancel,labelTapToRetry:LC.global.languageSheet.jsInputFileTapToRetry,labelTapToUndo:LC.global.languageSheet.jsInputFileTapToUndo,labelButtonRemoveItem:LC.global.languageSheet.jsInputFileButtonRemoveItem,labelButtonAbortItemLoad:LC.global.languageSheet.jsInputFileButtonAbortItemLoad,labelButtonRetryItemLoad:LC.global.languageSheet.jsInputFileButtonRetryItemLoad,labelButtonAbortItemProcessing:LC.global.languageSheet.jsInputFileButtonAbortItemProcessing,labelButtonUndoItemProcessing:LC.global.languageSheet.jsInputFileButtonUndoItemProcessing,labelButtonRetryItemProcessing:LC.global.languageSheet.jsInputFileButtonRetryItemProcessing,labelButtonProcessItem:LC.global.languageSheet.jsInputFileButtonProcessItem,oninit:()=>{$($.find(`#${data.id} input[type="file"]`)[0]).addClass(data.attachedClassName);if(data.accept.length){$($.find(`#${data.id} input[type="file"]`)[0]).attr('accept',data.accept);}},onaddfile:(error,file)=>{let $inputFile=$($.find(`#${data.id} input[type="file"]`)[0]);this.filePlugin[data.optionId].changeInputFile=true;},onremovefile:(error,file)=>{let $inputFile=$($.find(`#${data.id} input[type="file"]`)[0]);this.filePlugin[data.optionId].changeInputFile=true;},onupdatefiles:(fileItems)=>{let $inputFile=$($.find(`#${data.id} input[type="file"]`)[0]);if(this.filePlugin[data.optionId].changeInputFile){let files=[];fileItems.forEach(item=>{files.push(item.file);});$inputFile.files=files;$inputFile.optionId=data.optionId;$inputFile.optionName=data.optionName;this.parseFile($inputFile);this.filePlugin[data.optionId].changeInputFile=false;}}});});},updateButton:function(combinationData,button,itemType){const status=combinationData.status;var properties={};if(itemType=='notAvailable'){properties.className='notAvailable';properties.disabled=true;}else{if(status=="AVAILABLE"||status=="RESERVE"){properties.disabled=false;if(status=="AVAILABLE"){properties.className='buy';if(this.filledForm){properties.name=LC.global.languageSheet.update;properties.className+=' update';}else{properties.name=LC.global.languageSheet.buy;}}else{properties.className='reserve';properties.name=LC.global.languageSheet.reserve;}}else{properties.disabled=true;if(status=="SELECT_OPTION"){properties.className='selectOption';properties.disabled=true;var selectOptionText='';if(itemType=='product'){selectOptionText=this.getSelectOptionText(combinationData,this.data);}else{selectOptionText=this.getBundleSelectOptionText(combinationData,this.dataProducts);}
properties.name=LC.global.languageSheet.selectOption.replace('{{option}}',selectOptionText);}else{properties.className='notAvailable';properties.name=LC.global.languageSheet.notAvailable;}}}
button.removeClass('selectOption notAvailable reserve buy');button.addClass(properties.className);button.prop('disabled',properties.disabled);button.data('buyFormSubmitName',properties.name);button.each((index,el)=>{if(!$(el).data('lc-express-checkout-plugin')){if($(el).data('show-label')==true)$(el).html(properties.name);else $(el).html('');}});if(this.gridData){if(!this.gridData.totalQuantity||this.gridData.totalQuantity<=0){button.addClass('notAvailable');button.prop('disabled',true);}
let gridCombinationsInfo=this.el.$form.find('.grid-combinations-info');gridCombinationsInfo.removeClass('selectOption notAvailable reserve buy');gridCombinationsInfo.addClass(properties.className);gridCombinationsInfo.html(`<span>${properties.name}</span>`);}},attachmentFields:function($elements){$elements.each((index,element)=>{let $element=$(element);$element.find('.new-attachment').click(function(event){$element.find('input.productOptionAttachmentHiddenValue').val('');$element.find('.productOptionAttachmentValue').show();$element.find('input.productOptionAttachmentValue').removeAttr('disabled');$element.find('.productOptionAttachmentButtons').hide();}.bind(this));});},parseFile:function(field){var files=field.files,fileNameRegex=new RegExp('^[À-ÿ\\w\\-. ]+$'),options=$(field).closest('.lcProductOptionAttachment').data('options'),optionId='',filePlugin=null;if(field.optionId){optionId=field.optionId;filePlugin=this.filePlugin[field.optionId];}else{optionId=$(field).attr('id').replace('optionValueInputFile','');}
this.filePluginIsOnError.set(field.optionId,'');$(field).closest('.productOption').find('input.productOptionAttachmentHiddenValue').val('').change();if(files.length>0){const totalSize=Array.from(files).reduce((sum,file)=>sum+file.size,0);if(totalSize>(options.maxSize*1024*1000)){LC.notify(LC.global.languageSheet.attachFileMaxSize.replace('{{maxSize}}',options.maxSize),{type:'danger'});$(field).val('');if(filePlugin)filePlugin.removeFiles();}else if((files.length<options.minValues||files.length>options.maxValues)&&!filePlugin){LC.notify(LC.global.languageSheet.attachFileQuantityError.replace('{{minValues}}',options.minValues).replace('{{maxValues}}',options.maxValues),{type:'danger'});$(field).val('');}else{if((files.length<options.minValues||files.length>options.maxValues)&&filePlugin){LC.notify(LC.global.languageSheet.attachFileQuantityError.replace('{{minValues}}',options.minValues).replace('{{maxValues}}',options.maxValues),{type:'danger'});const files=filePlugin.getFiles();if(files.length>options.maxValues){if(files.length>options.maxValues){const excessFiles=files.slice(0,files.length-options.maxValues);excessFiles.forEach(file=>{filePlugin.removeFile(file.id);});}}else if(files.length<options.minValues){this.filePluginIsOnError.set(field.optionId,field.optionName+': '+LC.global.languageSheet.attachFileQuantityError.replace('{{minValues}}',options.minValues).replace('{{maxValues}}',options.maxValues));}}
for(var i=0;i<files.length;i++){if(!fileNameRegex.test(files[i].name)){LC.notify(LC.global.languageSheet.attachFileRegexError,{type:'danger'});$(field).val('');if(filePlugin)filePlugin.removeFiles();}}
for(var i=0;i<files.length;i++){(function(file,i){var name=file.name,reader=new FileReader();reader.onload=function(){var optionValue={extension:name.split('.').pop(),fileName:name,value:reader.result};$(field).closest('.productOption').find('#optionValue'+optionId+'_'+(i+1)).val(JSON.stringify(optionValue)).change();};reader.onerror=function(error){$(field).val('');$(field).closest('.productOption').find('input.productOptionAttachmentHiddenValue').val('').change();LC.notify(LC.global.languageSheet.attachFileError,{type:'danger'});};reader.readAsDataURL(file);})(files[i],i);}}}},initDatetimepickers:function(){this.el.$form.find('[data-datetimepicker]').each((index,el)=>{let $calendar=$(el),language=$calendar.data('language')?$calendar.data('language'):'en',format=$calendar.data('format'),startDate=$calendar.data('startdate'),endDate=$calendar.data('enddate'),weekstart=$calendar.data('weekstart');moment.locale(language,{week:{dow:weekstart}});$calendar.datetimepicker({locale:language,format:format?format:CALENDAR_PLUGIN_DATE_FORMAT,minDate:startDate?startDate:false,maxDate:endDate?endDate:false});$(el).on('dp.change',(e)=>{let $optionsubmitValue=this.el.$form.find('[name="'+$calendar.data('submit')+'"]');if(e.date){$optionsubmitValue.val(moment(e.date).format('YYYY-MM-DD'));}else{$optionsubmitValue.val('');}});});},getSelectOptionText:function(item,product){var selectOptionText='';item.options.forEach(option=>{if(option.missed){product.options.forEach(productOption=>{if(productOption.id==option.id){if(selectOptionText.length){selectOptionText+=', ';}
selectOptionText+=productOption.language.name;};});}});return selectOptionText;},initOptions:function(){this.trigger('initOptionsBefore');this.el.$productOptionAttachment=this.el.$form.find('.lcProductOptionAttachment');if(this.el.$productOptionAttachment.length)
this.attachmentFields(this.el.$productOptionAttachment);this.el.$options=this.el.$form.find('select.productOptionSelectValue, input.productOptionRadioValue, input.productOptionCheckboxValue, input.productOptionBooleanValue, input.productOptionTextValue, textarea.productOptionLongTextValue, input.productOptionDateValue, input.productOptionAttachmentValue, input.productOptionAttachmentHiddenValue');this.el.$options.change(this.onChangeOption.bind(this));this.initDatetimepickers();const $productsOptions=$(this.el.$form.find('div.productOptions'));$productsOptions.each((i,productOptions)=>{if(!this.useUrlOptionsParams){this.useUrlOptionsParams=JSON.parse($(productOptions).attr('data-lc-data')).useUrlOptionsParams;}
if(!this.combinationDataOptionChanged){this.combinationDataOptionChanged=JSON.parse($(productOptions).attr('data-lc-data')).combinationDataOptionChanged;}});this.el.$form.find('input.productOptionRadioValue:checked').parent('div.productOptionRadioValue').addClass('productOptionSelected');this.el.$form.find('input.productOptionCheckboxValue:checked').parent('div.productOptionCheckboxValue').addClass('productOptionSelected');this.onChange(this.useUrlOptionsParams||this.combinationDataOptionChanged);this.trigger('initOptionsCallback');this.optionsInitialized=true;},onChangeOption:function(eventData){this.trigger('onChangeOptionBefore');let getCombinationData=true;if($(eventData.target).hasClass('productOptionRadioValue')){$(eventData.target).parents('div.productOptionValues').find('div.productOptionRadioValue').removeClass('productOptionSelected');$(eventData.target).parent('div.productOptionRadioValue').addClass('productOptionSelected');}
if($(eventData.target).hasClass('productOptionCheckboxValue')){if(eventData.target.checked)
$(eventData.target).parent('div.productOptionCheckboxValue').addClass('productOptionSelected');else
$(eventData.target).parent('div.productOptionCheckboxValue').removeClass('productOptionSelected');}
var useOnChange=true;if($(eventData.target).hasClass('productOptionAttachmentValue')){this.parseFile(eventData.target);useOnChange=false;}
if($(eventData.target).hasClass('productOptionBooleanValue')||$(eventData.target).hasClass('productOptionDateValue')||$(eventData.target).hasClass('productOptionAttachmentValue')||$(eventData.target).hasClass('productOptionAttachmentHiddenValue')||$(eventData.target).hasClass('productOptionTextValue')||this.gridData)getCombinationData=false;this.trigger('onChangeOptionCallback',eventData.target);if(useOnChange){this.onChange(getCombinationData);}},checkOptionsAvailability:function(combinationDataItem,$productOptionsDiv,productOptionsData){const bundleDefinitionSectionItemId=productOptionsData.bundleDefinitionSectionItemId;combinationDataItem.options.forEach(combinationDataItemOption=>{const optionName="optionValue"+(bundleDefinitionSectionItemId>0?'_'+bundleDefinitionSectionItemId+'_':'')+combinationDataItemOption.id,itemsOption=$productOptionsDiv.find(`[name="${optionName}"]`);combinationDataItemOption.values.forEach(combinationDataItemOptionValue=>{itemsOption.each((i,itemOption)=>{if(itemOption.tagName.toLowerCase()=='select'){$(itemOption).find('option').each((j,itemOptionValue)=>{if($(itemOptionValue).val()==combinationDataItemOptionValue.id){$(itemOptionValue).attr('data-lc-availability',combinationDataItemOptionValue.available?'true':'false');}
return;});}else{if($(itemOption).val()==combinationDataItemOptionValue.id){if(combinationDataItemOptionValue.available){$(itemOption).addClass('available');$(itemOption).parent().addClass('available');$(itemOption).removeClass('notAvailable');$(itemOption).parent().removeClass('notAvailable');}else{$(itemOption).removeClass('available');$(itemOption).parent().removeClass('available');$(itemOption).addClass('notAvailable');$(itemOption).parent().addClass('notAvailable');if($(itemOption).prop("checked")){$('.checkbox').prop('checked',false);}}
$(itemOption).attr('data-lc-availability',combinationDataItemOptionValue.available?'true':'false');}}});});});},addOptionsToProductLink:function(productOptionsData,$itemContainer){var options=$itemContainer.find('select.productOptionSelectValue, input.productOptionRadioValue, input.productOptionCheckboxValue, input.productOptionBooleanValue').serializeArray(),optionsParams={},pathParams='',bundleDefinitionSectionItemId=productOptionsData.bundleDefinitionSectionItemId,prefixOptionName="optionValue";if(bundleDefinitionSectionItemId>0){prefixOptionName=prefixOptionName+'_'+bundleDefinitionSectionItemId+'_';}
for(var i=0;i<options.length;i++){if(!(options[i].name in optionsParams)){optionsParams[options[i].name]=[];}
optionsParams[options[i].name].push(options[i].value);}
if(Object.keys(optionsParams).length>0){pathParams='?';}
for(var element in optionsParams){if(optionsParams.hasOwnProperty(element)){if(optionsParams[element].length==1){if(pathParams!='?')pathParams=pathParams+'&';pathParams=pathParams+encodeURI(element.replace(prefixOptionName,'optionId_'))+"="+encodeURI(optionsParams[element][0]);}else{for(var i=0;i<optionsParams[element].length;i++){if(pathParams!='?')pathParams=pathParams+'&';pathParams=pathParams+encodeURI(element.replace(prefixOptionName,'optionId_'))+'_'+i+"="+encodeURI(optionsParams[element][i]);}}}}
this.el.$form.find(`a[href^="${this.data.language.urlSeo}"]`).each((i,element)=>{$(element).prop('href',$(element).attr('href').split('?')[0]+pathParams);});},onChangeQuantity:function(eventData){const quantityValue=$(this.el.$quantityField).val();this.trigger('onChangeQuantityBefore');let totalQuantity=0;if(this.gridData){const combinationId=$(eventData.target).closest('[data-lc-grid-combination]').data('lc-grid-combination').combinationId,quantityGrid=parseInt($(eventData.target).closest('select,input').val());this.gridData.combinations.values[combinationId].quantity=quantityGrid;$(eventData.target).attr('value',quantityGrid);totalQuantity=0;$.each(this.gridData.combinations.values,(i,el)=>{totalQuantity+=el.quantity;});this.setGridTotalQuantity(totalQuantity);}
this.trigger('onChangeQuantityCallback',{quantity:this.gridData?this.gridData.totalQuantity:parseInt(quantityValue)});this.onChange(false);},setGridTotalQuantity:function(totalQuantity){this.gridData.totalQuantity=totalQuantity;this.el.$form.find('.product-grid-total-units').html(this.gridData.totalQuantity);},clickStockSubscriptionButton:function(eventData){$('#stockAlert').find('#combinationId').attr('value',$(eventData.currentTarget).attr("combinationid"));},wishlist:function(wishlist,dataType){const $this=wishlist;const data=$this.data('wishlist-'+dataType);if(data.type==='accountRequired'){$this.box({uid:'wishlistAccountRequiredModal',showFooter:false,source:`<div class="question wishlistQuestion lcWishlist">
                        <div class="questionText wishlistQuestionText">${LC.global.languageSheet.wishlistAccountRequired}</div>
                        <div class="questionButtons">
                            <button type="button" class="${BTN_SECONDARY_CLASS} pull-left questionButton questionButtonLeft wishlistQuestionButton" id="wishlistQuestionButton1" data-dismiss="modal" data-bs-dismiss="modal">${LC.global.languageSheet.no}</button>
                            <button type="button" class="${BTN_PRIMARY_CLASS} pull-right questionButton questionButtonRight wishlistQuestionButton" id="wishlistQuestionButton2" onclick="location.href='${LC.global.routePaths.USER}';">${LC.global.languageSheet.yes}</button>
                        </div>
                    </div>`,type:'html',showClose:false,size:'small',callback:'wishlistAccountRequired',});}else{$this.on('click',function(event){if(data.type==='add'){LC.resources.pluginListener('onAddWishList',event,this.data);event.preventDefault();$this.attr('disabled','disabled');if(window.BlueknowTracker)BlueknowTracker.trackExamined(data.itemId);this.trigger('wishlistBefore');$.post(LC.global.routePaths.USER_INTERNAL_ADD_WISHLIST_PRODUCT,{data:JSON.stringify({id:this.data.id})},this.wishlistCallback.bind(this,data,$this),'json');}else{event.preventDefault();$this.attr('disabled','disabled');this.trigger('deleteWishlistItemBefore');$.post(LC.global.routePaths.USER_INTERNAL_DELETE_WISHLIST_PRODUCT,{data:JSON.stringify({productIdList:data.productIdList})},this.wishlistCallback.bind(this,data,$this),'json');}}.bind(this));}},wishlistCallback:function(nodeData,$trigger,response){$trigger.removeAttr('disabled');if(response.data.response&&response.data.response.success==1){$trigger.data('wishlist',nodeData);let label='';if(nodeData.type=='delete'){label=nodeData.labelDeleted;$trigger.removeClass('wishlistButtonAdded wishlistButtonDelete').addClass('wishlistButtonAdd');this.showMessage(LC.global.languageSheet.wishlistDeleted,'danger');nodeData.type='add';}else{label=nodeData.labelAdded;$trigger.addClass('wishlistButtonAdded wishlistButtonDelete').removeClass('wishlistButtonAdd');this.showMessage(LC.global.languageSheet.wishlistAdded,'success');nodeData.type='delete';}
if(nodeData.showLabel)$trigger.html(label);}
this.trigger('wishlistCallback',nodeData,$trigger,response);},initShoppingList:function(){this.shoppingListRowId=this.el.$form.find('input[name="shoppingListRowId"]').val();this.el.$shoppingListDelete=this.el.$form.find('[data-shopping-list-delete]');if(this.el.$shoppingListDelete.length)this.shoppingList(this.el.$shoppingListDelete,'delete');this.el.$shoppingListAdd=this.el.$form.find('[data-shopping-list-add]');if(this.el.$shoppingListAdd.length)this.shoppingList(this.el.$shoppingListAdd,'add');this.el.$shoppingListAccountRequired=this.el.$form.find('[data-shopping-list-account_required]');if(this.el.$shoppingListAccountRequired.length)this.shoppingList(this.el.$shoppingListAccountRequired,'account_required');this.el.$shoppingListsAccountRequired=this.el.$form.find('[data-shopping-list-lists-account_required]');if(this.el.$shoppingListsAccountRequired.length)this.shoppingList(this.el.$shoppingListsAccountRequired,'lists-account_required');this.el.$shoppingListsAdd=this.el.$form.find('[data-shopping-list-lists-add]');if(this.el.$shoppingListsAdd.length)this.shoppingList(this.el.$shoppingListsAdd,'lists-add');this.el.$shoppingListsMenuList=this.el.$form.find('[data-shopping-list-lists-menu-list]');if(this.el.$shoppingListsMenuList.length)this.shoppingList(this.el.$shoppingListsMenuList,'lists-menu-list');this.el.$shoppingListsNew=this.el.$form.find('[data-shopping-list-lists-new]');if(this.el.$shoppingListsNew.length)this.shoppingList(this.el.$shoppingListsNew,'lists-new');},shoppingList:function(shoppingListElement,dataType){var $shoppingListElement=shoppingListElement;var data=$shoppingListElement.data('shoppingList-'+dataType);if(data.type==='accountRequired'){$shoppingListElement.box({uid:'shoppingListAccountRequiredModal',showFooter:false,source:`<div class="question shoppingListQuestion lcshoppingList">
                        <div class="questionText shoppingListQuestionText">${LC.global.languageSheet.shoppingListAccountRequired}</div>
                        <div class="questionButtons">
                            <button type="button" class="${BTN_SECONDARY_CLASS} pull-left questionButton questionButtonLeft shoppingListQuestionButton" id="shoppingListQuestionButton1" data-dismiss="modal" data-bs-dismiss="modal">${LC.global.languageSheet.no}</button>
                            <button type="button" class="${BTN_PRIMARY_CLASS} pull-right questionButton questionButtonRight shoppingListQuestionButton" id="shoppingListQuestionButton2" onclick="location.href='${LC.global.routePaths.USER}';">${LC.global.languageSheet.yes}</button>
                        </div>
                    </div>`,type:'html',showClose:false,size:'small',callback:'shoppingListAccountRequired',});}else if(data.type==='newList'){let $boxContent=$(`<div class="question shoppingListQuestion lcshoppingList">
                    <div class="questionText shoppingListQuestionText">${LC.global.languageSheet.shoppingListAddNewText}</div>
                    ${data.form}
                </div>`),uidModal='shoppingListNewListModal_'+this.type;if(this.type==='PRODUCT'){uidModal+='_'+this.data.id;}else{uidModal+='_'+this.dataBundle.grouping.id;}
const form=$boxContent.find('form')[0];$(form).attr('data-lc-uidModal',uidModal);$shoppingListElement.box({uid:uidModal,showFooter:false,source:$boxContent,type:'html',showClose:true,size:'medium',keepSrc:true,modalClass:'shoppingListNewListModal',});$('#'+uidModal).on('show.bs.modal',()=>{new LC.AddToNewShoppingListForm(form);});$('#'+uidModal).on('hidden.bs.modal',()=>{const newList=$('#'+uidModal).attr('data-lc-new-list');if(newList){this.el.$shoppingListsMenuList=$('[data-shopping-list-lists-menu-list]');if(this.el.$shoppingListsMenuList.length)this.shoppingList(this.el.$shoppingListsMenuList,'lists-menu-list');this.el.$shoppingListsNewElement.click();$('#'+uidModal).removeAttr('data-lc-new-list');}});}else if(data.type==='list'){if(!data.shoppingLists){data.shoppingLists=[];}
LC.global.session.shoppingLists.sort((a,b)=>a.priority-b.priority).forEach(shoppingList=>{if(!data.shoppingLists.includes(shoppingList.id)){this.el.$shoppingListsNewElement=$('<button />').addClass('dropdown-item shopping-list-lists-add').html(shoppingList.name);let newElementData={...data};newElementData.shoppingListId=shoppingList.id;newElementData.type='addList';this.el.$shoppingListsNewElement.attr('data-shopping-list-lists-add',JSON.stringify(newElementData));this.shoppingList(this.el.$shoppingListsNewElement,'lists-add');$shoppingListElement.find('.divider').before($('<li />').append(this.el.$shoppingListsNewElement));data.shoppingLists.push(shoppingList.id);}});}else if(data.type==='add'||data.type==='addList'||data.type==='delete'){$shoppingListElement.on('click',function(event){if(data.type==='add'||data.type==='addList'){event.preventDefault();$shoppingListElement.attr('disabled','disabled');if(window.BlueknowTracker)BlueknowTracker.trackExamined(data.itemId);this.trigger('shoppingListBefore');if(this.type==='PRODUCT'){var reference={id:this.data.id,type:this.type}
reference.productOptions=this.getFormData().options;}else{var reference={id:this.dataBundle.grouping.id,type:this.type}
reference.bundleOptions=this.getFormData().items;}
let requestData={reference:reference,type:'POST'};if(data.shoppingListId){requestData.shoppingListId=data.shoppingListId;}
$.post(LC.global.routePaths.USER_INTERNAL_SET_SHOPPING_LIST_ROW,{data:JSON.stringify(requestData)},this.shoppingListCallback.bind(this,data,$shoppingListElement),'json');}else{event.preventDefault();$shoppingListElement.attr('disabled','disabled');this.trigger('deleteShoppingListItemBefore');let requestData={};if(this.type=='PRODUCT'){requestData.productIdList=data.id;}else{requestData.bundleIdList=data.id;}
$.post(LC.global.routePaths.USER_INTERNAL_DELETE_SHOPPING_LIST_ROWS,{data:JSON.stringify(requestData)},this.shoppingListCallback.bind(this,data,$shoppingListElement),'json');}}.bind(this));}},updateShoppingListRow:function(){let reference={id:this.shoppingListRowId,type:this.type}
if(this.type=='PRODUCT'){reference.productOptions=this.getFormData().options}else{reference.bundleOptions=this.getFormData().items;}
$.post(LC.global.routePaths.USER_INTERNAL_SET_SHOPPING_LIST_ROW,{data:JSON.stringify({reference:reference,type:'PUT',id:this.shoppingListRowId})},(response)=>{if(response.data.response.success===0){this.showMessage(response.data.response.message,'danger');}else{this.showMessage(response.data.response.message,'success');}},'json');},shoppingListCallback:function(nodeData,$trigger,response){$trigger.removeAttr('disabled');if(response.data.response&&response.data.response.success==1){$trigger.data('shoppingList',nodeData);var label='';if(nodeData.type=='delete'){label=nodeData.labelDeleted;$trigger.removeClass('shoppingListButtonAdded shoppingListButtonDelete').addClass('shoppingListButtonAdd');this.showMessage(LC.global.languageSheet.shoppingListDeleted,'danger');nodeData.type='add';this.el.$shoppingListAdd=this.el.$shoppingListDelete;this.el.$shoppingListAdd.attr('data-shopping-list-add',JSON.stringify(nodeData));}else if(nodeData.type=='add'){label=nodeData.labelAdded;LC.resources.pluginListener('onAddShoppingList',{},nodeData);$trigger.addClass('shoppingListButtonAdded shoppingListButtonDelete').removeClass('shoppingListButtonAdd');this.showMessage(LC.global.languageSheet.shoppingListAdded,'success');nodeData.type='delete';}else if(nodeData.type=='addList'){const defaultShoppingListId=LC.global.session.shoppingLists.find(shoppingList=>shoppingList.defaultOne).id,shoppingListId=nodeData.shoppingListId?nodeData.shoppingListId:defaultShoppingListId,shoppingListName=LC.global.session.shoppingLists.find(shoppingList=>shoppingList.id==shoppingListId).name;label=nodeData.labelAdded;if(defaultShoppingListId===shoppingListId&&this.el.$shoppingListAdd.length){this.el.$shoppingListAdd.addClass('shoppingListButtonAdded shoppingListButtonDelete').removeClass('shoppingListButtonAdd');let data=this.el.$shoppingListAdd.data('shoppingList-add');data.type='delete';}
if(response.data.data.incidences.length){this.showMessage(response.data.response.message,'danger');}else{this.showMessage(LC.global.languageSheet.shoppingListsAdded.replace('{{listName}}',shoppingListName),'success');}}
if(nodeData.showLabel)$trigger.html(label);}else{this.showMessage(response.data.response.message,'danger');}
this.trigger('shoppingListCallback',nodeData,$trigger,response);},productComparison:function(){const $this=this.el.$productComparison,data=$this.data('product-comparison');if(data.type==='add'||data.type==='delete'){$this.on('click',function(event){event.preventDefault();$this.attr('disabled','disabled');let path='';if(data.type==='add'){this.trigger('addComparisonProductBefore');path=LC.global.routePaths.PRODUCT_COMPARISON_INTERNAL_ADD_COMPARISON_PRODUCT;}else{this.trigger('deleteComparisonProductBefore');path=LC.global.routePaths.PRODUCT_COMPARISON_INTERNAL_DELETE_COMPARISON_PRODUCT;}
$.post(path,{data:JSON.stringify({id:this.data.id})},this.productComparisonCallback.bind(this,data,$this),'json');}.bind(this));}},productComparisonCallback:function(nodeData,$trigger,response){$trigger.removeAttr('disabled');let message=LC.global.languageSheet.error,success=0,label='';if(typeof response!=='undefined'){if(response.data){message=response.data.response.message;success=response.data.response.success?response.data.response.success:0;}}
$trigger.data('product-comparison',nodeData);LC.productComparisonDetail.reload();if(response.data.response.success==1){if(nodeData.type=='delete'){label=nodeData.labelDelete;$trigger.removeClass('productComparisonButtonDelete').addClass('productComparisonButtonAdd');nodeData.type='add';}else{label=nodeData.labelAdd;$trigger.addClass('productComparisonButtonDelete').removeClass('productComparisonButtonAdd');nodeData.type='delete';}}
if(success){LC.notify(message,{type:'success'});}else{LC.notify(message,{type:'danger'});}
if(nodeData.showLabel&&label.length)$trigger.html(label);this.trigger('productComparisonCallback',nodeData,$trigger,response);},clickStockAlertButton:function(eventData){$('#stockAlert').find('#combinationId').attr('value',$(eventData.currentTarget).attr("combinationid"));},};LC.buyFormProperties={clickStockSubscriptionButton:function(eventData){$('#stockAlert').find('#combinationId').attr('value',$(eventData.currentTarget).attr("combinationid"));},wishlist:function(wishlist,dataType){var $this=wishlist;var data=$this.data('wishlist-'+dataType);if(data.type=='accountRequired'){$this.box({uid:'wishlistAccountRequiredModal',showFooter:false,source:`<div class="question wishlistQuestion lcWishlist">
                        <div class="questionText wishlistQuestionText">${LC.global.languageSheet.wishlistAccountRequired}</div>
                        <div class="questionButtons">
                            <button type="button" class="${BTN_SECONDARY_CLASS} pull-left questionButton questionButtonLeft wishlistQuestionButton" id="wishlistQuestionButton1" data-dismiss="modal" data-bs-dismiss="modal">${LC.global.languageSheet.no}</button>
                            <button type="button" class="${BTN_PRIMARY_CLASS} pull-right questionButton questionButtonRight wishlistQuestionButton" id="wishlistQuestionButton2" onclick="location.href='${LC.global.routePaths.USER}';">${LC.global.languageSheet.yes}</button>
                        </div>
                    </div>`,type:'html',showClose:false,size:'small',callback:'wishlistAccountRequired',});}else{$this.on('click',function(event){if(data.type=='add'){event.preventDefault();$this.attr('disabled','disabled');if(window.BlueknowTracker)BlueknowTracker.trackExamined(data.itemId);this.trigger('wishlistBefore');$.post(LC.global.routePaths.USER_INTERNAL_ADD_WISHLIST_PRODUCT,{data:JSON.stringify({id:this.data.id})},this.wishlistCallback.bind(this,data,$this),'json');}else{event.preventDefault();$this.attr('disabled','disabled');this.trigger('deleteWishlistItemBefore');$.post(LC.global.routePaths.USER_INTERNAL_DELETE_WISHLIST_PRODUCT,{data:JSON.stringify({productIdList:data.productIdList})},this.wishlistCallback.bind(this,data,$this),'json');}}.bind(this));}},wishlistCallback:function(nodeData,$trigger,response){$trigger.removeAttr('disabled');if(response.data.response&&response.data.response.success==1){$trigger.data('wishlist',nodeData);var label='';if(nodeData.type=='delete'){label=nodeData.labelDeleted;$trigger.removeClass('wishlistButtonAdded wishlistButtonDelete').addClass('wishlistButtonAdd');this.showMessage(LC.global.languageSheet.wishlistDeleted,'danger');nodeData.type='add';}else{label=nodeData.labelAdded;$trigger.addClass('wishlistButtonAdded wishlistButtonDelete').removeClass('wishlistButtonAdd');this.showMessage(LC.global.languageSheet.wishlistAdded,'success');nodeData.type='delete';}
if(nodeData.showLabel)$trigger.html(label);}
this.trigger('wishlistCallback',nodeData,$trigger,response);},shoppingList:function(shoppingList,dataType){var $this=shoppingList;var data=$this.data('shoppingList-'+dataType);if(data.type=='accountRequired'){$this.box({uid:'shoppingListAccountRequiredModal',showFooter:false,source:`<div class="question shoppingListQuestion lcshoppingList">
                        <div class="questionText shoppingListQuestionText">${LC.global.languageSheet.shoppingListAccountRequired}</div>
                        <div class="questionButtons">
                            <button type="button" class="${BTN_SECONDARY_CLASS} pull-left questionButton questionButtonLeft shoppingListQuestionButton" id="shoppingListQuestionButton1" data-dismiss="modal" data-bs-dismiss="modal">${LC.global.languageSheet.no}</button>
                            <button type="button" class="${BTN_PRIMARY_CLASS} pull-right questionButton questionButtonRight shoppingListQuestionButton" id="shoppingListQuestionButton2" onclick="location.href='${LC.global.routePaths.USER}';">${LC.global.languageSheet.yes}</button>
                        </div>
                    </div>`,type:'html',showClose:false,size:'small',callback:'shoppingListAccountRequired',});}else{$this.on('click',function(event){if(data.type=='add'){event.preventDefault();$this.attr('disabled','disabled');if(window.BlueknowTracker)BlueknowTracker.trackExamined(data.itemId);this.trigger('shoppingListBefore');$.post(LC.global.routePaths.USER_INTERNAL_SET_SHOPPING_LIST_ROW,{data:JSON.stringify({id:this.data.id})},this.shoppingListCallback.bind(this,data,$this),'json');}else{event.preventDefault();$this.attr('disabled','disabled');this.trigger('deleteshoppingListItemBefore');$.post(LC.global.routePaths.USER_INTERNAL_DELETE_SHOPPING_LIST_ROWS,{data:JSON.stringify({productIdList:data.id})},this.shoppingListCallback.bind(this,data,$this),'json');}}.bind(this));}},shoppingListCallback:function(nodeData,$trigger,response){$trigger.removeAttr('disabled');if(response.data.response&&response.data.response.success==1){$trigger.data('shoppingList',nodeData);var label='';if(nodeData.type=='delete'){label=nodeData.labelDeleted;$trigger.removeClass('shoppingListButtonAdded shoppingListButtonDelete').addClass('shoppingListButtonAdd');this.showMessage(LC.global.languageSheet.shoppingListDeleted,'danger');nodeData.type='add';}else{label=nodeData.labelAdded;$trigger.addClass('shoppingListButtonAdded shoppingListButtonDelete').removeClass('shoppingListButtonAdd');this.showMessage(LC.global.languageSheet.shoppingListAdded,'success');nodeData.type='delete';}
if(nodeData.showLabel)$trigger.html(label);}
this.trigger('shoppingListCallback',nodeData,$trigger,response);},productComparison:function(){var $this=this.el.$productComparison,data=$this.data('product-comparison');if(data.type=='add'||data.type=='delete'){$this.on('click',function(event){event.preventDefault();$this.attr('disabled','disabled');var path='';if(data.type=='add'){this.trigger('addComparisonProductBefore');path=LC.global.routePaths.PRODUCT_COMPARISON_INTERNAL_ADD_COMPARISON_PRODUCT;}else{this.trigger('deleteComparisonProductBefore');path=LC.global.routePaths.PRODUCT_COMPARISON_INTERNAL_DELETE_COMPARISON_PRODUCT;}
$.post(path,{data:JSON.stringify({id:this.data.id})},this.productComparisonCallback.bind(this,data,$this),'json');}.bind(this));}},productComparisonCallback:function(nodeData,$trigger,response){$trigger.removeAttr('disabled');var notifyType=response.data.response.success==1?'success':'danger',notifyMsg=response.data.response.message;if('errorCode'in response.data.data){notifyType='danger';}
$trigger.data('product-comparison',nodeData);LC.productComparisonDetail.reload();if(response.data.response.success==1||response.data.data.errorCode==='A01000-PRODUCT_NOT_FOUND'||response.data.data.errorCode==='A01000-PRODUCT_COMPARISON_ADD_PRODUCT_EXISTS'){var label='';if(nodeData.type=='delete'){label=nodeData.labelDelete;$trigger.removeClass('productComparisonButtonDelete').addClass('productComparisonButtonAdd');nodeData.type='add';}else{label=nodeData.labelAdd;$trigger.addClass('productComparisonButtonDelete').removeClass('productComparisonButtonAdd');nodeData.type='delete';}
if(response.data.data.errorCode==='A01000-PRODUCT_NOT_FOUND'){notifyMsg=LC.global.languageSheet.errorCodeProductComparisonProductNotFound;}else if(response.data.data.errorCode==='A01000-PRODUCT_COMPARISON_ADD_PRODUCT_EXISTS'){notifyMsg=LC.global.languageSheet.errorCodeProductComparisonProductAlreadyExists;}}
LC.notify(notifyMsg,{type:notifyType});if(nodeData.showLabel)$trigger.html(label);this.trigger('productComparisonCallback',nodeData,$trigger,response);},clickStockAlertButton:function(eventData){$('#stockAlert').find('#combinationId').attr('value',$(eventData.currentTarget).attr("combinationid"));}};LC.fn=function(name,o){(function($){o.options=$.extend(o.options,{});if(!o.Constructor||typeof o.Constructor!=='function'){throw'Constructor is not defined!';return;}
$.fn[name]=function(options){var defaults=$.extend(true,{},o.options);if(typeof options==='string'){var args=Array.prototype.slice.call(arguments,1);var res;this.each(function(){var obj=$.data(this,name);if(obj&&$.isFunction(obj[options])){var r=obj[options].apply(obj,args);if(res===undefined)res=r;if(options=='destroy')$.removeData(this,name);}else if(obj&&obj[options])res=obj[options];});if(res!==undefined)return res;return this;}
options=$.extend(defaults,options||{});this.each(function(i,_element){var element=$(_element);var obj=new o.Constructor(element,$.extend(true,{},options));element.data(name,obj);if(obj.init&&typeof obj.init==='function')obj.init();});return this;};})(jQuery);};LC.Queue=function(){var lst=[];this.getQueue=function(){return lst;};this.clear=function(){lst=[];return true;};this.enqueue=function(item,priority){if(priority==null)priority=0;if(lst.length){var auxLst=[];while(this.size()){if(lst[0].priority>priority){break;}
auxLst.push(lst.shift());}
auxLst.push({item:item,priority:priority});for(var i=0;i>lst.length;i++){auxLst.push(lst[i]);}
lst=auxLst;}else{lst.push({item:item,priority:priority});}
return true;};this.dequeue=function(){return lst.pop();};this.destack=function(){return lst.shift();};this.iterate=function(c){if(c&&typeof c==='function')
for(var i=0;i<lst.length;i++)c(lst[i].item);};this.size=function(){return lst.length;};};LC.initQueue=new LC.Queue();$(function(){while(LC.initQueue.size()){LC.initQueue.destack().item.apply();}});
'use strict';LC.BuyForm=LC.Form.extend({name:'buyForm',options:{},initialize:function(form){if(this.el.form.initialized)return;this.el.form.initialized=true;this.el.form.module=this;this.data=JSON.parse(this.el.$form.attr('data-product'));this.stockWarehouses=JSON.parse(this.el.$form.attr('data-stock-warehouses'));this.quantityField=this.el.$form.find('input[data-lc-field="quantity"]').get(0);this.alternativeImageField=this.el.$form.find('input[data-lc-field="alternativeImage"]').get(0);this.linkedSectionId=this.el.$form.find('input[name="sectionId"]').val();this.productsOptions=$(this.el.$form.find('div.productOptions'));this.useUrlOptionsParams=false;this.productsOptionsData={};if(this.productsOptions.length){this.productsOptionsData=JSON.parse($(this.productsOptions).attr('data-lc-data'));this.useUrlOptionsParams=this.productsOptionsData.useUrlOptionsParams;}
this.trigger('initializeBefore');if(!this.quantityField){this.quantityField=this.el.$form.find('input[name=quantity]').get(0);}else{this.quantityField=this.el.$form.find('.quantitySelect').get(0);this.quantityField=this.quantityField.options[this.quantityField.selectedIndex].value;}
this.el.$priceByQuantityBox=this.el.$form.find('.priceByQuantity');this.data.priceByQuantity.unshift({from:1,optionValueId:0,basePrice:this.data.definition.productBasePrice,retailPrice:this.data.definition.productRetailPrice,});this.$stockSubscriptionButton=this.el.$form.find('.stockAlertButton');this.$stockSubscriptionButton.click(this.clickStockAlertButton.bind(this));if(this.data.definition.availability){this.productAvailabilities=this.data.definition.availability.intervals;}else{this.productAvailabilities=[];}
this.el.$productOptionAttachment=this.el.$form.find('div.lcProductOptionAttachment');this.callback=this.callback.bind(this);this.optionsInitialized=false;this.initOptions();this.trigger('init');this.el.$wishlistDelete=this.el.$form.find('[data-wishlist-delete]');if(this.el.$wishlistDelete.length)this.wishlist(this.el.$wishlistDelete,'delete');this.el.$wishlistAdd=this.el.$form.find('[data-wishlist-add]');if(this.el.$wishlistAdd.length)this.wishlist(this.el.$wishlistAdd,'add');this.el.$wishlistAccountRequired=this.el.$form.find('[data-wishlist-account_required]');if(this.el.$wishlistAccountRequired.length)this.wishlist(this.el.$wishlistAccountRequired,'account_required');this.el.$shoppingListDelete=this.el.$form.find('[data-shopping-list-delete]');if(this.el.$shoppingListDelete.length)this.shoppingList(this.el.$shoppingListDelete,'delete');this.el.$shoppingListAdd=this.el.$form.find('[data-shopping-list-add]');if(this.el.$shoppingListAdd.length)this.shoppingList(this.el.$shoppingListAdd,'add');this.el.$shoppingListAccountRequired=this.el.$form.find('[data-shopping-list-account_required]');if(this.el.$shoppingListAccountRequired.length)this.shoppingList(this.el.$shoppingListAccountRequired,'account_required');this.el.$productComparison=this.el.$form.find('[data-product-comparison]');if(this.el.$productComparison.length)this.productComparison();this.el.$form.find('[data-datetimepicker]').each((index,el)=>{var $calendar=$(el),language=$calendar.data('language')?$calendar.data('language'):'en',format=$calendar.data('format'),startDate=$calendar.data('startdate'),endDate=$calendar.data('enddate'),weekstart=$calendar.data('weekstart');moment.locale(language,{week:{dow:weekstart}});$calendar.datetimepicker({locale:language,format:format?format:CALENDAR_PLUGIN_DATE_FORMAT,minDate:startDate,endDate:endDate});$(el).on('dp.change',(e)=>{var $optionsubmitValue=this.el.$form.find('[name="'+$calendar.data('submit')+'"]'),previous=$optionsubmitValue.val();if(e.date){$optionsubmitValue.val(moment(e.date).format('YYYY-MM-DD'));}else{$optionsubmitValue.val('');}
if(previous!=$optionsubmitValue.val()){previous=$optionsubmitValue.val();$optionsubmitValue.change();$optionsubmitValue.val(previous);}});});this.trigger('initializeCallback');this.el.$pseudoSubmits=this.el.$form.find('[data-lc-formButton="addSpecialProduct"]');if(this.el.$pseudoSubmits.length)this.pseudoSubmits();if(typeof pmtSimulator!='undefined')pmtSimulator.simulator_app.reload();},addOptionsToProductLink:function(){if((this.optionsInitialized||this.useUrlOptionsParams)&&this.productsOptionsData.addOptionsToProductLink){var options=this.el.$options.serializeArray(),optionsParams={},pathParams='';for(var i=0;i<options.length;i++){var $optionElement=$(this.el.$form.find('[name="'+options[i].name+'"]'));if(!($optionElement.hasClass('productOptionDateValue')||$optionElement.hasClass('productOptionAttachmentValue')||$optionElement.hasClass('productOptionTextValue'))){if(!(options[i].name in optionsParams)){optionsParams[options[i].name]=[];}
optionsParams[options[i].name].push(options[i].value);}}
if(Object.keys(optionsParams).length>0){pathParams='?';}
for(var element in optionsParams){if(optionsParams.hasOwnProperty(element)){if(optionsParams[element].length==1){if(pathParams!='?')pathParams=pathParams+'&';pathParams=pathParams+encodeURI(element.replace('optionValue','optionId_'))+"="+encodeURI(optionsParams[element][0]);}else{for(var i=0;i<optionsParams[element].length;i++){if(pathParams!='?')pathParams=pathParams+'&';pathParams=pathParams+encodeURI(element.replace('optionValue','optionId_'))+'_'+i+"="+encodeURI(optionsParams[element][i]);}}}}
this.el.$form.find(`a[href^="${this.data.language.urlSeo}"]`).each((i,element)=>{$(element).prop('href',$(element).prop('href').split('?')[0]+pathParams);});}},initOptions:function(){this.trigger('initOptionsBefore');this.el.$gridCombinations=this.el.$form.find('[lc-data-grid-combination-id]');if(this.el.$productOptionAttachment.length)this.attachmentFields(this.el.$productOptionAttachment);this.el.$gridOption=this.el.$form.find('[data-lc-grid-options]');if(this.el.$gridOption.length){var num=this.el.$gridOption.data('lc-grid-options');if(num==1){this.el.gridOptionsIds=[this.el.$gridOption.data('lc-product-option').id];this.el.gridOptionValues1=this.el.$form.find('.gridOptionsInfo').data('grid-options1');}else{this.el.gridOptionsIds=[this.el.$gridOption.data('lc-product-option').id1,this.el.$gridOption.data('lc-product-option').id2,];this.el.gridOptionValues1=this.el.$form.find('.gridOptionsInfo').data('grid-options1');this.el.gridOptionValues2=this.el.$form.find('.gridOptionsInfo').data('grid-options2');}}
this.el.$options=this.el.$form.find('select.productOptionSelectValue, input.productOptionRadioValue, input.productOptionCheckboxValue, input.productOptionBooleanValue, input.productOptionTextValue, textarea.productOptionLongTextValue, input.productOptionDateValue, input.productOptionAttachmentValue');this.el.$options.change(this.changeOption.bind(this));this.el.$form.find('img.productOptionValueImage').each(function(a,b){$(this).click(function(a,b,c){$(a.target).parent('label').click();});});if(typeof this.quantityField==='undefined')this.quantityField=this.el.$form.find('.quantitySelect').get(0);$(this.quantityField).change(this.changeQuantity.bind(this));this.requiredOptions=[];this.requiredGridOptions=[];for(var option in this.data.options){if(this.data.options[option].required){const optionTypes=['MULTIPLE_SELECTION_IMAGE','MULTIPLE_SELECTION','SELECTOR','SINGLE_SELECTION_IMAGE','SINGLE_SELECTION',];if(optionTypes.includes(this.data.options[option].valueType))
this.requiredOptions.push(this.data.options[option].id);}
for(var key in this.data.options[option].values){var optionValue=this.data.options[option].values[key];this.data.priceByQuantity.unshift({from:1,optionValueId:optionValue.id,basePrice:optionValue.basePrice,retailPrice:optionValue.retailPrice,});}}
if(this.el.$gridOption.length!=0){this.el.$gridOptions=this.el.$form.find('input.productGridQuantityValue');this.el.$gridOptions.change(this.changeGridOption.bind(this));this.el.$options.change(this.changeGridOption.bind(this));}
if(this.el.$gridCombinations&&this.el.$gridCombinations.length!=0){if(this.quantityField)this.quantityField.remove();this.el.$gridCombinations.change(this.changeGridCombinations.bind(this));this.el.$gridCombinationsType=this.el.$form.find('input[name=gridCombinationsType]');}
this.el.$form.find('input.productOptionRadioValue:checked').parent('div.productOptionRadioValue').addClass('productOptionSelected');this.el.$form.find('input.productOptionCheckboxValue:checked').parent('div.productOptionCheckboxValue').addClass('productOptionSelected');this.addOptionsToProductLink();this.onChange(true);this.trigger('initOptionsCallback');this.optionsInitialized=true;},changeGridOption:function(eventData){this.trigger('changeOptionBefore');this.trigger('changeOptionCallback',eventData.target);this.onChange();},changeGridCombinations:function(eventData){this.trigger('changeCombinationBefore');this.trigger('changeCombinationCallback',eventData.target);this.onChange();},changeOption:function(eventData){this.trigger('changeOptionBefore');this.addOptionsToProductLink();if($(eventData.target).hasClass('productOptionRadioValue')){$(eventData.target).parents('div.productOptionValues').find('div.productOptionRadioValue').removeClass('productOptionSelected');$(eventData.target).parent('div.productOptionRadioValue').addClass('productOptionSelected');}
if($(eventData.target).hasClass('productOptionCheckboxValue')){if(eventData.target.checked)
$(eventData.target).parent('div.productOptionCheckboxValue').addClass('productOptionSelected');else
$(eventData.target).parent('div.productOptionCheckboxValue').removeClass('productOptionSelected');}
if($(eventData.target).hasClass('productOptionAttachmentValue'))this.parseFile(eventData.target);this.trigger('changeOptionCallback',eventData.target);this.onChange(true);},changeQuantity:function(eventData){var quantityValue=$(this.quantityField).val();this.trigger('changeQuantityBefore');this.trigger('changeQuantityCallback',{quantity:quantityValue});this.onChange(true);},getFormValues:function(){var formValues;if(this.el.$options.length){formValues=this.el.$options.serializeArray();}else{formValues=[];var selectedOptions=[];if(LC.global.settings.stockManagement&&this.data.definition.stockManagement){for(var key in this.data.stocks){if(this.data.stocks[key]>0){var optionValues=key.split('_');if(optionValues.length==1)break;optionValues=optionValues[1].split('-');for(var i=0;i<optionValues.length;i++){for(var option in this.data.options){if(this.data.options[option].values['id'+optionValues[i]]){formValues.push({name:'optionValue'+this.data.options[option].id,value:optionValues[i],});selectedOptions.push(this.data.options[option].id);}}}
break;}}}
var requiredOptions=[];for(var i=0;i<this.requiredOptions.length;i++)
if(selectedOptions.indexOf(this.requiredOptions[i])==-1)
requiredOptions.push(this.requiredOptions[i]);for(var i=0;i<requiredOptions.length;i++){for(var value in this.data.options['id'+requiredOptions[i]].values){formValues.push({name:'optionValue'+requiredOptions[i],value:this.data.options['id'+requiredOptions[i]].values[value].id,});break;}}}
if(this.el.$productOptionAttachment.length){var attachedFile=this.el.$form.find('input.productOptionAttachmentHiddenValue').serializeArray();for(var i=0;i<attachedFile.length;i++)formValues.push(attachedFile[i]);}
return formValues;},updateButton:function(button,properties){button.removeClass('selectOption notAvailable reserve buy');button.addClass(properties.className);button.prop('disabled',properties.disabled);button.data('buyFormSubmitName',properties.name);if(button.data('show-label')==true)button.html(properties.name);else button.html('');},onChange:function(baseStockForSubscription){var selectedOptions=[];var selectedValues=[];var selectedStockValues=[];var optionId,optionValueId,currentOption;var baseStockForSubscription=baseStockForSubscription||false;this.trigger('onChangeBefore',formValues);this.setOptionRestrictions();var formValues=this.getFormValues();var quantityValue=parseInt($(this.quantityField).val());if(!quantityValue||isNaN(quantityValue))quantityValue=1;var validateCombinationStock=true;if(this.el.$gridCombinations&&this.el.$gridCombinations.length!=0){validateCombinationStock=false;}else if(this.el.$gridOptions){var gridOptions=[];var totalQty=0;validateCombinationStock=false;for(var i=0;i<this.el.$gridOptions.length;i++){var $e=$(this.el.$gridOptions[i]);var qty=$e.val();gridOptions.push($e.attr('name'));if($.isNumeric(qty)&&qty>0)totalQty+=qty;}}
for(var i=0;i<formValues.length;i++){optionId=formValues[i].name.replace('optionValue','');optionValueId=formValues[i].value;currentOption=this.data.options['id'+optionId];if(Object.getLength(currentOption.values)){if(currentOption.values['id'+optionValueId]){selectedOptions.push(parseInt(optionId));selectedValues.push(currentOption.values['id'+optionValueId]);selectedValues[selectedValues.length-1].uniquePrice=currentOption.uniquePrice;if(currentOption.combinable)selectedStockValues.push(parseInt(optionValueId));}}else{selectedOptions.push(parseInt(optionId));}}
selectedStockValues=selectedStockValues.sort(function(a,b){return a-b;}).join('-');var requiredOptions=[];for(var i=0;i<this.requiredOptions.length;i++)
if(selectedOptions.indexOf(this.requiredOptions[i])==-1)
if(!this.el.$form.find('.productOption'+this.requiredOptions[i]).hasClass('_restricted_'))
requiredOptions.push(this.requiredOptions[i]);var basePrice=this.data.definition.productBasePrice,retailPrice=this.data.definition.productRetailPrice,price=0;var alternativeBasePrice=this.data.definition.productAlternativeBasePrice,alternativeRetailPrice=this.data.definition.productAlternativeRetailPrice,alternativePrice=0;var quantityMultiplier=1;if(requiredOptions.length||!this.el.$options.length){basePrice=this.data.definition.basePrice;retailPrice=this.data.definition.retailPrice;alternativeBasePrice=this.data.definition.alternativeBasePrice;alternativeRetailPrice=this.data.definition.alternativeRetailPrice;}else{for(var i=0;i<selectedValues.length;i++){if(!selectedValues[i].uniquePrice){basePrice+=selectedValues[i].basePrice;retailPrice+=selectedValues[i].retailPrice;alternativeBasePrice+=selectedValues[i].alternativeBasePrice;alternativeRetailPrice+=selectedValues[i].alternativeRetailPrice;}}}
var stock=999999999,lockedStock=0,backorderPrevision=999999999,combinationFound=true,combinationId=0,stockKeys=[],backorderKeys=[],sku='',ean='',stockMatch='WH[0-9]+_',availableWarehouses='',warehousesIdArray=[];warehousesIdArray=this.stockWarehouses.map(function(el){return el.warehousesStructureId;});if(warehousesIdArray.length)availableWarehouses=warehousesIdArray.join('|');else stockMatch=null;if(stockMatch!==null&&availableWarehouses.length>0){stockMatch='('+availableWarehouses+')+_';}
if(validateCombinationStock){for(var key in this.data.combinations){if(key.match('PC_'+selectedStockValues+'$')){sku=this.data.combinations[key].sku;ean=this.data.combinations[key].ean;combinationId=this.data.combinations[key].id;break;}}
if(LC.global.settings.stockManagement&&this.data.definition.stockManagement){(stock=0),(backorderPrevision=0),(combinationFound=false);for(var key in this.data.stocks){if(key.match(stockMatch+selectedStockValues+'$')){if(stockKeys.indexOf(key)==-1)stockKeys.push(key);stock+=this.data.stocks[key];combinationFound=true;}}
for(i=0;i<this.data.stockPrevisions.length;i++){var key=this.data.stockPrevisions[i].warehousesStructureId;if(key.match(stockMatch+selectedStockValues+'$')){if(stockKeys.indexOf(key)==-1)stockKeys.push(key);stock+=this.data.stockPrevisions[i].stock;combinationFound=true;}}
for(i=0;i<this.data.backorderPrevisions.length;i++){var key=this.data.backorderPrevisions[i].warehousesStructureId;if(key.match(stockMatch+selectedStockValues+'$')){if(backorderKeys.indexOf(key)==-1)backorderKeys.push(key);backorderPrevision+=this.data.backorderPrevisions[i].stock;}}
if(!combinationFound)stock=-1;}
if(combinationId&&combinationId in this.data.stockLocks){lockedStock=this.data.stockLocks[combinationId].totalQuantity;lockedStockExpiration=this.data.stockLocks[combinationId].expirations[0];}}
if(this.$stockSubscriptionButton.length){this.$stockSubscriptionButton.attr('combinationId',combinationId);if(stock===0){this.$stockSubscriptionButton.addClass('product-stock-alert-active').removeClass('product-stock-alert-hidden');}else{this.$stockSubscriptionButton.addClass('product-stock-alert-hidden').removeClass('product-stock-alert-active');}}else{if(!window.productStocks)window.productStocks={};window.productStocks[this.data.id]=selectedStockValues;}
if(this.data.definition.offer&&basePrice>retailPrice){price=retailPrice;alternativePrice=alternativeRetailPrice;this.el.$form.find('.product-basePrice').show();this.el.$form.find('.product-basePrice[data-lc-show-alternative-price="true"]').show();this.el.$form.find('.product-saving').show();var saving=basePrice-retailPrice;this.el.$form.find('.product-saving .price').replaceWith(outputHtmlCurrency(saving));this.el.$form.find('.product-saving .percent').html(((saving*100)/basePrice).toFixed(0));}else{price=basePrice;alternativePrice=alternativeBasePrice;this.el.$form.find('.product-basePrice').hide();this.el.$form.find('.product-basePrice[data-lc-show-alternative-price="true"]').hide();this.el.$form.find('.product-saving').hide();}
this.el.$form.find('.product-price .price').replaceWith(outputHtmlCurrency(price));this.el.$form.find('.product-price[data-lc-show-alternative-price="true"] .price').replaceWith(outputHtmlCurrency(alternativePrice));this.el.$form.find('.product-basePrice .price').replaceWith(outputHtmlCurrency(basePrice));this.el.$form.find('.product-basePrice[data-lc-show-alternative-price="true"] .price').replaceWith(outputHtmlCurrency(alternativeBasePrice));if(stock>=0){this.el.$form.find('.product-stock').removeClass('not-init').find('.stock').html(stock);if(stock>0){this.el.$form.find('.product-stock').removeClass('no-stock').addClass('stock-ok');this.el.$form.find('.product-stock .stock').html(stock);if(stock===1){this.el.$form.find('.stockText').html(LC.global.languageSheet.stockSingular.replace('{{stock}}',stock));}else{this.el.$form.find('.stockText').html(LC.global.languageSheet.stockPlural.replace('{{stock}}',stock));}}else{this.el.$form.find('.product-stock').removeClass('stock-ok').addClass('no-stock');this.el.$form.find('.stockText').html(LC.global.languageSheet.stockNone.replace('{{stock}}',stock));}}else{this.el.$form.find('.product-stock').addClass('not-init');}
if(sku.length>0)this.el.$form.find('.product-combinations-sku').html(sku);if(ean.length>0)this.el.$form.find('.product-combinations-ean').html(ean);var availabilityInterval;for(var i=this.productAvailabilities.length-1;i>-1;i--){if(this.productAvailabilities[i].stock<stock)break;availabilityInterval=this.productAvailabilities[i];}
if(availabilityInterval){this.el.$form.find('.product-stock').removeClass('not-init');this.el.$form.find('.product-stock .availabilityImage').html('<img src="'+availabilityInterval.language.image+'" onerror="$(this).remove();">');this.el.$form.find('.product-stock .availabilityName').html(availabilityInterval.language.name.replace('{{stock}}',stock));}else{this.el.$form.find('.product-stock .availabilityImage').hide();this.el.$form.find('.product-stock .availabilityName').hide();}
if(this.data.definition.onRequest&&availabilityInterval){this.el.$form.find('.product-stock .availabilityName').html(availabilityInterval.language.name.replace('{{onRequestDays}}',this.data.definition.onRequestDays));}
var buyButtonProps={};var displaySubscription=null;if('countdown'in this)this.countdown.destroy();this.el.$form.find('.lcStockLock').removeClass('active');this.el.$form.find('.lcStockLockText').empty();var lsBUY=LC.global.languageSheet.buy;if(this.el.$gridCombinationsType&&this.el.$gridCombinationsType.val()=='update'){lsBUY=LC.global.languageSheet.update;}
if(requiredOptions.length){buyButtonProps.className='selectOption';buyButtonProps.name=LC.global.languageSheet.selectOption.replace('{{option}}',this.data.options['id'+requiredOptions[0]].name);buyButtonProps.disabled=true;displaySubscription='none';}else if(!validateCombinationStock&&totalQty==0){buyButtonProps.className='selectOption';buyButtonProps.name=LC.global.languageSheet.selectOption.replace('{{option}}',this.data.options['id'+this.requiredGridOptions[0]].name);buyButtonProps.disabled=true;displaySubscription='none';}else if(this.data.definition.onRequest&&stock>=0){buyButtonProps.className='buy';buyButtonProps.name=lsBUY;buyButtonProps.disabled=false;displaySubscription='none';}else if(stock<0){buyButtonProps.className='notAvailable';buyButtonProps.name=LC.global.languageSheet.notAvailable;buyButtonProps.disabled=true;displaySubscription='none';}else if(stock==0||quantityValue>stock){if(LC.global.settings.allowReservations===true&&this.data.definition.backorder!='NONE'){if((this.data.definition.backorder=='WITH_PREVISION'&&backorderPrevision+stock>=quantityValue)||this.data.definition.backorder=='WITH_AND_WITHOUT_PREVISION'||this.data.definition.backorder=='WITHOUT_PREVISION'){buyButtonProps.className='reserve';buyButtonProps.name=LC.global.languageSheet.reserve;buyButtonProps.disabled=false;}else{buyButtonProps.className='notAvailable';buyButtonProps.name=LC.global.languageSheet.notAvailable;buyButtonProps.disabled=true;if(baseStockForSubscription&&stock==0)displaySubscription='block';else displaySubscription='none';}
if(baseStockForSubscription&&stock==0)displaySubscription='block';else displaySubscription='none';}else{buyButtonProps.className='notAvailable';buyButtonProps.name=LC.global.languageSheet.notAvailable;buyButtonProps.disabled=true;if(baseStockForSubscription&&stock==0)displaySubscription='block';else displaySubscription='none';}}else if(stock-lockedStock<=0){buyButtonProps.className='notAvailable reserved';buyButtonProps.name=LC.global.languageSheet.stockReserved;buyButtonProps.disabled=true;displaySubscription='none';this.el.$form.find('.lcStockLock').addClass('active');if(lockedStockExpiration){this.countdown=new LC.combinationCountdown({endDate:lockedStockExpiration.expires,quantity:lockedStockExpiration.quantity,});this.el.$form.find('.lcStockLockText').append(this.countdown.$container);}else{this.el.$form.find('.lcStockLockText').append(LC.global.languageSheet.stockReservedUserText);}}else{buyButtonProps.className='buy';buyButtonProps.name=lsBUY;buyButtonProps.disabled=false;displaySubscription='none';}
this.el.$buyFormSubmit=this.el.$form.find('button[type="submit"]');this.updateButton(this.el.$buyFormSubmit,buyButtonProps);this.enabledButtons=this.el.$buyFormSubmit.filter(':enabled');this.updatePriceByQuantity(selectedValues);var offsetContainer=this.el.$form.find('.productOffsetMessage'),stcStockOffset={};if(offsetContainer.length&&stockKeys.length&&this.stockWarehouses.length){offsetContainer.html('');var acumulatedStock=0,offsetDays=0,requestOffset=0,previsionDate=new Date(),productData=this.data;if(this.data.definition.onRequest)requestOffset=this.data.definition.onRequestDays;$.each(this.stockWarehouses,function(i,wStructure){for(i=0;i<stockKeys.length;i++){if(stockKeys[i].indexOf(wStructure.warehousesStructureId)!=-1){stcStockOffset[stockKeys[i]]=wStructure.offsetDays;if(productData.stocks[stockKeys[i]]){acumulatedStock+=productData.stocks[stockKeys[i]];if(wStructure.offsetDays>offsetDays)offsetDays=wStructure.offsetDays;}}
if(acumulatedStock>=quantityValue){return false;}}});previsionDate.setDate(previsionDate.getDate()+offsetDays);if(acumulatedStock<quantityValue){var auxPrevisionDate=new Date();productData.stockPrevisions.sort(function(a,b){return new Date(a.incomingDate)>new Date(b.incomingDate);});$.each(productData.stockPrevisions,function(i,prevision){for(i=0;i<stockKeys.length;i++){if(stockKeys[i].indexOf(prevision.warehousesStructureId)!=-1&&prevision.stock>0){acumulatedStock+=prevision.stock;offsetDays=stcStockOffset[prevision.warehousesStructureId]||offsetDays;auxPrevisionDate=new Date(prevision.incomingDate);}
if(acumulatedStock>=quantityValue){return false;}}});auxPrevisionDate.setDate(auxPrevisionDate.getDate()+offsetDays);if(auxPrevisionDate>previsionDate)previsionDate=auxPrevisionDate;}
if(acumulatedStock<quantityValue&&LC.global.settings.allowReservations&&this.data.definition.backorder!='NONE'){var auxPrevisionDate=new Date();productData.backorderPrevisions.sort(function(a,b){return new Date(a.incomingDate)>new Date(b.incomingDate);});$.each(productData.backorderPrevisions,function(i,prevision){for(i=0;i<backorderKeys.length;i++){if(backorderKeys[i].indexOf(prevision.warehousesStructureId)!=-1&&prevision.stock>0){acumulatedStock+=prevision.stock;offsetDays=stcStockOffset[prevision.warehousesStructureId]||offsetDays;auxPrevisionDate=new Date(prevision.incomingDate);}
if(acumulatedStock>=quantityValue){return false;}}});auxPrevisionDate.setDate(auxPrevisionDate.getDate()+offsetDays);if(auxPrevisionDate>previsionDate)previsionDate=auxPrevisionDate;}
if(acumulatedStock>=quantityValue&&previsionDate.setHours(0,0,0,0)>new Date().setHours(0,0,0,0)){var formattedDate=moment(previsionDate).format(CALENDAR_PLUGIN_DATE_FORMAT);offsetContainer.html(LC.global.languageSheet.warehouseOffsetMessage.replace('{{offsetDays}}',formattedDate).replace('{{previsionDate}}',formattedDate));}else if(acumulatedStock<quantityValue&&requestOffset)
offsetContainer.html(LC.global.languageSheet.onRequestProductMessage.replace('{{days}}',requestOffset));}
if(LC.global.settings.showTaxesIncluded===true)var sendPrice=alternativePrice*quantityValue;else var sendPrice=price*quantityValue;if(this.data.restrictions&&this.data.restrictions.length){this.setOptionRestrictions();}
this.trigger('onChangeCallback',{price:price,basePrice:basePrice,requiredOptions:requiredOptions,selectedOptions:selectedOptions,stock:stock,quantity:quantityValue,});},setOptionRestrictions:function(){var form=this.el.$form;var getField=function(valueId){return form.find('*[value='+valueId+']');};var getChecked=function(valueId){var field=getField(valueId).first();return field.length?field[0].checked||field[0].selected:false;};var disableField=function(valueId){var field=getField(valueId);var ind,i,k;if(!field)return;field.addClass('_restricted_').attr('disabled',1).css('display','none').removeAttr('checked');if(field.parents('tr.productOptionValueTable').length==1){field.parents('tr.productOptionValueTable').css('display','none').removeClass('productOptionSelected');}else if(field[0].tagName.toLowerCase()!='option')
parentNode=field.parent('.productOptionValue').css('display','none').removeClass('productOptionSelected');};var disableOption=function(optionId){var option=form.find('.productOption'+optionId);option.addClass('_restricted_').css('display','none');option.find('select').addClass('_restricted_').attr('disabled',1).attr('selectedIndex',-1);option.find('input.productOptionRadioValue').addClass('_restricted_').attr('disabled',1).removeAttr('checked').parent('.productOptionRadioValue').removeClass('productOptionSelected');};form.find('._restricted_').removeClass('_restricted_').removeAttr('disabled').css('display','').css('display','').each(function(index,field){if(field.tagName.toLowerCase()!='option'){$(field).parent('.productOptionValue').css('display','');if($(field).parents('tr.productOptionValueTable').length==1){$(field).parents('tr.productOptionValueTable').css('display','');}}});if(this.data.restrictionsMain&&this.data.restrictionsMain.length){for(var ind=0;ind<this.data.restrictionsMain.length;ind++){var restriction=this.data.restrictionsMain[ind];if(!getChecked(restriction.MAIN))continue;for(i=0;i<restriction.OPTIONS.length;i++)disableOption(restriction.OPTIONS[i]);for(i=0;i<restriction.VALUES.length;i++)disableField(restriction.VALUES[i]);}
var anyChecked=0;form.find('.productOption').each(function(index,div){div=$(div);var someChecked=div.find(':checked');if(!someChecked.length){var somethingChecked=div.find(':enabled').first();somethingChecked.prop('checked',1).attr('selected',1).parent('.productOptionRadioValue, .productOptionCheckboxValue').addClass('productOptionSelected');anyChecked+=somethingChecked.length;}});if(anyChecked)this.onChange();}
if(this.data.restrictions&&this.data.restrictions.length){for(i=0;i<this.data.restrictions.length;i++){var limitation=this.data.restrictions[i];var matching=[],noMatching=[];for(k=0;k<limitation.length;k++){var valueId=limitation[k];if(getChecked(valueId))matching.push(valueId);else noMatching.push(valueId);}
if(noMatching.length==1)disableField(noMatching[0]);}}},updatePriceByQuantity:function(selectedOptions){if(!this.el.$priceByQuantityBox.length)return;selectedOptions=selectedOptions.map(function(i){return i.id;});this.el.$priceByQuantityBox.html('');var prices=this.getPrices(selectedOptions),table='<table>',label='',pricesArray=new Array();for(var key in prices)
pricesArray.push({from:prices[key].from,retailPrice:prices[key].retailPrice,basePrice:prices[key].basePrice,});if(pricesArray.length<2)return;for(var i=0;i<pricesArray.length;i++){if(i==pricesArray.length-1)
label=LC.global.languageSheet.moreThanNUnits.replace('{{n}}',pricesArray[i].from-1);else if(i==0&&pricesArray[i+1].from==2)
label=LC.global.languageSheet.oneUnit.replace('{{n}}',pricesArray[i].from);else if(i==0)
label=LC.global.languageSheet.fromNToMUnits.replace('{{n}}',1).replace('{{m}}',pricesArray[i+1].from-1);else if(pricesArray[i].from+1==pricesArray[i+1].from)
label=LC.global.languageSheet.nUnits.replace('{{n}}',pricesArray[i].from);else
label=LC.global.languageSheet.fromNToMUnits.replace('{{n}}',pricesArray[i].from).replace('{{m}}',pricesArray[i+1].from-1);var price=pricesArray[i].basePrice,basePriceData='';if(this.data.definition.offer&&pricesArray[i].basePrice>pricesArray[i].retailPrice&&pricesArray[i].retailPrice!=0){price=pricesArray[i].retailPrice;basePriceData=' data-base-price="'+pricesArray[i].basePrice+'"';}
table+='<tr><td class="messageColumn">'+label+'</td><td class="priceColumn"'+basePriceData+'>'+outputHtmlCurrency(price)+'</td></tr>';}
table+='</table>';this.el.$priceByQuantityBox.html(table);},getPrices:function(optionValues){optionValues=optionValues||[];optionValues.unshift(0);var prices={};for(var i=0;i<this.data.priceByQuantity.length;i++){var priceData=this.data.priceByQuantity[i];if(optionValues.indexOf(priceData.optionValueId)>-1){prices['p'+priceData.from]=prices['p'+priceData.from]||{from:priceData.from,basePrice:0,retailPrice:0,};}}
for(var key in prices){for(var i=0;i<optionValues.length;i++){var interval=this.getPriceInterval(prices[key].from,optionValues[i]);prices[key].basePrice+=interval.basePrice;prices[key].retailPrice+=interval.retailPrice;}}
return prices;},getPriceInterval:function(from,optionValueId){for(var i=this.data.priceByQuantity.length-1;i>-1;i--){if(this.data.priceByQuantity[i].from>from)continue;if(this.data.priceByQuantity[i].optionValueId!=optionValueId)continue;return this.data.priceByQuantity[i];}
return{from:from,basePrice:0,retailPrice:0};},getQuantityValue:function(def){var minQuantity=1;if(def.minOrderQuantity)
minQuantity=def.minOrderQuantity;if(def.multipleOrderQuantity>0){if(def.multipleActsOver>0){if(minQuantity>=def.multipleActsOver&&minQuantity%def.multipleOrderQuantity!==0){var difference=minQuantity%def.multipleOrderQuantity;minQuantity=minQuantity+(def.multipleOrderQuantity-difference);}}else{if(minQuantity<def.multipleOrderQuantity){minQuantity=def.multipleOrderQuantity;}else{if(minQuantity%def.multipleOrderQuantity!==0){var difference=minQuantity%def.multipleOrderQuantity;minQuantity=minQuantity+(def.multipleOrderQuantity-difference);}}}}
return minQuantity;},getFormData:function(){var formValues=this.getFormValues();var options={},optionsArray=[],value='';for(var i=0;i<formValues.length;i++){if(!options[formValues[i].name])options[formValues[i].name]=[];value=formValues[i].value;try{value=JSON.parse(formValues[i].value);}catch(error){}
if($.type(value)==='object'){options[formValues[i].name].push(value);}else{options[formValues[i].name].push({value:formValues[i].value});}}
for(var option in options)
optionsArray.push({id:option.replace('optionValue',''),values:options[option]});if(typeof this.quantityField==='undefined'){this.quantityField=this.el.$form.find('.quantitySelect').get(0);}
var response={id:this.data.id,quantity:this.quantityField?this.quantityField.value:this.getQuantityValue(this.data.definition),options:optionsArray,alternativeImage:this.alternativeImageField?this.alternativeImageField.value:'',sectionId:this.linkedSectionId,parentHash:this.el.$form.find('input[name="parentHash"]')?.val()||'',mode:this.el.$form.find('#mode').length?this.el.$form.find('#mode').val():''};if(this.el.$gridOption.length>0){response.gridValues={};this.el.$gridOptions.each(function(i,e){var val=$(e).val();if(val.length==0)val=0;response.gridValues[$(e).attr('name')]=val;});response.gridOptionsIds=this.el.gridOptionsIds;response.gridOptionValues1=this.el.gridOptionValues1;if(this.el.gridOptionValues2){response.gridOptionValues2=this.el.gridOptionValues2;}}
if(this.el.$gridCombinations&&this.el.$gridCombinations.length>0){response.gridCombinationsValues={};this.el.$gridCombinations.each(function(i,e){response.gridCombinationsValues[$(e).attr('name')]=parseInt($(e).val());});}
return response;},submit:function(event){event.preventDefault();this.trigger('submitBefore',event);if(!this.formIsValid())return false;var data=this.getFormData();LC.resources.pluginListener('onAddProduct',event,data);var submitUrl='';if(this.linkedSectionId>0){submitUrl=LC.global.routePaths.BASKET_INTERNAL_ADD_LINKED;}else{submitUrl=LC.global.routePaths.BASKET_INTERNAL_ADD_PRODUCT;}
$.post(submitUrl,{data:JSON.stringify(data)},this.callback,'json');this.el.$buyFormSubmit.prop('disabled',true);this.trigger('submitCallback',event);},formIsValid:function(){if(!this.el.$form.isValid())return false;if(this.el.$gridCombinationsType&&this.el.$gridCombinationsType.val()=='buy'){var sumCombination=0;this.el.$gridCombinations.each(function(index,el){sumCombination+=parseInt($(el).val());});if(sumCombination===0)return false;}
return true;},callback:function(data){this.trigger('callbackBefore',data.data);var page=$('body').data('lc-page');if(data.data.response.success){if(this.linkedSectionId>0&&(page==='checkoutBasket'||page==='checkoutPaymentAndShipping')){$('html, body').animate({scrollTop:0},'slow',function(){window.location.reload(true);});}else{LC.miniBasket.reload();LC.dataEvents.reloadCustomize();}}else{LC.notify(data.data.response.message,{type:'danger'});}
this.enabledButtons.prop('disabled',false);if(this.el.$gridCombinations&&this.el.$gridCombinations.length>0){var qtText='quantity-';this.el.$gridCombinations.each(function(index,el){var inputData=JSON.parse($(el).attr('name').substring(qtText.length));this.updateCombinationsFields([inputData.productHash],parseInt($(el).val()));}.bind(this));totalProdsInBasket=this.getCombinationsFormTotalQuantity();this.updateCombinationsFormType(totalProdsInBasket);}
this.trigger('callback',data.data);if(LC.config.showModalBasket&&(LC.global.settings.isMobile===true||window.innerWidth<MEDIA_MOBILE)){var modalContent='';if(data.data.stockLock){modalContent+=`<div class="basketCountdown" data-lc-basket-expires='{"expires": "${data.data.stockLock.expires}"}'>
                         <div class="active">${LC.global.languageSheet.lockedStockRemainingTimePopup}</div>
                         <div class="expired">${LC.global.languageSheet.lockedStockExpiredTimePopUp}</div>
                     </div>`;}
modalContent+=`<div id="modalBasketButtons">
                     <a href="${LC.global.routePaths.CHECKOUT_BASKET}" class="modalBasketEndOrder ${BTN_PRIMARY_CLASS}">${LC.global.languageSheet.basketEndOrder}</a>
                     <a data-dismiss="modal" data-bs-dismiss="modal" class="modalBasketContinueShopping ${BTN_SECONDARY_CLASS}">${LC.global.languageSheet.basketContinueShopping}</a>
                     <a href="${LC.global.routePaths.USER}" class="modalBasketMyAccount ${BTN_SECONDARY_CLASS}">${LC.global.languageSheet.myAccount}</a>
                 </div>`;this.el.$buyFormSubmit.box({uid:'mobileBasketModal',source:modalContent,showFooter:false,triggerOnClick:false,type:'html',size:'small',});}},updateCombinationsFields:function(hashes,value){if(hashes.length){$('[id="buyForm'+this.data.id+'"]').each(function(index,buyForm){var qtText='quantity-';if(buyForm.module.el.$gridCombinations.length){buyForm.module.el.$gridCombinations.each(function(index,inputCombination){var $inputCombination=$(inputCombination);var hash=$inputCombination.data('lcProductHash');if($.inArray(hash,hashes)!=-1){var inputData=JSON.parse($inputCombination.attr('name').substring(qtText.length));inputData.quantity=value;$inputCombination.attr('name',qtText+JSON.stringify(inputData));$inputCombination.val(value);}});}});}},getCombinationsFormTotalQuantity:function(){var totalQuantity=0;this.el.$gridCombinations.each(function(i,e){totalQuantity+=parseInt($(e).val());});return totalQuantity;},updateCombinationsFormType:function(totalProdsInBasket){var getCombinationsFormType=function(totalProdsInBasket){if(totalProdsInBasket>0)return'update';return'buy';};if(totalProdsInBasket==null){totalProdsInBasket=this.getCombinationsFormTotalQuantity($('#buyForm'+this.data.id).get(0));}
$('[id="buyForm'+this.data.id+'"]').each(function(index,buyForm){if(buyForm.module.el.$gridCombinationsType){buyForm.module.el.$gridCombinationsType.val(getCombinationsFormType(totalProdsInBasket));buyForm.module.onChange();}});},attachmentFields:function(element){var me=this;this.target=element;if(!this.target)return;this.options={};this.options=JSON.parse(element.attr('data-options'));this.fieldName=element.attr('data-option-value');this.parseFile=function(field){var files=field.files;if(files.length>0){var options=$(field).closest('.lcProductOptionAttachment').data('options');if(files[0].size>(options.maxSize*1024*1000)){LC.notify(LC.global.languageSheet.attachFileMaxSize.replace('{{maxSize}}',options.maxSize),{type:'danger'});$(field).val('');$(field).closest('.productOption').find('input.productOptionAttachmentHiddenValue').val('');}else{var reader=new FileReader();reader.readAsDataURL(files[0]);reader.onload=function(){var optionValue={extension:files[0].name.split('.').pop(),fileName:files[0].name,value:reader.result};$(field).closest('.productOption').find('input.productOptionAttachmentHiddenValue').val(JSON.stringify(optionValue));};reader.onerror=function(error){$(field).val('');$(field).closest('.productOption').find('input.productOptionAttachmentHiddenValue').val('');LC.notify(LC.global.languageSheet.attachFileError.replace('{{maxSize}}',options.maxSize),{type:'danger'});};}}}},clearComparisonTable:function($trigger){var $comparisonTableItem=$trigger.parents('[data-lc-product-comparison-item]');if($comparisonTableItem.length){var productId=$comparisonTableItem.data('product');var $table=$('#comparison-table');$table.find(`[data-lc-product-comparison-item="${productId}"]`).fadeOut('slow',function(){this.remove();if($table.find('[data-lc-product-comparison-item]').length===0){$table.before(`<div class="empty-text">${LC.global.languageSheet.noProductsInComparison}</div>`);$table.remove();}});}},pseudoSubmits:function(){this.el.$pseudoSubmits.on('click',function(event){event.preventDefault();this.custom_callback=function(){$('html,body').animate({scrollTop:0},'slow',function(){window.location.reload(true);});};this.submit(event);}.bind(this));},},LC.buyFormProperties);LC.AddToNewShoppingListForm=LC.Form.extend({name:'addToNewShoppingListForm',initialize:function(){this.el.$form.find('button[type="submit"]').prop('disabled',false);},submit:function(event){event.preventDefault();this.el.$form.find('button[type="submit"]').prop('disabled',true);this.superForm('submit',event);},callback:function(response){if(!this.trigger('callbackSubsitute')){this.trigger('callbackBefore');if(response.data.response.success===1){LC.global.session.shoppingLists.push(response.data.data);$('#'+this.el.$form.attr('data-lc-uidModal')).attr('data-lc-new-list',JSON.stringify(response.data.data));$('#'+this.el.$form.attr('data-lc-uidModal')).modal('hide');this.el.$form.find('button[type="submit"]').prop('disabled',false);this.el.form.reset();}else{this.showMessage(response.data.response.message,'danger');}
this.trigger('callback',response);}},});LC.LoginForm=LC.Form.extend({name:'loginForm',initialize:function(){let lcUserWarnings=this.el.$form.data('lc-user-warnings'),userWarnings=(lcUserWarnings&&lcUserWarnings.length>0)?lcUserWarnings.split(","):[];if(userWarnings.length>0){let modalId='modalVerifyUser',modalClass='verifyUser',message='';if(userWarnings.indexOf('USER_NOT_VERIFIED')!==-1){message=LC.global.languageSheet.lblGenericWaitForEmailVerification;}else if(userWarnings.indexOf('USER_NOT_ACTIVED')!==-1){message=LC.global.languageSheet.lblGenericWaitForActivation;}
var boxMainDiv=$('<div/>',{class:'question '+modalId+' '+modalClass,html:'<div class="questionText '+modalClass+'Text">'+message+'</div>',});$('#userVerifyAccountFormContainer #verifyAccountForm').appendTo(boxMainDiv);boxMainDiv.box({uid:modalId,showFooter:false,type:'internal',size:'medium',triggerOnClick:false,});}},callback:function(response){if(!this.trigger('callbackSubsitute')){this.trigger('callbackBefore');if(response.data.response.success===1){if(response.data.data.warning.length>0){this.showMessage(response.data.data.warning,'danger');}else{LC.resources.pluginListener('onUserLogin',this.el.$form);if(response.data.data.redirect){window.location.href=response.data.data.redirect;}else{window.location.reload(true);}}}else{this.showMessage(response.data.response.message,'danger');}
this.trigger('callback',response);}},});LC.ProductSubscribeStockForm=LC.Form.extend({name:'productSubscribeStockForm',options:{},initialize:function(form){this.trigger('initOptionsBefore');this.data=this.el.$form.data('productStock');this.initElements();this.trigger('initializeCallback');$.validate(LC.validateFormConf);},initElements:function(){this.trigger('initOptionsBefore');this.el.$submit=this.el.$form.find('[type="submit"]');this.el.$email=this.el.$form.find('[name="email"]');this.el.$combinationId=this.el.$form.find('[name="combinationId"]');this.trigger('initOptionsCallback');},getFormValues:function(){this.trigger('getFormValuesBefore');var formValues={};formValues.email=this.el.$email.val();formValues.combinationId=this.el.$combinationId.val();this.trigger('getFormValuesCallback');return formValues;},getFormData:function(){const formDataValues=this.getFormValues();return{combinationId:formDataValues.combinationId,email:formDataValues.email,captchaToken:this.inputCaptchaToken.val()};},submit:function(event){event.preventDefault();this.trigger('submitBefore');if(this.setCaptchaToken(event))return;if(!this.el.$form.isValid()){return false;}
this.el.$submit.prop('disabled',true);var formData=this.getFormData();$.post(LC.global.routePaths.PRODUCT_INTERNAL_SUBSCRIBE_STOCK,{data:JSON.stringify(formData)},this.callback.bind(this),'json');this.trigger('submitCallback');},callback:function(data){this.el.$submit.prop('disabled',false);if(!data.data){return;}
this.showMessage(data.data.response.message,data.data.response.success==1?'success':'danger');$('#stockAlert').modal('hide');this.trigger('callback',data);}});LC.UserForm=LC.Form.extend({name:'userForm',userType:null,prefix:'user',initialize:function(){this.trigger('initializeBefore');var dateFields=this.el.$form.find('[data-datetimepicker]').each((index,el)=>{var $calendar=$(el),language=$calendar.data('language')?$calendar.data('language'):'en',format=$calendar.data('format'),startDate=$calendar.data('startdate'),endDate=$calendar.data('enddate'),weekstart=$calendar.data('weekstart');moment.locale(language,{week:{dow:weekstart}});$calendar.datetimepicker({locale:language,format:format?format:CALENDAR_PLUGIN_DATE_FORMAT,minDate:startDate?startDate:false,maxDate:endDate?endDate:false});$(el).on('dp.change blur',(e)=>{var $ctSubmitValue=this.el.$form.find('[name="'+$calendar.data('submit')+'"]');if(e.date){$ctSubmitValue.val(moment(e.date).format('YYYY-MM-DD'));}else{$ctSubmitValue.val('');}});});this.el.$customTagAttachment=this.el.$form.find('.lcCustomTagAttachment');if(this.el.$customTagAttachment.length)
this.attachmentFields(this.el.$customTagAttachment);var self=this;this.userType=this.el.$form.data('lc-user-type');var tabPane='#'+this.el.$form.data('lc-address')+'_tabPane_'+this.userType;this.el.$userTabPanes=this.el.$form.find('.tabPaneUserType');this.el.$userFieldElements=this.el.$form.find(tabPane+' .userFormFields .formField').not('.createAccountField');this.el.$shippingFieldElements=this.el.$form.find(tabPane+' .shippingFormFields .formField');var $useShippingAddressCheck=this.el.$form.find(tabPane+' .useShippingAddressCheck');this.el.$useShippingAddress=$useShippingAddressCheck.length?$useShippingAddressCheck:this.el.$form.find('.useShippingAddressCheck');this.el.$createAccountCheck=this.el.$form.find(tabPane+' .userFieldCreateAccountCheck');this.el.$createAccountFieldElements=this.el.$form.find(tabPane+' .createAccountField');this.el.$form.find('.formField').each(function(){if(typeof $(this).data('lc-disabled')==='undefined')
$(this).data('lc-disabled',$(this).prop('disabled'));});this.setUserType();this.el.$form.find('.userTypeNavTabs [data-toggle="tab"], .userTypeNavTabs [data-bs-toggle="tab"]').on('shown.bs.tab',function(event){self.el.$form.attr('data-lc-user-type',$(event.target).data('lc-user-type'));self.el.$form.data('lc-user-type',$(event.target).data('lc-user-type'));var $tabPane=$($(event.target).attr('href'));self.userType=self.el.$form.data('lc-user-type');self.el.$userFieldElements=$tabPane.find('.userFormFields .formField').not('.createAccountField');self.el.$shippingFieldElements=$tabPane.find('.shippingFormFields .formField');var $useShippingAddressCheck=$tabPane.find('.useShippingAddressCheck');self.el.$useShippingAddress=$useShippingAddressCheck.length?$useShippingAddressCheck:self.el.$form.find('.useShippingAddressCheck');self.el.$createAccountCheck=$tabPane.find('.userFieldCreateAccountCheck');self.el.$createAccountFieldElements=$tabPane.find('.createAccountField');self.setUserType();self.toggleCreateAccount(self.el.$createAccountCheck);self.toggleShippingAddress(self.el.$useShippingAddress,false);self.el.$useShippingAddress.on('change',function(event){self.toggleShippingAddress($(this),true);});self.el.$createAccountCheck.on('change',function(event){self.toggleCreateAccount($(this));});});if(this.el.$useShippingAddress.length){self.toggleShippingAddress(this.el.$useShippingAddress,false);}
this.el.$useShippingAddress.on('change',function(event){self.toggleShippingAddress($(this),true);});if(this.el.$createAccountCheck.length){self.toggleCreateAccount(this.el.$createAccountCheck);}
this.el.$createAccountCheck.on('change',function(event){self.toggleCreateAccount($(this));});this.subscribedField();},attachmentFields:function($elements){$elements.each((index,element)=>{let $element=$(element);$element.find('.new-attachment').click(function(event){$element.find('input.customTagAttachmentHiddenValue').val('');$element.find('.customTagAttachmentValue').show();$element.find('input[name="customTagAttachmentValue"]').removeAttr('disabled');$element.find('.customTagAttachmentButtons').hide();}.bind(this));$element.on("change",function(event){var files=event.target.files,fileNameRegex=new RegExp('^[À-ÿ\\w\\-. ]+$');if(files.length>0){var options=$(event.target).closest('.lcCustomTagAttachment').data('options');if(files[0].size>(options.maxSize*1024*1000)){LC.notify(LC.global.languageSheet.attachFileMaxSize.replace('{{maxSize}}',options.maxSize),{type:'danger'});$(event.target).val('');}else if(!fileNameRegex.test(files[0].name)){LC.notify(LC.global.languageSheet.attachFileRegexError,{type:'danger'});$(event.target).val('');}
else{var reader=new FileReader();reader.readAsDataURL(files[0]);reader.onload=function(){var optionValue={extension:files[0].name.split('.').pop(),fileName:files[0].name,value:reader.result};$(event.target).closest('.lcCustomTagAttachment').find('input.customTagAttachmentHiddenValue').val(JSON.stringify(optionValue));};reader.onerror=function(error){$(event.target).val('');$(event.target).closest('.lcCustomTagAttachment').find('input.customTagAttachmentHiddenValue').val('');LC.notify(LC.global.languageSheet.attachFileError.replace('{{maxSize}}',options.maxSize),{type:'danger'});};}}});});},subscribedField:function(){var $subscribedField=this.el.$form.find('[name="subscribed"]');if($subscribedField.prop("type")=='button'){$.post(LC.global.routePaths.USER_INTERNAL_NEWSLETTER,{data:$subscribedField.attr('data-lc')},this.subscribeCheckStatusCallback.bind(this,$subscribedField),'json');$subscribedField.click(function(event){var data=JSON.parse($subscribedField.attr('data-lc'));$.post(LC.global.routePaths.USER_INTERNAL_NEWSLETTER,{data:$subscribedField.attr('data-lc')},this.subscribedCallback.bind(this,data,$subscribedField),'json');}.bind(this));}else{$subscribedField.val($subscribedField.prop('checked')?1:0);$subscribedField.change(function(event){$(this).val($(this).prop('checked')?1:0);});}},subscribeCheckStatusCallback:function($subscribedField,response){var data=JSON.parse($subscribedField.attr('data-lc'));if(response.data.response.success){if(response.data.data.status=="SUBSCRIBED"){data.type='UNSUBSCRIBE';$subscribedField.html(LC.global.languageSheet.unsubscribe);}else{data.type='SUBSCRIBE';$subscribedField.html(LC.global.languageSheet.subscribe);}
$subscribedField.attr("data-lc",JSON.stringify(data));$subscribedField.attr('disabled',false);}
this.trigger('subscribeCheckStatusCallback',data,$subscribedField,response);},subscribedCallback:function(data,$subscribedField,response){if(response.data.response.success){if(response.data.data.status=="SUBSCRIBED"){data.type='UNSUBSCRIBE';$subscribedField.html(LC.global.languageSheet.unsubscribe);}else{data.type='SUBSCRIBE';$subscribedField.html(LC.global.languageSheet.subscribe);}
if(response.data.data.messageType=="SCRIPT"){eval(response.data.data.message);}else{this.showMessage(response.data.response.message,'success');}
$subscribedField.attr("data-lc",JSON.stringify(data));$subscribedField.attr('disabled',false);}else{this.showMessage(response.data.response.message,'danger');}
this.trigger('subscribedCallback',data,$subscribedField,response);},setUserType:function(){this.el.$form.find('[name*="userType"]').val(this.userType);this.el.$form.find('.userFormFields .formField').not('.createAccountField').not(this.el.$userFieldElements).prop('disabled',true);this.el.$form.find('.shippingFormFields .formField').not(this.el.$shippingFieldElements).prop('disabled',true);this.el.$form.find('.createAccountField').not(this.el.$createAccountFieldElements).prop('disabled',true);this.el.$form.find('.locationField').not('[name^="'+this.userType+'"]').filter('input[type="hidden"]').prop('disabled',true);this.el.$form.find('.locationField[name^="'+this.userType+'"]').filter('input[type="hidden"]').prop('disabled',false);this.el.$userFieldElements.prop('disabled',function(){return $(this).data('lc-disabled');});if(this.el.$useShippingAddress.length&&this.el.$useShippingAddress.prop('checked')===true){this.el.$shippingFieldElements.prop('disabled',function(){return $(this).data('lc-disabled');});}else{this.el.$shippingFieldElements.prop('disabled',true);}
if((this.el.$createAccountCheck.length&&this.el.$createAccountCheck.prop('checked')===true)||this.el.$createAccountCheck.length==0){this.el.$createAccountFieldElements.prop('disabled',function(){return $(this).data('lc-disabled');});}
this.el.$form.find('.addressUserField').each((index,el)=>{this.initLocations($(el));});this.el.$form.find('.addressUserCountryField').each((index,el)=>{this.initCountryField($(el));});if(!themeConfiguration?.commerce?.allowDifferentCountriesOnBillingAndShippingAddress){let $parent=this.el.$form.find('select[name="'+this.userType+'_user_country"]').closest('.addressUserField');checkAllowDifferentCountriesOnBillingAndShippingAddress($parent);}},initLocations:function($el){var $countrySelect=$el.find('.countryField');if(!$countrySelect.length)return;var $locationInput=$('input[name="'+$countrySelect.attr('name').replace('country','locationList')+'"]');if(!$countrySelect.prop('disabled')&&!$countrySelect.prop('lc-init')){$countrySelect.prop('lc-init',true);if($locationInput.length&&$locationInput.val()>0){loadLocations.bind($countrySelect)($countrySelect.val(),$locationInput.val());$locationInput.remove();}else{loadLocations.bind($countrySelect)($countrySelect.val()?$countrySelect.val():LC.global.session.countryId);}}},initCountryField:function($el){if(!$el.prop('disabled')&&!$el.prop('lc-init')){$el.prop('lc-init',true);changeCountryFields.bind($el)(LC.global.session.countryId,true);}},toggleShippingAddress:function($useShippingAddress,$selectAddressBookAction){var $shippingFormFields=$useShippingAddress.closest('.tabPaneUserType').find('.shippingFormFields'),$shippingFormFieldsStartSeparator=$('#shippingAddressContainerStartSectionSeparator'),$shippingFormFieldsEndSeparator=$('#shippingAddressContainerEndSectionSeparator');if(!$shippingFormFields.length)
$shippingFormFields=$('#shippingAddressContainer');if($useShippingAddress.prop('checked')){if($selectAddressBookAction){LC.addressBookForm.selectAddressBook(1,'shipping','check_use_shipping');}
$useShippingAddress.val(1);$shippingFormFields.removeClass('shippingFormFieldsDisabled');$shippingFormFieldsStartSeparator.removeClass('shippingFormFieldsDisabled');$shippingFormFieldsEndSeparator.removeClass('shippingFormFieldsDisabled');$shippingFormFields.find('.formField').prop('disabled',function(){return $(this).data('lc-disabled');});this.initLocations($shippingFormFields);this.initCountryField($shippingFormFields);}else{if($selectAddressBookAction){LC.addressBookForm.selectAddressBook(0,'shipping','check_use_shipping');}
$useShippingAddress.val(0);$shippingFormFields.addClass('shippingFormFieldsDisabled');$shippingFormFieldsStartSeparator.addClass('shippingFormFieldsDisabled');$shippingFormFieldsEndSeparator.addClass('shippingFormFieldsDisabled');$shippingFormFields.find('.formField').prop('disabled',true);}},disableForm:function(){this.el.$form.find('input:not([name="editable"], [name="callback"], [name="formContext"])').prop('disabled','disabled').addClass('disabled');this.el.$form.find('select').prop('disabled','disabled').addClass('disabled');this.el.$form.find('[data-lc-function="editAddressBook"]').remove();this.el.$form.find('[data-lc-function="addAddressBook"]').remove();this.el.$form.find('.legalTextLinks').remove();this.el.$form.find('.basketButtons').remove();},toggleCreateAccount:function($check){if($check.length){if($check.prop('checked')){this.el.$createAccountFieldElements.prop('disabled',function(){return $(this).data('lc-disabled');}).closest('.createAccountFieldGroup').removeClass('createAccountFieldGroupHide');this.el.$form.find('[name="'+$check.data('lc-target')+'"]').val(1);}else{this.el.$createAccountFieldElements.prop('disabled',true).closest('.createAccountFieldGroup').addClass('createAccountFieldGroupHide');this.el.$form.find('[name="'+$check.data('lc-target')+'"]').val(0);}}},setValidationData:function($formField,required){var dataValidation=$formField.data('validation')||'';var dataValidationTypes=$formField.data('validationTypes');var arrDataValidationTypes=[];if(dataValidationTypes&&typeof dataValidationTypes=='object')
for(var key in dataValidationTypes)
arrDataValidationTypes.push(dataValidationTypes[key].toLowerCase());else var arrDataValidationTypes=[];var arrElements=arrDataValidationTypes.concat(['email','phone','vat','vat_es']);var arrValidation=required?['required']:[];for(var j=0;j<arrElements.length;j++){if(dataValidation.toLowerCase().indexOf(arrElements[j])>=0)arrValidation.push(arrElements[j]);}
return arrValidation.join(',');},callback:function(response){this.el.$form.find('[type="submit"]').attr('disabled',true);this.trigger('callbackBefore',response);var message=LC.global.languageSheet.error,success=0;if(response&&response.data.response){message=response.data.response.message;success=response.data.response.success;}
if(success){if(Object.hasOwn(response.data.data.billingValidate,'valid')&&response.data.data.billingValidate.valid===false||Object.hasOwn(response.data.data.shippingValidate,'valid')&&response.data.data.shippingValidate.valid===false){let type='',validationData=null,$addressInput=null,validAddresses='';if(response.data.data.billingValidate.valid===false){type='user';validationData=response.data.data.billingValidate;}else{type='shipping';validationData=response.data.data.shippingValidate;}
if(type=='user'){$addressInput=this.el.$form.find('[name="address"]');$addressInput=this.el.$form.find(`input[name="address"], input[name="${this.userType}_${type}_address"]`);}else{$addressInput=this.el.$form.find(`input[name="${this.userType}_${type}_address"]`);}
$addressInput.parent().addClass('has-error');if(validationData.validAddresses.length){validAddresses+='<div class="validAddress">';validAddresses+=`<div class="validAddress validAddressTitle">${LC.global.languageSheet.userAddressSelectValidAdress}</div>`;validationData.validAddresses.forEach(validAddress=>{validAddresses+='<div type="button" class="selectValidAddress" >'+validAddress.address+'</div>';});validAddresses+='</div>';$addressInput.after(validAddresses);this.el.$form.find('.selectValidAddress').on('click',(event)=>{$addressInput.val(event.target.innerText);this.el.$form.find('.validAddress').remove();this.el.$form.submit();});this.showMessage(LC.global.languageSheet.userAddressInvalid,'danger');}else{let validationMessage='';validationData.messages.forEach(message=>{validationMessage+=message.detail+'<br>';})
this.showMessage(validationMessage,'danger');}}else{this.showMessage(message,'success');if(response.data.data.redirect&&response.data.data.redirect.length){window.location=response.data.data.redirect;}}}else{var mainAddressError=false,shippingAddressError=false;this.el.$form.find('input[name="billingAddress"]').parent('div.billingAddress').removeClass('has-error');this.el.$form.find('input[name="shippingAddress"]').parent('div.shippingAddress').removeClass('has-error');if(mainAddressError){this.el.$form.find('input[name="billingAddress"]:checked').parent('div.billingAddress').addClass('has-error');}else if(shippingAddressError){this.el.$form.find('input[name="shippingAddress"]:checked').parent('div.shippingAddress').addClass('has-error');}
this.showMessage(message,'danger');}
this.el.$form.find('[type="submit"]').attr('disabled',false);LC.resources.pluginListener('onUserSignUp',this.el.$form);this.trigger('callback',response);},validateAdditionalShippings:function(form){if(form.find('input[name="useShippingAddress"]').attr('value')==1&&form.find('.shippingAddress.addressBookActive').length==0){this.showMessage(LC.global.languageSheet.insertOneAddress,'danger');return false;}
return true;},submit:function(event){if(!this.validateAdditionalShippings(this.el.$form))return false;if(this.el.$form.find('.address-complete:visible').length!=this.el.$form.find('.userFieldGroupCountry:visible').length){var $result=this.el.$form.find('.userFieldGroupCountry:visible').not('.address-complete:visible');$result.addClass('address-incomplete');$([document.documentElement,document.body]).animate({scrollTop:$result.offset().top-200},1000);return false;}
if(this.el.form.method.toLowerCase()=='get')return;event.preventDefault();if(this.setCaptchaToken(event))return;if(!this.el.$form.isValid())return false;var arrDataForm=this.el.$form.serializeArray();if(this.el.$form.find('[name="subscribed"]').length&&this.el.$form.find('[name="subscribed"]').val()==0){arrDataForm.push({name:"subscribed",value:"0"});}
this.dataForm={};for(var i=0;i<arrDataForm.length;i++){if(!(arrDataForm[i].name in this.dataForm))this.dataForm[arrDataForm[i].name]=[];this.dataForm[arrDataForm[i].name].push(arrDataForm[i].value);}
for(var i in this.dataForm)this.dataForm[i]=this.dataForm[i].join();this.el.$form.find('button[type="submit"], input[type="submit"]').attr('disabled',true);if(this.el.form.method.toLowerCase()=='post')
$.post(this.el.form.action,{data:JSON.stringify(this.dataForm),},this.onReceive.bind(this),'json').fail(this.onFail.bind(this)).always(this.onComplete(this));}},LC.userFormResources);LC.AddressForm=LC.Form.extend({name:'addressForm',initialize:function(){this.initializeForm();}},LC.addressBookForm);LC.BillingAddressBookForm=LC.billingAddressBookForm=LC.Form.extend({name:'billingAddressBookForm',prefix:'billing',initialize:function(){this.initializeBook();}},LC.addressBookForm);LC.ShippingAddressBookForm=LC.shippingAddressBookForm=LC.Form.extend({name:'shippingAddressBookForm',prefix:'shipping',initialize:function(){this.initializeBook();}},LC.addressBookForm);LC.ContactForm=LC.Form.extend({name:'contactForm',callback:function(data){this.message='';this.success=0;if(!data.data){this.message=data.data.status.message?data.data.status.message:'Error';this.success=0;}else{this.message=data.data.response.message;this.success=data.data.response.success?data.data.response.success:0;if(this.success){this.el.form.reset();}
this.showMessage(this.message,this.success?'success':'danger');}
this.trigger('callback');},onComplete:function(data){},});LC.ChangePasswordForm=LC.Form.extend({name:'changePasswordForm',callback:function(response){this.showMessage(response.data.response.message,response.data.response.success&&response.data.response.success===1?'success':'danger');if(response.data.response.success&&response.data.response.success===1)
setTimeout(function(){window.location=LC.global.routePaths.USER;},3000);},});LC.LostPasswordForm=LC.Form.extend({name:'lostPasswordForm',callback:function(response){if(!this.trigger('callback',response)){this.showMessage(response.data.response.message,response.data.response.success&&response.data.response.success===1?'success':'danger');if(response?.data?.data?.redirect?.length)
setTimeout(function(){window.location=response.data.data.redirect;},3000);}},});LC.DeleteAccountForm=LC.Form.extend({name:'deleteAccountForm',callback:function(response){this.showMessage(response.data.response.message,response.data.response.success&&response.data.response.success===1?'success':'danger');if(response.data.response.success&&response.data.response.success===1)
setTimeout(function(){window.location=LC.global.routePaths.USER;},1000);},});LC.SearchForm=LC.Form.extend({name:'searchForm',initialize:function(){},submit:function(event,el){event.preventDefault();var action=this.el.$form[0].action;var data={};var arrDataForm=this.el.$form.serializeArray();var minCharacters=this.el.$form.data('min-characters');for(var i=0;i<arrDataForm.length;i++){if(arrDataForm[i].name=='q'){if(arrDataForm[i].value.length<minCharacters&&!arrDataForm[i].value.match('[^\x00-\x7F]'))
return false;data.q=arrDataForm[i].value;}else{data[arrDataForm[i].name]=arrDataForm[i].value;}}
var dataSearch=this.el.$form.data('search');data.searchProducts=dataSearch.products;data.searchCategories=dataSearch.categories;data.searchBlog=dataSearch.blog;data.searchPages=dataSearch.pages;data.searchNews=dataSearch.news;data.minCharacters=minCharacters;window.location=action+(!$.isEmptyObject(data)?'?'+$.param(data):'');return false;},});LC.ProductAddCommentForm=LC.Form.extend({initialize:function(){this.maxRating=5;this.minRating=1;this.rating();},rating:function(){this.el.$rating=this.el.$form.find('input[name="rating"]');this.el.$ratingContainer=this.el.$form.find('.lcRating.editable');this.el.$ratingText=this.el.$form.find('#valorationValue');this.el.icon=this.el.$ratingContainer.find('.starIcon').first().prop('outerHTML');this.rating=parseFloat(this.el.$rating.val());if(this.rating>this.maxRating)this.rating=this.maxRating;if(this.rating<this.minRating)this.rating=this.minRating;this.el.$ratingText.text(this.rating);this.el.$ratingContainer.html('');for(var i=0;i<this.maxRating;i++){this.el.$ratingContainer.append($(this.el.icon).attr({class:i<this.maxRating-this.rating?'starIcon inactive':'starIcon',rel:i}));}
this.el.$ratingContainer.find('.starIcon').click(function(event){var starPosition=parseInt($(event.currentTarget).attr('rel'));this.el.$ratingContainer.find('.starIcon').removeClass('inactive');for(var i=0;i<starPosition;i++)$(this.el.$ratingContainer.find('.starIcon')[i]).addClass('inactive');this.rating=Math.abs(starPosition-this.maxRating);this.el.$rating.val(this.rating);this.el.$ratingText.text(this.rating);}.bind(this));}});LC.PostAddCommentForm=LC.Form.extend({initialize:function(form){},callback:function(data){let message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});this.el.$form.find('textarea[name=comment]').val('');}else{LC.notify(message,{type:'danger'});}},});LC.CheckoutForm=LC.Form.extend({name:'checkoutForm',options:{},updateBasketRows:{},enabledRecaulculateBasket:false,initialize:function(){this.trigger('initializeBefore');this.el.quantityElements=this.el.$form.find('input.basketQuantity:text');this.el.quantityElements.change(this.onChangeQuantity.bind(this));this.el.deleteElements=this.el.$form.find('[data-lc-basketdeleterow],[data-lc-basketdeleterows]');this.el.deleteElements.click(this.onClickDelete.bind(this));this.el.saveForLaterRowElements=this.el.$form.find('[data-lc-basketsaveforlaterrow]');this.el.saveForLaterRowElements.click(this.onClickSaveForLater.bind(this));this.initOptions();this.initActions();this.initVoucher();this.initDeleteVoucher();this.initRewardPoints();this.ticketCodesEmpty();this.el.$form.find('#basketRecalculate').prop('disabled',true);this.el.paymentSystemSelectors=$('.basketSelectorPaymentInput');this.el.shippingSection=$('input.shippingTypeSelector:radio, button.savePickingSelectionButton');this.el.basketSelectors=this.el.paymentSystemSelectors.add(this.el.shippingSection);this.initPayment();this.initShipping();this.initFapiao();this.initCalendar();this.el.$customTagAttachment=this.el.$form.find('.lcCustomTagAttachment');if(this.el.$customTagAttachment.length)
this.attachmentFields(this.el.$customTagAttachment);this.trigger('initializeCallback');var self=this;this.submitButton=this.el.$form.find('button[type="submit"], input[type="submit"]');this.submitButton.on('click',self.onSubmit.bind(self));},attachmentFields:function($elements){$elements.each((index,element)=>{let $element=$(element);$element.find('.new-attachment').click(function(event){$element.find('input.customTagAttachmentHiddenValue').val('');$element.find('.customTagAttachmentValue').show();$element.find('input[name="customTagAttachmentValue"]').removeAttr('disabled');$element.find('.customTagAttachmentButtons').hide();$element.parent().find('.form-check-label').show();});$element.on("change",function(event){var files=event.target.files,fileNameRegex=new RegExp('^[À-ÿ\\w\\-. ]+$');if(files.length>0){var options=$(event.target).closest('.lcCustomTagAttachment').data('options');if(files[0].size>(options.maxSize*1024*1000)){LC.notify(LC.global.languageSheet.attachFileMaxSize.replace('{{maxSize}}',options.maxSize),{type:'danger'});$(event.target).val('');}else if(!fileNameRegex.test(files[0].name)){LC.notify(LC.global.languageSheet.attachFileRegexError,{type:'danger'});$(event.target).val('');}
else{var reader=new FileReader();reader.readAsDataURL(files[0]);reader.onload=function(){var optionValue={extension:files[0].name.split('.').pop(),fileName:files[0].name,value:reader.result};$(event.target).closest('.lcCustomTagAttachment').find('input.customTagAttachmentHiddenValue').val(JSON.stringify(optionValue));};reader.onerror=function(error){$(event.target).val('');$(event.target).closest('.lcCustomTagAttachment').find('input.customTagAttachmentHiddenValue').val('');LC.notify(LC.global.languageSheet.attachFileError.replace('{{maxSize}}',options.maxSize),{type:'danger'});};}}});});},initOptions:function(){this.trigger('initOptionsBefore');this.el.$options=this.el.$form.find('select.productOptionSelectValue, input.productOptionCheckboxValue, input.productOptionBooleanValue, input.productOptionTextValue, textarea.productOptionLongTextValue');this.el.$options.change(this.onChangeOption.bind(this));this.trigger('initOptionsCallback');},initActions:function(){this.el.$form.find('#basketContinueShopping').click(this.onClickContinueShopping.bind(this));this.el.$form.find('#basketClear').click(this.onClickClearBasket.bind(this));},initVoucher:function(){this.el.voucherButton=$('#voucherButton');this.el.voucherField=$('#voucherField');if(this.el.voucherButton.length&&this.el.voucherField.length){this.el.voucherButton.click(this.onClickVoucherButton.bind(this));this.el.voucherField.keypress(this.onKeypressVoucherField.bind(this));}},initRewardPoints:function(){this.el.$form.find('.rewardPointButton').each(function(index,el){el.addEventListener('click',this.redeemRewardPoints.bind(this,el));el.disabled=false;}.bind(this));},initPayment:function(){LC.resources.pluginListener('initializePaymentsBefore',this.el.$form,false);this.el.paymentSystemSelectors.each(function(index,el){if(!$(el).data('lc-express-checkout')){el.addEventListener('click',this.setPaymentSystem.bind(this,el.value));el.disabled=false;}}.bind(this));LC.resources.pluginListener('initializePaymentsCallback',this.el.$form,false);},initShipping:function(){this.el.shippingSection.each(function(index,el){el.addEventListener('click',this.setShippingSection.bind(this,el));el.disabled=false;}.bind(this));},initFapiao:function(){if($('#inputFapiaoActived').is(':checked')){$('#inputInvoicenameFapiao').attr('data-validation','required');$('#selectInvoicenameFapiao').attr('data-validation','required');}else{$('#inputInvoicenameFapiao').attr('data-validation','');$('#selectInvoicenameFapiao').attr('data-validation','');}},initCalendar:function(){this.el.$form.find('[data-datetimepicker]').each((index,el)=>{let $calendar=$(el),language=$calendar.data('language')?$calendar.data('language'):'en',format=$calendar.data('format'),startDate=$calendar.data('startdate'),endDate=$calendar.data('enddate'),weekstart=$calendar.data('weekstart');moment.locale(language,{week:{dow:weekstart}});$calendar.datetimepicker({locale:language,format:format?format:CALENDAR_PLUGIN_DATE_FORMAT,minDate:startDate?startDate:false,maxDate:endDate?endDate:false});$(el).on('dp.change',(e)=>{var $inputSubmitValue=this.el.$form.find('[name="'+$calendar.data('submit')+'"]');if(e.date){$inputSubmitValue.val(moment(e.date).format('YYYY-MM-DD'));}else{$inputSubmitValue.val('');}});});},initDeleteVoucher:function(){var deleteVoucherCode=$('span.deleteVoucherCode');deleteVoucherCode.each(function(index,el){$(el).on('click',this.deleteVoucherCode.bind(this,el));}.bind(this));},onClickContinueShopping:function(event){$.post(LC.global.routePaths.CHECKOUT_INTERNAL_CONTINUE_SHOPPING,this.el.$form.serializeArray(),this.continueShoppingCallback,'json');},continueShoppingCallback:function(response){var data=response.data;if(data&&data.response&&data.response.success==1){if(data.data&&data.data.redirect){window.location=data.data.redirect;}}},onClickClearBasket:function(event){$.post(LC.global.routePaths.CHECKOUT_INTERNAL_CLEAR_BASKET,this.clearBasketCallback,'json');},clearBasketCallback:function(response){var data=response.data;if(data&&data.response&&data.response.success==1){window.location.reload(true);}},recalculateBasket:function(event){if(this.enabledRecaulculateBasket){var data=this.updateBasketRows;this.tmpProducts=globalThis?.lcCommerceSession?.basket?.rows;if(this.tmpProducts){LC.dataEvents.changeQuantityEvent(this.tmpProducts,data);this.tmpProducts=[];}
$.post(LC.global.routePaths.CHECKOUT_INTERNAL_RECALCULATE_BASKET,{data:JSON.stringify({data:data}),},this.recalculateBasketCallback,'json');}},recalculateBasketCallback:function(response){var data=response.data;if(data&&data.response&&data.response.success==1){this.updateBasketRows={};window.location.reload(true);}},deleteRowCallback:function(response){var data=response.data;if(data&&data.response&&data.response.success==1){window.location.reload(true);}
this.trigger('onDeleteRowCallback',response);},saveForLaterRowCallback:function(response){var data=response.data;if(data?.response?.success==1&&!response.data.data.incidences.length){window.location.reload(true);}else{this.showMessage(response.data.response.message,'danger');}},ticketCodesEmpty:function(){var discountsLen=$('.ticketCodesGroup .outputDiscountName').length;if(discountsLen==0){$('.ticketCodesTitle').remove();}},onChangeOption:function(event){if(!this.trigger('onChangeOption')){this.trigger('onChangeOptionBefore');this.onChangeActions();this.trigger('onChangeOptionCallback');}},onChangeQuantity:function(eventData){if(!this.trigger('onChangeOption')){this.trigger('onChangeOptionBefore');this.onChangeActions();let name=$(eventData.target).attr('name').replace('quantity','');if(name.length==0){name='grid'+$(eventData.target).data('lc-grid-combination-id');}
this.updateBasketRows[name]={type:$(eventData.target).data('lc-row-type'),quantity:$(eventData.target).val(),options:$(eventData.target).data('lc-row-options'),id:$(eventData.target).closest('[data-lc-grid-product-id]').data('lc-grid-product-id'),};this.trigger('onChangeOptionCallback');}},onClickDelete:function(event){event.preventDefault();let hash=$(event.delegateTarget).data('lcBasketdeleterow'),hashes=$(event.delegateTarget).data('lcBasketdeleterows'),data='',path='';if(hash){data=JSON.stringify({hash:hash});path=LC.global.routePaths.BASKET_INTERNAL_DELETE_ROW;}else{data=JSON.stringify({hashes:hashes});path=LC.global.routePaths.BASKET_INTERNAL_DELETE_ROWS;}
$.post(path,{data:data},this.deleteRowCallback.bind(this),'json');},onClickSaveForLater:function(event){event.preventDefault();var hash=$(event.delegateTarget).data('lcBasketsaveforlaterrow');$.post(LC.global.routePaths.BASKET_INTERNAL_SAVE_FOR_LATER_ROW,{data:JSON.stringify({hash:hash}),},(response)=>this.saveForLaterRowCallback(response),'json');},onChangeActions:function(){this.showChangeMessage();this.enableRecalculateBasket();},enableRecalculateBasket:function(){$('#basketRecalculate').prop('disabled',false);this.enabledRecaulculateBasket=true;},showChangeMessage:function(){var $formMessage=$('form[data-lc-form="'+this.name+'"] .form-message');$formMessage.addClass('alert alert-info');$formMessage.html(LC.global.languageSheet.changeOptionBasket);},onSubmit:function(event){event.preventDefault();if($(event.target).val()==='recalculate'){this.recalculateBasket(event);}else{$(event.target).prop('disabled',true);this.el.$form.prepend($('<input/>',{type:'hidden',name:'action',value:$(event.target).val()}));if(this.el.$form.isValid()){this.el.$form.preventSubmit=false;LC.resources.pluginListener('beforeSubmitEndOrder',event,this.el.$form,false);if(!this.el.$form.preventSubmit){this.fillDataForm();$.post(LC.global.routePaths.CHECKOUT_INTERNAL_NEXT_STEP,{data:JSON.stringify($.extend(this.dataForm,{updateBasketRows:this.updateBasketRows}))},(response)=>{if(response.data.response.success===1){window.location=response.data.data.redirect;}else{this.showMessage(response.data.response.message,'danger');}
$(event.target).prop('disabled',false);},'json');}}else{$(event.target).prop('disabled',false);}}},fillDataForm:function(){var arrDataForm=this.el.$form.serializeArray();this.dataForm={};for(var i=0;i<arrDataForm.length;i++){if(!(arrDataForm[i].name in this.dataForm))this.dataForm[arrDataForm[i].name]=[];this.dataForm[arrDataForm[i].name].push(arrDataForm[i].value);}
for(var i in this.dataForm)this.dataForm[i]=this.dataForm[i].join();},submitCurrentData:function(){this.fillDataForm();$.post(LC.global.routePaths.CHECKOUT_INTERNAL_NEXT_STEP,{data:JSON.stringify($.extend(this.dataForm,{updateBasketRows:this.updateBasketRows}))},(response)=>{if(response.data.response.success===1){window.location.reload(true);}else{this.showMessage(response.data.response.message,'danger');setTimeout(function(){window.location.reload(true);},2000);}},'json');},onClickVoucherButton:function(event){var field=$('#voucherField');this.addVoucher(field.val());},onKeypressVoucherField:function(event){if(event.keyCode==13){var field=$('#voucherField');this.addVoucher(field.val());return false;}},addVoucher:function(code){if(code.length>0){var callbackAddVoucher=function(response){if(response.data.response.success===1){this.showMessage(response.data.response.message,'success');this.submitCurrentData();}else{this.showMessage(response.data.response.message,'danger');}}.bind(this);var jsonToSend={code:encodeURI(code)};$.post(LC.global.routePaths.BASKET_INTERNAL_ADD_VOUCHER,{data:JSON.stringify(jsonToSend),},callbackAddVoucher,'json');}},deleteVoucherCode:function(el){var data=$(el).data('lcData');var callbackDeleteVoucher=function(response){if(response.data.response.success===1){this.showMessage(response.data.response.message,'success');this.submitCurrentData();}else{this.showMessage(response.data.response.message,'danger');}}.bind(this);$.post(LC.global.routePaths.BASKET_INTERNAL_DELETE_VOUCHER,{data:JSON.stringify({code:data.code}),},callbackDeleteVoucher,'json');},redeemRewardPoints:function(el){var id=$(el).attr('id').replace('rewardPointButton_',''),value=$('#rewardPointQuantity_'+id).val();var callbackAddVoucher=function(response){if(response.data.response.success===1){this.showMessage(response.data.response.message,'success');this.submitCurrentData();}else{this.showMessage(response.data.response.message,'danger');}}.bind(this);var jsonToSend={id:id,value:value};$.post(LC.global.routePaths.BASKET_INTERNAL_REDEEM_REWARD_POINTS,{data:JSON.stringify(jsonToSend),},callbackAddVoucher,'json');},setPaymentSystem:function(value){this.el.basketSelectors.prop('disabled',true);var data=JSON.parse(value);LC.resources.pluginListener('setPaymentSystem',{},value,true);var inputsForAdditionalData={};$('.basketSelectorPaymentAdditionalData_'+data.id).each((index,el)=>{inputsForAdditionalData[el.name]=el.value;})
data['additionalData']=JSON.stringify(inputsForAdditionalData);$.post(LC.global.routePaths.BASKET_INTERNAL_SET_PAYMENT_SYSTEM,{data:JSON.stringify(data),},(response)=>{if(response.data.response.success){this.showMessage(response.data.response.message,'success');this.submitCurrentData();}else{this.showMessage(response.data.response.message,'danger');this.el.basketSelectors.prop('disabled',false);}},'json');},setShippingSection:function(el){if($(el).closest('.shippingSelectorSelected').length){return;}
this.el.basketSelectors.prop('disabled',true);const $el=$(el);let data={};if($el.hasClass('savePickingSelectionButton')){const lcData=$el.closest('.modal-content').find('input[name="physicalLocation"]:checked').data('lc');if(lcData?.hash){data={type:'PICKING',deliveryHash:lcData.hash,providerPickupPointHash:lcData.mode=='PROVIDER_PICKUP_POINT'?lcData.delivery.mode.providerPickupPoint.hash:''};bootstrap.Modal.getOrCreateInstance($el.closest('.modal-content').parent()).hide();}else{LC.notify(LC.global.languageSheet.deliveryPickingNoSelectedError,{type:'danger'});}}else{data={type:$el.data('lc-delivery-type'),deliveryHash:$el.data('lc-delivery-hash'),providerPickupPointHash:$el.data('lc-provider-pickup-point-hash')?$el.data('lc-provider-pickup-point-hash'):'',shipments:[],};$el.closest('.delivery').find('input.shippingTypeSelector:checked').each((index,shipping)=>{data.shipments.push({shippingHash:$(shipping).data('lc-shipping-hash'),shipmentHash:$(shipping).data('lc-shipment-hash'),});});}
LC.resources.pluginListener('setShippingSection',el,{id:el.value},true);$.post(LC.global.routePaths.BASKET_INTERNAL_SET_DELIVERY,{data:JSON.stringify(data),},(response)=>{if(response.data.response.success){this.showMessage(response.data.response.message,'success');this.submitCurrentData();}else{this.showMessage(response.data.response.message,'danger');this.el.basketSelectors.prop('disabled',false);}},'json');},});LC.UnsubscribeStockAlertForm=LC.Form.extend({name:'unsubscribeStockAlertForm',initialize:function(form){this.trigger('initializeBefore');this.initSubmitButtons();this.trigger('initializeCallback');},initSubmitButtons:function(){this.el.$buttons=this.el.$form.find('button');this.el.$buttons.click(this.submit.bind(this));},submit:function(event){event.preventDefault();this.id=$(event.target).data('lcStockAlertId');$.post(LC.global.routePaths.USER_INTERNAL_DELETE_STOCK_ALERT,{data:JSON.stringify({id:this.id})},this.onReceive.bind(this),'json');},onReceive:function(data){if(data.data.response.success==1){this.el.$form.find('div[data-lc-stock-alert-id='+this.id+']').fadeOut('slow',function(){var stockAlertForm=$(this).parents('[data-lc-form="unsubscribeStockAlertForm"]');this.remove();$(this).find('.stockAlertsDelete button.unsubscribeStockAlertButton').detach().tooltip('hide');if(!stockAlertForm.find('div.stockAlertsRecord').length){stockAlertForm.append('<div class="stockAlertsNoSubscriptions">'+LC.global.languageSheet.stockAlertsNoSubscriptions+'</div>');}});}
if(this.callback&&typeof this.callback==='function'){this.callback(data.data);}},});LC.ProductsFilter=LC.Form.extend({name:'productsFilter',$priceRangeSlider:null,priceSliderData:{},categories:[],submitted:false,initialize:function(form){if(this.el.$form.data('lc-autosubmit')){this.el.$form.on('change','input:not(.filterSliderRange), select',(event)=>{this.checkChangeCustomTagFilter(event);this.submit(event);});}else{this.el.$form.on('change','input:not(.filterSliderRange), select',(event)=>{this.checkChangeCustomTagFilter(event);});this.el.$form.on('submit',this.submit.bind(this));}
this.$priceRangeSlider=this.el.$form.find('input.filterSliderRange[name="priceRange"]');this.otherRangeSliders=this.el.$form.find('input.filterSliderRange:not([name="priceRange"])');if(this.$priceRangeSlider.length>0){this.priceSliderData=this.$priceRangeSlider.data();}else if($('.pricesFilterBlock').length>0){this.$categories=this.el.$form.find('.categoriesFilterBlock');if(this.$categories.length>0){this.categories=this.getSelectedCategories();}}
if(LC.config.productsFilterCustomTagGroupsExclusion){this.el.$customTagGroupInputs=this.el.$form.find('input[type="checkbox"][id*="CTGFE"]');this.el.$customTagGroupInputs.on('change',(event)=>{if($(event.currentTarget).prop('checked')){$(event.currentTarget).closest('.customTagsGroupFilterBlock').find('input[type="checkbox"]').not(event.currentTarget).prop('checked',false);}});}},checkChangeCustomTagFilter:function(event){if($(event.currentTarget).attr('name').startsWith("filterCustomTag_")){this.el.$form.find(`[name="${$(event.currentTarget).attr('name')}"]`).not(event.currentTarget).each((i,e)=>{if($(e).val()==$(event.currentTarget).val()){if($(e).attr('type')=='checkbox'){$(e).prop('checked',$(event.currentTarget).prop('checked'));}else if($(e).attr('type')=='hidden'){$(e).remove();}}})}},getSelectedCategories:function(){var categories=[],$select=this.$categories.find('select');if($select.length>0){categories=[$select.val()];}else{this.$categories.find('input:checked').each(function(i,e){categories.push($(e).val());});}
return categories.join();},hasBeenSubmitted:function(){return this.submitted;},submit:function(event){this.trigger('submitBefore');event.preventDefault();this.submitted=true;this.otherRangeSliders.each((index,otherRangeSlider)=>{let $otherRangeSlider=$(otherRangeSlider);if($otherRangeSlider.data('min')==$otherRangeSlider.data('from')&&$otherRangeSlider.data('max')==$otherRangeSlider.data('to')){$otherRangeSlider.remove();}});if(this.$priceRangeSlider.length){const values=this.$priceRangeSlider.val().split(';');if(parseFloat(values[0])===this.priceSliderData.min&&parseFloat(values[1])===this.priceSliderData.max){this.$priceRangeSlider.remove();}}else{if(this.categories.length){const filteredCategories=this.getSelectedCategories();if(this.categories!==filteredCategories){this.el.$form.find('.maxPrice, .minPrice, *[name=priceRange]').each(function(i,e){$(e).attr('name','');});}}}
this.el.$form.find('input[name^="filterOption"]').each(function(i,e){$(e).attr('name',decodeURIComponent($(e).attr('name')));$(e).attr('value',decodeURIComponent($(e).attr('value')));});this.el.form.submit();this.trigger('submitCallback');},});LC.DeletePaymentCardForm=LC.Form.extend({name:'DeletePaymentCardForm',callback:function(data){if(!this.trigger('callbackSubsitute',data.data)){this.trigger('callbackBefore',data.data);if(typeof data.data==='undefined')return;if(!data.data.response){var message=data.data.response.message?data.data.response.message:'Error';var success=0;}else{var message=data.data.response.message;var success=data.data.response.success?data.data.response.success:0;}
if(success){token='#paymentCard_'+this.dataForm.id+'_'+$.escapeSelector(this.dataForm.token);$(token).remove()
this.showMessage(message,'success');}else{this.showMessage(message,'danger');}
this.trigger('callback',data.data);}},});LC.ReturnRequestForm=LC.Form.extend({name:'orderReturnForm',elementId:'requestFormModal',options:{},initialized:false,initialize:function(form){this.trigger('initializeBefore');this.returnDeliveryOptionsView();this.initOptions();this.data=JSON.parse(this.el.$form.attr('data-lc'));this.el.form.initialized=true;this.returnDeliveryEvents();this.trigger('initializeCallback');},initOptions:function(){this.trigger('initOptionsBefore');this.submitted=false;this.el.$submit=this.el.$form.find('#returnSubmitContainer');this.el.$tableReturn=this.el.$form.find('table');this.el.$quantity=this.el.$form.find('input.returnQuantity');this.el.$quantity.change(this.changeInput.bind(this));this.el.$checkbox=this.el.$form.find('input[type="checkbox"][name*="returnCheck"]');this.el.$checkbox.click(this.clickCheckBox.bind(this));this.el.$rmaReasons=this.el.$form.find('select[name*="rmaReasonId"]');this.el.$rmaReasons.change(this.changeRmaReason.bind(this));this.el.returnPoints=this.el.$form.find('input[name="returnDelivery"]');this.el.$map=this.el.$form.find('.physicalLocationsMap');this.el.$motive=this.el.$form.find('.returnComment');this.el.$physicalLocationSelectors=this.el.$form.find('.physicalLocationSelectors');this.enableFormElements(false);this.trigger('initOptionsCallback');},clickCheckBox:function(event){this.trigger('clickCheckBoxBefore');let $checkbox=$(event.target),quantityId='#'+$(event.target).attr('name').replace('Check','Quantity'),$rmaReasonId=$('#'+$(event.target).attr('name').replace('returnCheck','rmaReasonId')),$rmaReasonComment=$('#'+$(event.target).attr('name').replace('returnCheck','rmaReasonComment')),$quantity=$(quantityId),formActive=this.el.$checkbox.filter((index,el)=>el.checked).length>0;if($checkbox.prop('checked')){$quantity.prop('disabled',false).removeClass('disabled');$rmaReasonId.change();$rmaReasonId.prop('disabled',false).removeClass('disabled');$rmaReasonComment.prop('disabled',false).removeClass('disabled');}else{$quantity.prop('disabled',true).addClass('disabled');$rmaReasonId.prop('disabled',true).addClass('disabled');$rmaReasonComment.prop('disabled',true).addClass('disabled');}
this.enableFormElements(formActive);this.trigger('clickCheckBoxCallback');},changeRmaReason:function(event){this.trigger('changeRmaReasonBefore');let $rmaReason=$(event.target),$rmaReasonComment=$('#'+$(event.target).attr('name').replace('rmaReasonId','rmaReasonComment')),$rmaReasonCommentLabel=$('label[for="'+$rmaReasonComment.attr('id')+'"]');if($rmaReason.find('option:selected').data('lc').requiresComment){$rmaReasonCommentLabel.html($rmaReasonCommentLabel.html()+LC.global.settings.requiredFlag);$rmaReasonComment.attr('required',true);$rmaReasonComment.attr('data-validation','required');}else{$rmaReasonCommentLabel.html($rmaReasonCommentLabel.html().replace(LC.global.settings.requiredFlag,''));$rmaReasonComment.removeAttr('required');$rmaReasonComment.removeAttr('data-validation');}
this.trigger('changeRmaReasonCallback');},enableFormElements:function(formActive){this.el.$physicalLocationSelectors.find('select').prop('disabled',!formActive)[!formActive?'addClass':'removeClass']('disabled');this.el.$motive.prop('disabled',!formActive);this.el.returnPoints.prop('disabled',!formActive);this.el.$submit.prop('disabled',!formActive);this.el.$map[!formActive?'addClass':'removeClass']('disabled');this.el.$form.find('#returnDeliverySelectPL').prop('disabled',!formActive);},changeInput:function(eventData){this.trigger('initOptionsBefore');const objInput=$(eventData.target),dataInput=objInput.data('lc');if(isNaN(objInput.val())||objInput.val()<1||objInput.val()>dataInput.quantity){objInput.val(dataInput.quantity);}
this.trigger('changeInputCallback');},submit:function(event){if(this.el.form.method==='get')return;this.el.$submit.prop('disabled',true);event.preventDefault();if(!this.el.$form.isValid())return false;if(this.setCaptchaToken(event))return;var arrDataForm=this.el.$form.serializeArray();this.dataForm={};for(var i=0;i<arrDataForm.length;i++)this.dataForm[arrDataForm[i].name]=arrDataForm[i].value;this.dataForm['formData']=this.data;this.el.$form.find('button[type="submit"], input[type="submit"]').attr('disabled',true);this.submitted=true;if(this.el.form.method=='post')
$.post(this.el.form.action,{data:JSON.stringify(this.dataForm)},this.onReceive.bind(this),'json').fail(this.onFail.bind(this)).always(this.onComplete(this));},hasBeenSubmitted:function(){return this.submitted;},callback:function(data){this.el.$submit.prop('disabled',false);if(typeof data==='undefined')return;if(!data.data.response){var message=data.data.response.message?data.data.response.message:'Error';var success=0;}else{var message=data.data.response.message;var success=data.status.code?data.status.code:0;}
this.showMessage(message,success?'success':'danger');if(success){let $products=this.el.$form.find('input[type=checkbox]:checked').parents('tr');$products.each((index,el)=>{let $element=$(el),$inputQuantity=$element.find('input:not([type="hidden"]).returnQuantity'),$ckeckbox=$element.find('input[type="checkbox"]'),dataInputQuantity=$inputQuantity.data('lc'),quantityValue=parseInt($inputQuantity.val());if(quantityValue===dataInputQuantity.quantity){$element.parents('tbody').find(`input[type=hidden][value=bundle${$ckeckbox.val()}]`).parents('tr').remove();$element.remove();}else{$ckeckbox.prop('checked',false);dataInputQuantity.quantity-=quantityValue;$inputQuantity.prop('disabled',true).val(dataInputQuantity.quantity);this.el.$motive.prop('disabled',true).val(-1);$inputQuantity.data('lc-product',dataInputQuantity);}});if(LC.config.orderReturnRequestReload===true){location.reload();}}
this.trigger('submitFormCallback',data,this);},addTracingLine:function(data){var rma=data.data.data.data;var $tr=$('<tr>',{class:'grid userRmaRequest rmaRequestsGroup rmaRequestsGroup'+rma.id});var $tdOrderNumber=$('<td>',{class:'grid userRmaRequest userRmaRequestOrderNumber'});var $divOrderNumber=$('<div>',{class:'clearfix wrp',html:rma.documentNumber,});var $tdDateOrdered=$('<td>',{class:'grid userRmaRequest userRmaRequestDateOrdered',});var date=new Date(rma.date);var $divDateOrdered=$('<div>',{class:'clearfix wrp',html:date.toLocaleDateString(),});var $tdStatus=$('<td>',{class:'grid userRmaRequest userRmaRequestStatus',});var status=rma.status.toLowerCase();status=status.charAt(0).toUpperCase()+status.slice(1);status='rmaStatus'+status;status=LC.global.languageSheet[status];if(rma.substatus.length>0){status+=' / '+rma.substatus;}
var $divStatus=$('<div>',{class:'clearfix wrp',html:status,});var $tdActions=$('<td>',{class:'grid userRmaRequest userRmaRequestActions',});var $divLinks=$('<div>',{class:'order-links',});var $buttonViewRma=$('<button>',{class:BTN_SECONDARY_CLASS+' userOrderAction rma',type:'button',onClick:LC.dataEvents.viewDocument(this),});rma['pdf']=false;$buttonViewRma.data=rma;var $imgViewRma=$('<img>',{src:LC.global.settings.commerceCdnPath+'img/viewOrder.png',alt:LC.global.languageSheet.viewRma,});var $spanViewRma=$('<span>',{html:LC.global.languageSheet.viewRma,});rma['pdf']=true;var $buttonViewRmaPdf=$('<button>',{class:BTN_SECONDARY_CLASS+' userOrderAction rmaPdf',type:'button',data:rma,onClick:LC.dataEvents.viewDocument(this),});$buttonViewRmaPdf.data=rma;var $imgViewRmaPdf=$('<img>',{src:LC.global.settings.commerceCdnPath+'img/viewOrderPdf.png',alt:LC.global.languageSheet.viewRmaPdf,});var $spanViewRmaPdf=$('<span>',{html:LC.global.languageSheet.viewRmaPdf,});$tr.append($tdOrderNumber.append($divOrderNumber),$tdDateOrdered.append($divDateOrdered),$tdStatus.append($divStatus),$tdActions.append($divLinks.append($buttonViewRma.append($imgViewRma,$spanViewRma,),$buttonViewRmaPdf.append($imgViewRmaPdf,$spanViewRmaPdf,),),),);return $tr;},returnDeliveryOptionsView:function(data){const $physicalLocations=this.el.$form.find('.physicalLocations'),$returnPoints=$('<div/>').addClass('returnPoints'),$returnMethodTitle=$('<div/>',{class:'returnMethodTitle',text:LC.global.languageSheet.returnMethod,});$returnPoints.append($returnMethodTitle);const $returnDelivery0=this.el.$form.find('.returnDeliveryOption#returnDelivery0, label[for="returnDelivery0"]');if($returnDelivery0.length){$returnPoints.append($returnDelivery0);$returnDelivery0.wrapAll(`<div class="form-check"></div>`);}
if($physicalLocations.length){const $returnDeliverySelectPL=$(`
                 <div class="form-check">
                     <input type="radio" id="returnDeliverySelectPL" class="returnDeliveryOption form-check-input" value="-1">
                     <label class="form-check-label" for="returnDeliverySelectPL">
                         ${LC.global.languageSheet.deliveryTitlePicking}
                         <span>${LC.global.languageSheet.deliveryPickingNoSelectedError}</span>
                     </label>
                 </div>`);$returnPoints.append($returnDeliverySelectPL);$returnPoints.append($physicalLocations);$physicalLocations.find('[data-lc-event]').dataEvent();this.el.$form.find('.defaultOptions').remove();}else{this.el.$form.find('.returnDeliveryOption').not('#returnDelivery0').each((index,el)=>{const $input=$(el),$label=$(`label[for="${$(el).attr('id')}"]`);$input.add($label).wrapAll(`<div class="form-check"></div>`);});}
$returnPoints.appendTo(this.el.$form.find('#returnDeliveryContainer'));this.el.$form.find('input#returnDelivery0').prop('checked',true);},returnDeliveryEvents(){this.el.$form.find('#returnDeliverySelectPL').on('change',(event)=>{if($(event.target).prop('checked')){this.el.$form.find('.physicalLocations').slideDown(()=>{if(this.el.$map.length){LC.maps.whereCenterTheMap();}});this.el.$form.find('#returnDelivery0').prop('checked',false);$(event.target).removeClass('physicalLocationSelected');}});this.el.$form.find('#returnDelivery0').on('change',(event)=>{if($(event.target).prop('checked')){this.el.$form.find('.physicalLocations').slideUp();this.el.$form.find('#returnDeliverySelectPL').removeClass('physicalLocationSelected').prop('checked',false);}});this.el.$form.find('[name="returnDelivery"]').on('change',(event)=>{if($(event.target).prop('checked')){this.el.$form.find('#returnDeliverySelectPL').addClass('physicalLocationSelected');}});},});LC.SalesAgentCustomersForm=LC.Form.extend({name:'salesAgentCustomersForm',elementId:'requestFormModal',initialized:false,initialize:function(form){this.trigger('initializeBefore');this.initCalendar();this.trigger('initializeCallback');this.el.form.initialized=true;},initCalendar:function(){this.el.$form.find('[data-datetimepicker]').each((index,el)=>{var $calendar=$(el),language=$calendar.data('language')?$calendar.data('language'):'en',format=$calendar.data('format'),startDate=$calendar.data('startdate'),endDate=$calendar.data('enddate'),weekstart=$calendar.data('weekstart');moment.locale(language,{week:{dow:weekstart}});$calendar.datetimepicker({locale:language,format:format?format:CALENDAR_PLUGIN_DATE_FORMAT,minDate:startDate?startDate:false,maxDate:endDate?endDate:false});$(el).on('dp.change',(e)=>{var $optionsubmitValue=this.el.$form.find('[name="'+$calendar.data('submit')+'"]');if(e.date){$optionsubmitValue.val(moment(e.date).format('YYYY-MM-DDTHH:mm:ssZ'));}else{$optionsubmitValue.val('');}});});},submit:function(event){var enableSubmit=true;this.el.$form.find('input[type="hidden"]').each((i,input)=>{var date=moment($(input).val(),'YYYY-MM-DDTHH:mm:ssZ',true);if(!date.isValid()){$(input).closest('div').find('.viewDateValue').val('');$(input).val('');enableSubmit=false;};});return enableSubmit;},hasBeenSubmitted:function(){return this.submitted;},callback:function(data){},});LC.SalesAgentSalesForm=LC.Form.extend({name:'salesAgentSalesForm',elementId:'requestFormModal',initialized:false,initialize:function(form){this.trigger('initializeBefore');this.initCalendar();this.trigger('initializeCallback');this.el.form.initialized=true;},initCalendar:function(){this.el.$form.find('[data-datetimepicker]').each((index,el)=>{var $calendar=$(el),language=$calendar.data('language')?$calendar.data('language'):'en',format=$calendar.data('format'),startDate=$calendar.data('startdate'),endDate=$calendar.data('enddate'),weekstart=$calendar.data('weekstart');moment.locale(language,{week:{dow:weekstart}});$calendar.datetimepicker({locale:language,format:format?format:CALENDAR_PLUGIN_DATE_FORMAT,minDate:startDate?startDate:false,maxDate:endDate?endDate:false});$(el).on('dp.change',(e)=>{var $optionsubmitValue=this.el.$form.find('[name="'+$calendar.data('submit')+'"]');if(e.date){$optionsubmitValue.val(moment(e.date).format('YYYY-MM-DDTHH:mm:ssZ'));}else{$optionsubmitValue.val('');}});});},submit:function(event){var enableSubmit=true;this.el.$form.find('input[type="hidden"]').each((i,input)=>{var date=moment($(input).val(),'YYYY-MM-DDTHH:mm:ssZ',true);if(!date.isValid()){$(input).closest('div').find('.viewDateValue').val('');$(input).val('');enableSubmit=false;};});return enableSubmit;},hasBeenSubmitted:function(){return this.submitted;},callback:function(data){},});LC.BuyBundleForm=LC.Form.extend({name:'BuyBundleForm',options:{},type:'BUNDLE',initialize:function(form){if(this.el.form.initialized)return;this.trigger('initializeBefore');this.dataBundle=JSON.parse(this.el.$form.attr('data-lc-bundle'));this.dataProducts=JSON.parse($(this.el.form).closest('.product-bundle-'+this.dataBundle.bundleId).attr('data-lc-main-products'));this.combinationData=this.dataBundle.grouping.combinationData;this.idField=this.el.$form.find('input[name="id"]');this.bundleProducts=this.el.$form.find('input[name="bundleProduct"]');this.el.$quantityField=this.el.$form.find('input[name="quantity"],select[name="quantity"]');this.el.$quantityField.change(this.onChangeQuantity.bind(this));this.el.$buyFormSubmit=this.el.$form.find('button[type="submit"]');this.useUrlOptionsParams=false;this.combinationDataOptionChanged=false;this.initShoppingList();this.$buttonRecommendBundle=this.el.$form.find('#buttonRecommendBundle_'+this.dataBundle.grouping.id);this.$buttonRecommendBundle.on("click",(event)=>{const $modal=$(this.$buttonRecommendBundle.attr('data-bs-target'));$modal.find('input[name="id"]').val(this.dataBundle.grouping.id);$modal.find('input[name="options"]').val(JSON.stringify(this.getFormData().items));});this.optionsInitialized=false;this.initOptions();this.callback=this.callback.bind(this);this.initializeFilePlugin();this.el.form.initialized=true;},getBundleItemId:function(productId){for(var i=0;i<this.dataBundle.grouping.items.length;i++){if(this.dataBundle.grouping.items[i].productId==productId){return this.dataBundle.grouping.items[i].id;}}
return 0;},getOptionName:function(productId,optionId){for(var i=0;i<this.dataProducts[productId].options.length;i++){if(this.dataProducts[productId].options[i].id==optionId){return this.dataProducts[productId].options[i].language.name;}}
return'';},onChange:function(doRequest){var combinationData=this.combinationData;this.updateButton(combinationData,this.el.$buyFormSubmit,'notAvailable');if(doRequest){$.ajax({type:'POST',url:LC.global.routePaths.PRODUCT_INTERNAL_GET_BUNDLE_COMBINATION_DATA,data:{data:JSON.stringify(this.getFormData())},success:(response)=>{combinationData=response;if(response.data.response.success){combinationData=response.data.data;}},async:false,dataType:'json'});}
this.combinationData=combinationData;combinationData.items.forEach(combinationDataItem=>{var $productOptionsContainer=$(this.el.$form.find('div.product-options-'+combinationDataItem.productId));if($productOptionsContainer.length>0){var productOptionsData=JSON.parse($productOptionsContainer.find('div.productOptions').attr('data-lc-data'));this.checkOptionsAvailability(combinationDataItem,$productOptionsContainer,productOptionsData);if((this.optionsInitialized||this.useUrlOptionsParams)&&productOptionsData.addOptionsToProductLink){this.addOptionsToProductLink(productOptionsData,$($productOptionsContainer.closest('.bundle-item-product')));}}});this.setPrices(combinationData,'bundleGrouping');this.updateButton(combinationData,this.el.$buyFormSubmit,'bundleGrouping');if(this.shoppingListRowId>0&&this.el.form.initialized){this.updateShoppingListRow();}},getBundleSelectOptionText:function(combinationData,dataProducts){var bundleSelectOptionText='';combinationData.items.forEach(item=>{bundleSelectOptionText+=this.getSelectOptionText(item,dataProducts[item.productId]);});return bundleSelectOptionText;},setPrices:function(combinationData,itemType){this.el.$form.find('.bundleGrouping-price, .bundleGrouping-basePrice, .bundleGrouping-saving').each((index,el)=>{const $property=$(el);let price,basePrice,retailPrice,lcShowTax=$property.attr('data-lc-show-tax')??'true';if(lcShowTax==='false'){basePrice=combinationData.prices.basePrice;retailPrice=combinationData.prices.retailPrice;}else{basePrice=combinationData.pricesWithTaxes.basePrice;retailPrice=combinationData.pricesWithTaxes.retailPrice;}
if(basePrice>retailPrice){const saving=basePrice-retailPrice;price=retailPrice;if($property.is('.bundleGrouping-basePrice')||$property.is('.bundleGrouping-saving')){$property.show();}
if($property.is('.bundleGrouping-saving')){$property.find('.price').replaceWith(outputHtmlCurrency(saving));$property.find('.percent').html(((saving*100)/basePrice).toFixed(0));}}else{price=basePrice;if($property.is('.bundleGrouping-basePrice')||$property.is('.bundleGrouping-saving')){$property.hide();}}
if($property.is('.bundleGrouping-price')){$property.find('.price').replaceWith(outputHtmlCurrency(price));}else if($property.is('.bundleGrouping-basePrice')){$property.find('.price').replaceWith(outputHtmlCurrency(basePrice));}});},getFormData:function(){var options=this.el.$options.not(".productOptionAttachmentHiddenValue").serializeArray(),items={},responseItems=[];this.bundleProducts.each(function(index,field){items[$(field).val()]={};});options.forEach(option=>{var item=option.name.split("_");if(!('options'in items[item[1]])){items[item[1]]['options']={};}
if(!(item[2]in items[item[1]]['options'])){items[item[1]]['options'][item[2]]=[];}
items[item[1]]['options'][item[2]].push({value:option.value});});if(this.el.$productOptionAttachment.length){this.el.$form.find('input.productOptionAttachmentHiddenValue').each((index,el)=>{var item=$(el).attr("name").split("_");if(!('options'in items[item[1]])){items[item[1]]['options']={};}
if(!(item[2]in items[item[1]]['options'])){items[item[1]]['options'][item[2]]=[];}
if($(el).val().length){items[item[1]]['options'][item[2]].push(JSON.parse($(el).val()));}});}
for(var key in items){var responseItem={};responseItem['id']=key;responseItem['options']=[];for(var optKey in items[key]['options']){responseItem['options'].push({id:optKey,values:items[key]['options'][optKey]});}
responseItems.push(responseItem);}
return{id:this.idField.val(),quantity:this.el.$quantityField?this.el.$quantityField.val():1,items:responseItems,fromShoppingListRow:this.shoppingListRowId};},formIsValid:function(){for(const[key,value]of this.filePluginIsOnError.entries()){if(value!==''){LC.notify(value,{type:'danger'});return false;}}
return this.el.$form.isValid();},submit:function(event){event.preventDefault();this.trigger('submitBefore',event);if(!this.formIsValid())return false;let formData=this.getFormData();if($(event.originalEvent.submitter).data('lc-express-checkout-plugin')){formData.pluginAccountId=$(event.originalEvent.submitter).data('lc-express-checkout-plugin').id;}
$.post(LC.global.routePaths.BASKET_INTERNAL_ADD_BUNDLE,{data:JSON.stringify(formData)},this.callback,'json');this.el.$buyFormSubmit.prop('disabled',true);this.trigger('submitCallback',event);},callback:function(data){if(data.data.data?.expressCheckoutUrl&&data.data.data.expressCheckoutUrl.length>0){window.location.href=data.data.data.expressCheckoutUrl;return;}
LC.miniBasket.reload();this.el.$buyFormSubmit.prop('disabled',false);},},LC.buyFormResources);LC.SendMailForm=LC.Form.extend({name:'SendMailForm',initialize:function(form){if(this.el.form.initialized)return;this.el.form.initialized=true;this.el.$attachments=this.el.$form.find('input:file');this.el.$attachments.change(this.onChangeAttachment.bind(this));this.el.$submit=this.el.$form.find('button[type="submit"]');this.el.$type=this.el.$form.find('input[name="type"]');},onChangeAttachment:function(eventData){var $field=$(eventData.target);var files=eventData.target.files;var $parent=$field.closest('.sendMailFormField');var $hiddenInput=$parent.find('.attachmentHiddenValue');if(files.length>0){var attachmentData=$hiddenInput.data('attachemnt');if(files[0].size>(attachmentData.maxSize*1024*1000)){LC.notify(LC.global.languageSheet.attachFileMaxSize.replace('{{maxSize}}',attachmentData.maxSize),{type:'danger'});$field.val('');$hiddenInput.val('');}else{var reader=new FileReader();reader.readAsDataURL(files[0]);reader.onload=function(){var attachmentValue={fileName:files[0].name,data:reader.result};$hiddenInput.val(JSON.stringify(attachmentValue));};reader.onerror=function(error){$field.val('');$hiddenInput.val('');LC.notify(LC.global.languageSheet.attachFileError.replace('{{maxSize}}',attachmentData.maxSize),{type:'danger'});};}}},submit:function(event){event.preventDefault();if(!this.el.$form.isValid())return false;if(this.setCaptchaToken(event))return;let data={attachments:[],};$.each(this.el.$form.serializeArray(),(index,obj)=>{const $el=this.el.$form.find(`[name="${obj.name}"]`);if($el.hasClass("attachmentHiddenValue")){data.attachments.push(obj.value);}else if($el.attr('type')!=='file'){data[obj.name]=obj.value;}});$.post(LC.global.routePaths.RESOURCES_INTERNAL_SEND_MAIL,{data:JSON.stringify(data)},this.callback.bind(this),'json');this.el.$submit.prop('disabled',true);},callback:function(data){this.el.$submit.prop('disabled',false);var message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
this.el.$message.text(message);if(success){this.el.$message.removeClass('alert-danger').addClass('alert alert-success');}else{this.el.$message.removeClass('alert-success').addClass('alert alert-danger');}
this.trigger('callback',data);},});LC.BlogSubscribeForm=LC.Form.extend({name:'blogSubscribeForm',callback:function(data){if(typeof data==='undefined')return;let message=data?.data?.response?.message??'Error',success=data?.data?.response?.success===1;message=message.replace('{{name}}',document.title??'');this.showMessage(message,success?'success':'danger');if(success){this.el.$form.closest('#subscriptionFormContainer').remove();}},});LC.NewsletterForm=LC.Form.extend({name:'newsletterForm',initialize:function(form){if(this.el.form.initialized)return;this.el.form.initialized=true;this.el.$submit=this.el.$form.find('button[type="submit"]');this.el.$type=this.el.$form.find('input[name="type"]');this.el.$submit.prop('disabled',true);if(this.el.$type.val()=='CHECK_STATUS'){$.post(LC.global.routePaths.USER_INTERNAL_NEWSLETTER,{data:this.el.$type.attr('data-lc')},this.subscribeCheckStatusCallback.bind(this,this.el.$type),'json');}else{this.el.$submit.prop('disabled',false);}},subscribeCheckStatusCallback:function($type,response){var data=JSON.parse($type.attr('data-lc'));if(response.data.response.success){if(response.data.data.status=="SUBSCRIBED"){data.type='UNSUBSCRIBE';this.el.$submit.html(LC.global.languageSheet.unsubscribe);}else{data.type='SUBSCRIBE';this.el.$submit.html(LC.global.languageSheet.subscribe);}
$type.attr("data-lc",JSON.stringify(data));this.el.$type.val(data.type);this.el.$submit.prop('disabled',false);}
this.trigger('subscribeCheckStatusCallback',data,$type,response);},submit:function(event){event.preventDefault();if(this.setCaptchaToken(event)){return;}
if(!this.el.$form.isValid()){return false;}
this.el.$submit.prop('disabled',true);var arrDataForm=this.el.$form.serializeArray(),dataForm={};for(var i=0;i<arrDataForm.length;i++){dataForm[arrDataForm[i].name]=arrDataForm[i].value;}
$.post(LC.global.routePaths.USER_INTERNAL_NEWSLETTER,{data:JSON.stringify(dataForm)},this.callback.bind(this),'json');this.el.$submit.prop('disabled',false);},callback:function(response){if(typeof response==='undefined')return;var data=JSON.parse(this.el.$type.attr('data-lc'));if(response.data.response.success){if(response.data.data.status=="SUBSCRIBED"){data.type='UNSUBSCRIBE';this.el.$submit.html(LC.global.languageSheet.unsubscribe);}else{data.type='SUBSCRIBE';this.el.$submit.html(LC.global.languageSheet.subscribe);}
if(response.data.data.messageType=="SCRIPT"){eval(response.data.data.message);}else{this.showMessage(response.data.response.message,'success');}
this.el.$type.attr("data-lc",JSON.stringify(data));this.el.$type.val(data.type);this.el.$submit.prop('disabled',false);}else{this.showMessage(response.data.response.message,'danger');}},});LC.BuyProductForm=LC.Form.extend({name:'buyProductForm',type:'PRODUCT',initialize:function(form){if(this.el.form.initialized)return;this.el.form.module=this;this.data=JSON.parse(this.el.$form.attr('data-product'));this.expirationTimeoutLockedStockReserved=null;this.combinationData=this.data.combinationData;this.el.$gridCombinations=this.el.$form.find('[data-lc-grid-combinations]');this.gridData=this.el.$gridCombinations.length?this.el.$gridCombinations.data('lcGridCombinations'):null;this.filledForm=false;this.el.$buyFormSubmit=this.el.$form.find('button[type="submit"]');this.el.$quantityField=this.el.$form.find('input[name="quantity"],select[name="quantity"]');this.el.$quantityField.change(this.onChangeQuantity.bind(this));this.el.$sku=this.el.$form.find('.product-combinations-sku');this.el.$ean=this.el.$form.find('.product-combinations-ean');this.el.$productStock=this.el.$form.find('.product-stock');this.el.$stockAlert=this.el.$form.find('div.stockAlertButton');this.el.$stockAlertButton=this.el.$form.find('button.stockAlertButton');if(this.el.$stockAlertButton.length)this.el.$stockAlertButton.click(this.clickStockAlertButton.bind(this));this.alternativeImageField=this.el.$form.find('input[data-lc-field="alternativeImage"]').get(0);this.linkedSectionId=this.el.$form.find('input[name="sectionId"]').val();this.discountSelectableGiftId=this.el.$form.find('input[name="discountSelectableGiftId"]').val();this.productOptions=$(this.el.$form.find('div.productOptions'));this.useUrlOptionsParams=false;this.combinationDataOptionChanged=false;this.productOptionsData={};this.el.$priceByQuantityBox=this.el.$form.find('.priceByQuantity');if(this.productOptions.length){this.productOptionsData=JSON.parse($(this.productOptions).attr('data-lc-data'));this.useUrlOptionsParams=this.productOptionsData.useUrlOptionsParams;}
this.el.$offsetContainer=this.el.$form.find('.productOffsetMessage');this.trigger('initializeBefore');this.initShoppingList();this.optionsInitialized=false;this.initOptions();this.callback=this.callback.bind(this);this.initializeFilePlugin();this.trigger('init');this.el.$wishlistDelete=this.el.$form.find('[data-wishlist-delete]');if(this.el.$wishlistDelete.length)this.wishlist(this.el.$wishlistDelete,'delete');this.el.$wishlistAdd=this.el.$form.find('[data-wishlist-add]');if(this.el.$wishlistAdd.length)this.wishlist(this.el.$wishlistAdd,'add');this.el.$wishlistAccountRequired=this.el.$form.find('[data-wishlist-account_required]');if(this.el.$wishlistAccountRequired.length)this.wishlist(this.el.$wishlistAccountRequired,'account_required');this.el.$productComparison=this.el.$form.find('[data-product-comparison]');if(this.el.$productComparison.length)this.productComparison();this.el.form.initialized=true;this.trigger('initializeCallback');},getFormValues:function(){let formValues=[];if(this.el.$options.length){formValues=this.el.$options.not(".productOptionAttachmentHiddenValue").serializeArray();}else{let selectedOptions=[];if(LC.global.settings.stockManagement&&this.data.definition.stockManagement){for(let key in this.data.stocks){if(this.data.stocks[key]>0){let optionValues=key.split('_');if(optionValues.length==1)break;optionValues=optionValues[1].split('-');for(let i=0;i<optionValues.length;i++){for(let option in this.data.options){if(this.data.options[option].values['id'+optionValues[i]]){formValues.push({name:'optionValue'+this.data.options[option].id,value:optionValues[i],});selectedOptions.push(this.data.options[option].id);}}}
break;}}}}
if(this.el.$productOptionAttachment.length){const attachedFile=this.el.$form.find('input.productOptionAttachmentHiddenValue').serializeArray();for(let i=0;i<attachedFile.length;i++)formValues.push(attachedFile[i]);}
return formValues;},updateButton:function(button,properties){button.removeClass('selectOption notAvailable reserve buy');button.addClass(properties.className);button.prop('disabled',properties.disabled);button.data('buyFormSubmitName',properties.name);if(button.data('show-label')==true)button.html(properties.name);else button.html('');},onChange:function(doRequest){var formData=this.getFormData();this.trigger('onChangeBefore',formData);clearTimeout(this.expirationTimeoutLockedStockReserved);this.el.$form.find('.stock-lock').remove();this.updateButton(this.combinationData,this.el.$buyFormSubmit,'notAvailable');if(this.gridData){this.el.$form.find('[data-lc-grid-combination]').addClass('disabled');this.el.$form.find('.combination-stock').removeClass('no-stock');this.el.$form.find('.combination-stock').removeClass('stock-ok');this.el.$form.find('.combination-stock').addClass('uncompleted');}
if(doRequest){$.ajax({type:'POST',url:LC.global.routePaths.PRODUCT_INTERNAL_GET_PRODUCT_COMBINATION_DATA,data:{data:JSON.stringify(formData)},success:(response)=>{this.combinationData=response;if(response.data.response.success){this.combinationData=response.data.data;}},async:false,dataType:'json'});}
if(this.el.$options.length){this.checkOptionsAvailability(this.combinationData,this.productOptions,this.productOptionsData);if((this.optionsInitialized||this.useUrlOptionsParams)&&this.productOptionsData.addOptionsToProductLink){this.addOptionsToProductLink(this.productOptionsData,$($productOptionsContainer.closest('.bundle-item-product')));}}
if(!this.gridData||this.gridData.prices.showGridPrice=='showGridPriceAnyOption'){this.setPrices(this.combinationData,'product');}
if(this.gridData){this.updateGrid();this.updateCombinationData();}
this.updateButton(this.combinationData,this.el.$buyFormSubmit,'product');if(this.combinationData.productCodes.sku.length>0)this.el.$sku.html(this.combinationData.productCodes.sku);if(this.combinationData.productCodes.ean.length>0)this.el.$ean.html(this.combinationData.productCodes.ean);if(this.combinationData.status!='SELECT_OPTION'&&this.el.$stockAlertButton.length){this.el.$stockAlertButton.attr('combinationId',this.combinationData.stock.combinationId);if(this.combinationData.showStockAlert){this.el.$stockAlertButton.add(this.el.$stockAlert).addClass('product-stock-alert-active').removeClass('product-stock-alert-hidden');}else{this.el.$stockAlertButton.add(this.el.$stockAlert).addClass('product-stock-alert-hidden').removeClass('product-stock-alert-active');}}
if(this.combinationData.status!='SELECT_OPTION'&&this.combinationData.stock.units>=0){this.el.$productStock.removeClass('not-init').find('.stock').html(this.combinationData.stock.units);if(this.combinationData.stock.units>0){this.el.$productStock.removeClass('no-stock').addClass('stock-ok');this.el.$form.find('.product-stock .stock').html(this.combinationData.stock.units);if(this.combinationData.stock.units===1){this.el.$form.find('.stockText').html(LC.global.languageSheet.stockSingular.replace('{{stock}}',this.combinationData.stock.units));}else{this.el.$form.find('.stockText').html(LC.global.languageSheet.stockPlural.replace('{{stock}}',this.combinationData.stock.units));}}else{this.el.$productStock.removeClass('stock-ok').addClass('no-stock');this.el.$form.find('.stockText').html(LC.global.languageSheet.stockNone.replace('{{stock}}',this.combinationData.stock.units));}}else{this.el.$productStock.addClass('not-init');}
let availabilityInterval=null;if(this.combinationData.status!='SELECT_OPTION'&&this.data.definition.availability){for(let i=this.data.definition.availability.intervals.length-1;i>-1;i--){const interval=this.data.definition.availability.intervals[i];if(this.combinationData.stock.units<=interval.stock){availabilityInterval=interval;}}}
if(availabilityInterval){this.el.$form.find('.product-stock').removeClass('not-init');var name=availabilityInterval.language.name.replace('{{stock}}',this.combinationData.stock.units);if(this.data.definition.onRequest){name.replace('{{onRequestDays}}',this.data.definition.onRequestDays);}
this.el.$form.find('.product-stock .availabilityImage').html(`<img src="${availabilityInterval.language.image}" class="availabilityImage" onerror="$(this).remove();">`);this.el.$form.find('.product-stock .availabilityName').html(name);this.el.$form.find('.product-stock .availabilityImage').show();this.el.$form.find('.product-stock .availabilityName').show();}else{this.el.$form.find('.product-stock .availabilityImage').hide();this.el.$form.find('.product-stock .availabilityName').hide();}
if(this.el.$offsetContainer.length){this.el.$offsetContainer.html('');if(this.combinationData.status==="AVAILABLE"||this.combinationData.status==="RESERVE"){var offsetDays=this.combinationData.stock.offsetDays,quantity=this.getQuantityValue(this.data.definition);if(quantity<=this.combinationData.stock.units&&this.combinationData.stock.previsionDate!=null){var previsionDate=new Date(this.combinationData.stock.previsionDate);previsionDate.setDate(previsionDate.getDate()+offsetDays);var formattedDate=moment(previsionDate).format(CALENDAR_PLUGIN_DATE_FORMAT);this.el.$offsetContainer.html(LC.global.languageSheet.warehouseOffsetMessage.replace('{{offsetDays}}',formattedDate).replace('{{previsionDate}}',formattedDate));}else if(quantity>this.combinationData.stock.units&&this.data.definition.onRequest){this.el.$offsetContainer.html(LC.global.languageSheet.onRequestProductMessage.replace('{{days}}',this.data.definition.onRequestDays+offsetDays));}}}
if(this.shoppingListRowId>0&&this.el.form.initialized){this.updateShoppingListRow();}
$('#'+this.type.toLowerCase()+'RecommendOptions_'+this.data.id).val(JSON.stringify(this.getFormData().options));this.enabledButtons=this.el.$buyFormSubmit.filter(':enabled');this.updatePriceByQuantity(this.combinationData.options);this.trigger('onChangeCallback',{combinationData:this.combinationData,gridData:this.gridData,quantity:this.getQuantityValue(this.data.definition)});},updateGrid:function(){this.updateGridData();if(this.gridData.combinations.status=='AVAILABLE'){this.el.$form.find('[data-lc-grid-combination]').each((i,el)=>{var data=$(el).data('lc-grid-combination'),currentCombinationValues=[...data.values];$.each(this.optionsSummary.selected.values,(j,value)=>{if(this.optionsSummary.combinableValues.includes(value))currentCombinationValues.push(value);});currentCombinationValues=currentCombinationValues.sort().join('-');for(const combinationId in this.gridData.combinations.values){const combination=this.gridData.combinations.values[combinationId];if(currentCombinationValues==combination.optionValueIds.sort().join('-')){data.stock=combination.stock;data.combinationId=combinationId;$(el).find('.combination-quantity input,.combination-quantity select').val(combination.quantity);}}
const quantity=parseInt($(el).find('.combination-quantity input,.combination-quantity select').val());let availabilityInterval=null;$(el).find('.combination-stock').removeClass('uncompleted');$(el).find('.combination-stock').addClass(data.stock>0?'stock-ok':'no-stock');for(let i=this.data.definition.availability?.intervals.length-1;i>-1;i--){const interval=this.data.definition.availability.intervals[i];if(data.stock<=interval.stock){availabilityInterval=interval;}}
if(availabilityInterval){$(el).find('.combination-stock').removeClass('not-init');var name=availabilityInterval.language.name.replace('{{stock}}',data.stock);$(el).find('.combination-stock .availabilityImage').html(`<img src="${availabilityInterval.language.image}" class="availabilityImage" onerror="$(this).remove();">`);$(el).find('.combination-stock .availabilityName').html(name);$(el).find('.combination-stock .availabilityImage').show();$(el).find('.combination-stock .availabilityName').show();}else{$(el).find('.combination-stock .availabilityImage').hide();$(el).find('.combination-stock .availabilityName').hide();}
if(data.stock>0||this.gridData.purchasableWithoutStock){$(el).removeClass('disabled');}});this.el.$form.find('[data-lc-grid-price]').each((i,el)=>{const data=$(el).data('lc-grid-price'),currentCombinationValues=[...data.values].concat(this.optionsSummary.selected.values).sort();let price=this.gridData.prices.product.price,quantity=1;if(this.gridData.prices.showGridPrice=='showGridPriceBothOptions'){quantity=parseInt($(el).parent().find('.combination-quantity input').val());}
if(quantity>1){var priceByQuantityRange=0;$.each(this.gridData.prices.product.pricesByQuantity,(i,priceByQuantity)=>{if(quantity>=parseInt(i)){priceByQuantityRange=priceByQuantity;}});if(priceByQuantityRange>0)price=priceByQuantityRange;}
$.each(currentCombinationValues,(i,value)=>{if(this.gridData.prices.values[value]){let valuePrice=this.gridData.prices.values[value].price;if(quantity>1){var priceByQuantityRange=0;$.each(this.gridData.prices.values[value].pricesByQuantity,(i,priceByQuantity)=>{if(quantity>=parseInt(i)){priceByQuantityRange=priceByQuantity;}});if(priceByQuantityRange>0)valuePrice=priceByQuantityRange;}
price+=valuePrice;}});$(el).find('.combination-price .price').replaceWith(outputHtmlCurrency(price));});}},updateGridData:function(){if(!this.optionsSummary){this.optionsSummary={};this.optionsSummary.valuesOption={};this.optionsSummary.combinableOptions={};this.optionsSummary.combinableValues=[];this.optionsSummary.required=[];this.optionsSummary.showAsGrid=[];$.each(this.data.options,(i,option)=>{if(option.required){this.optionsSummary.required.push(option.id);}
if(option.showAsGrid){this.optionsSummary.showAsGrid.push(option.id);}
if(option.combinable)this.optionsSummary.combinableOptions[option.id]=[];$.each(option.values,(j,value)=>{if(option.combinable){this.optionsSummary.combinableOptions[option.id].push(value);this.optionsSummary.combinableValues.push(value.id);}
this.optionsSummary.valuesOption[value.id]=option.id;});});}
this.optionsSummary.selected=[];this.optionsSummary.selected.options=[];this.optionsSummary.selected.values=[];$.each(this.getFormData().options,(i,option)=>{this.optionsSummary.selected.options.push(parseInt(option.id));$.each(option.values,(j,value)=>{if(value.value)this.optionsSummary.selected.values.push(parseInt(value.value));});});this.checkGridStatus();},checkGridStatus:function(){this.gridData.combinations.status=(this.gridData.combinations.totalStock==0&&!this.gridData.purchasableWithoutStock)?'UNAVAILABLE':'AVAILABLE';$.each(this.optionsSummary.required,(i,option)=>{if(!this.optionsSummary.selected.options.includes(option)&&!this.optionsSummary.showAsGrid.includes(option)){this.gridData.combinations.status='SELECT_OPTION';}});},updateCombinationData:function(){$.each(this.combinationData.options,(i,option)=>{option.missed=!this.optionsSummary.selected.options.includes(option.id)&&!this.optionsSummary.showAsGrid.includes(option.id);});this.combinationData.status=this.gridData.combinations.status;},getQuantityValue:function(def){let minQuantity=1;if(this.el.$quantityField.val()){minQuantity=this.el.$quantityField.val();}else{if(def.minOrderQuantity&&!def.groupQuantityByOptions){minQuantity=def.minOrderQuantity;}
if(def.multipleOrderQuantity>0){if(def.multipleActsOver>0){if(minQuantity>=def.multipleActsOver&&minQuantity%def.multipleOrderQuantity!==0){let difference=minQuantity%def.multipleOrderQuantity;minQuantity=minQuantity+(def.multipleOrderQuantity-difference);}}else{if(minQuantity<def.multipleOrderQuantity){minQuantity=def.multipleOrderQuantity;}else{if(minQuantity%def.multipleOrderQuantity!==0){let difference=minQuantity%def.multipleOrderQuantity;minQuantity=minQuantity+(def.multipleOrderQuantity-difference);}}}}}
return parseInt(minQuantity);},getFormData:function(){const formValues=this.getFormValues();let options={},optionsArray=[],value='',gridOptions=[],attachmentOptions=[];$.each(this.data.options,(i,option)=>{if(option.type=="ATTACHMENT"){attachmentOptions.push(option.id);}});for(let i=0;i<formValues.length;i++){if(!options[formValues[i].name]){options[formValues[i].name]=[];}
value=formValues[i].value;let isAttachmentOption=attachmentOptions.includes(parseInt(formValues[i].name.replace('optionValue','')));try{value=JSON.parse(formValues[i].value);}catch(error){}
if($.type(value)==='object'){options[formValues[i].name].push(value);}else if(!isAttachmentOption||(isAttachmentOption&&formValues[i].value.length>0)){options[formValues[i].name].push({value:formValues[i].value});}}
for(let option in options){let $optionField=this.el.$form.find('#'+option);optionsArray.push({id:option.replace('optionValue',''),values:options[option]});}
if(this.gridData){$.each(this.gridData.combinations.values,(i,el)=>{gridOptions.push({id:i,values:el.optionValueIds,quantity:el.quantity});});}
const response={id:this.data.id,quantity:this.getQuantityValue(this.data.definition),options:optionsArray,gridOptions:gridOptions,alternativeImage:this.alternativeImageField?this.alternativeImageField.value:'',sectionId:this.linkedSectionId,parentHash:this.el.$form.find('input[name="parentHash"]')?.val()||'',discountSelectableGiftId:this.discountSelectableGiftId,mode:this.el.$form.find('#mode').length?this.el.$form.find('#mode').val():'',fromShoppingListRow:this.shoppingListRowId,combinationId:this.combinationData.stock.combinationId,stock:this.combinationData.stock.units};return response;},formIsValid:function(){for(const[key,value]of this.filePluginIsOnError.entries()){if(value!==''){LC.notify(value,{type:'danger'});return false;}}
return this.el.$form.isValid();},submit:function(event){event.preventDefault();this.trigger('submitBefore',event);if(!this.formIsValid())return false;const data=this.getFormData();let sendData=data;let retailPrice=this.el.$form.find('.product-price .price .integerPrice').attr("content");let price=this.el.$form.find('.product-basePrice .price .integerPrice').attr("content");if(retailPrice!=undefined&&price!=undefined){sendData.prices={basePrice:parseFloat(price),retailPrice:parseFloat(retailPrice)}}
LC.resources.pluginListener('onAddProduct',event,sendData);let submitUrl=LC.global.routePaths.BASKET_INTERNAL_ADD_PRODUCT;if(this.gridData){submitUrl=LC.global.routePaths.BASKET_INTERNAL_ADD_PRODUCTS;sendData.mode='UPDATE';sendData.type='GRID';sendData.products=[];sendData.products=[];for(let idx in sendData.options)
if(Object.hasOwn(this.optionsSummary.combinableOptions,sendData.options[idx].id))
delete sendData.options[idx];$.each(this.gridData.combinations.values,(i,combination)=>{var product={};product.id=sendData.id;product.options=[];$.each(combination.optionValueIds,(j,optionValueId)=>{product.options.push({id:`${this.optionsSummary.valuesOption[optionValueId]}`,values:[{'value':`${optionValueId}`}]});});product.options=product.options.concat(sendData.options);product.quantity=combination.quantity;sendData.products.push(product);});delete sendData.gridOptions;delete sendData.alternativeImage;delete sendData.fromShoppingListRow;delete sendData.quantity;delete sendData.sectionId;}else if(this.linkedSectionId>0){submitUrl=LC.global.routePaths.BASKET_INTERNAL_ADD_LINKED;}else if(this.discountSelectableGiftId>0){submitUrl=LC.global.routePaths.BASKET_INTERNAL_ADD_GIFT;sendData.productId=data.id;}
if($(event.originalEvent?.submitter).data('lc-express-checkout-plugin')){sendData.pluginAccountId=$(event.originalEvent.submitter).data('lc-express-checkout-plugin').id;}
$.post(submitUrl,{data:JSON.stringify(sendData)},this.callback,'json');this.el.$buyFormSubmit.prop('disabled',true);this.trigger('submitCallback',event);},callback:function(data){this.trigger('callbackBefore',data.data);var page=$('body').data('lc-page');if(data.data.response.success){if(data.data.data.code=="lockedStock"){this.el.$buyFormSubmit.prop('disabled',true);let expires=data.data.data.expireTime,tipContent=`<div class="stock-lock" id="stockLockTip_${this.data.id}" data-lc-basket-expires='${expires}'>
                         <span>${data.data.data.response}</span>
                     </div>`,remainingSeconds=moment(expires).diff(moment(),'seconds');clearTimeout(this.expirationTimeoutLockedStockReserved);this.expirationTimeoutLockedStockReserved=setTimeout(()=>{this.onChange();},remainingSeconds*1000);this.el.$buyFormSubmit.first().html(LC.global.languageSheet.lockedStockReserved);this.el.$buyFormSubmit.first().before(tipContent);let options={container:this.el.$form.find('.stock-lock'),endDate:expires};new LC.countdown(options);return;}
if(data.data.data.expressCheckoutUrl&&data.data.data.expressCheckoutUrl.length>0){window.location.href=data.data.data.expressCheckoutUrl;return;}
if((this.linkedSectionId>0||this.discountSelectableGiftId>0)&&(page==='checkoutBasket'||page==='checkoutPaymentAndShipping')){$('html, body').animate({scrollTop:0},'slow',function(){window.location.reload(true);});}else{LC.miniBasket.reload();LC.dataEvents.reloadCustomize();}}else{LC.notify(data.data.response.message,{type:'danger'});}
this.enabledButtons.prop('disabled',false);this.trigger('callback',data.data);if(LC.config.showModalBasket&&(LC.global.settings.isMobile===true||window.innerWidth<MEDIA_MOBILE)){var modalContent='';if(data.data.stockLock){modalContent+=`<div class="basketCountdown" data-lc-basket-expires='{"expires": "${data.data.stockLock.expires}"}'>
                         <div class="active">${LC.global.languageSheet.lockedStockRemainingTimePopup}</div>
                         <div class="expired">${LC.global.languageSheet.lockedStockExpiredTimePopUp}</div>
                     </div>`;}
modalContent+=`<div id="modalBasketButtons">
                     <a href="${LC.global.routePaths.CHECKOUT_BASKET}" class="modalBasketEndOrder ${BTN_PRIMARY_CLASS}">${LC.global.languageSheet.basketEndOrder}</a>
                     <a data-dismiss="modal" data-bs-dismiss="modal" class="modalBasketContinueShopping ${BTN_SECONDARY_CLASS}">${LC.global.languageSheet.basketContinueShopping}</a>
                     <a href="${LC.global.routePaths.USER}" class="modalBasketMyAccount ${BTN_SECONDARY_CLASS}">${LC.global.languageSheet.myAccount}</a>
                 </div>`;this.el.$buyFormSubmit.box({uid:'mobileBasketModal',source:modalContent,showFooter:false,triggerOnClick:false,type:'html',size:'small',});}},setPrices:function(combinationData){this.el.$form.find('.product-price, .product-basePrice, .product-saving').each((index,el)=>{const $property=$(el);let price,basePrice,retailPrice,prices=null,lcShowTax=$property.attr('data-lc-show-tax')??'true';if(lcShowTax==='false'){prices=combinationData.prices.prices;}else{prices=combinationData.pricesWithTaxes.prices;}
if(combinationData.prices.pricesByQuantity.length>0){let quantity=this.getQuantityValue(this.data.definition),pricesByQuantity;if(lcShowTax==='false'){pricesByQuantity=combinationData.prices.pricesByQuantity;}else{pricesByQuantity=combinationData.pricesWithTaxes.pricesByQuantity;}
pricesByQuantity.forEach(priceByQuantity=>{if(quantity>=priceByQuantity.quantity){prices=priceByQuantity.prices;}});}
basePrice=prices.basePrice;retailPrice=prices.retailPrice;if(this.data.definition.offer&&basePrice>retailPrice){const saving=basePrice-retailPrice;price=retailPrice;if($property.is('.product-basePrice')||$property.is('.product-saving')){$property.show();}
if($property.is('.product-saving')){$property.find('.price').replaceWith(outputHtmlCurrency(saving));$property.find('.percent').html(((saving*100)/basePrice).toFixed(0));}}else{price=basePrice;if($property.is('.product-basePrice')||$property.is('.product-saving')){$property.hide();}}
if($property.is('.product-price')){$property.find('.price').replaceWith(outputHtmlCurrency(price));}else if($property.is('.product-basePrice')){$property.find('.price').replaceWith(outputHtmlCurrency(basePrice));}});},updatePriceByQuantity:function(selectedOptions){if(!this.el.$priceByQuantityBox.length)return;const selectedIds=[],tableClass=this.el.$priceByQuantityBox.find('table').attr('class'),data=this.el.$priceByQuantityBox.data('lc-data'),incrementRanges=[];let tbody='';selectedOptions.forEach(option=>option.values.forEach(value=>{if(value.selected){selectedIds.push(value.id);for(var key in data){if(key==='optionValueId'+value.id)incrementRanges.push(data[key]);}}}));this.el.$priceByQuantityBox.html('');let ranges={};data.base.forEach(range=>{if(typeof ranges[range.from]==='undefined')
ranges[range.from]=[];ranges[range.from].push({...range,...{increment:false}});});incrementRanges.forEach(rangeGroup=>{rangeGroup.forEach(range=>{if(typeof ranges[range.from]==='undefined')
ranges[range.from]=[];ranges[range.from].push({...range,...{increment:true}});});});let froms=Object.keys(ranges),rangesResult={};froms.forEach(key=>rangesResult[key]=[]);let nRangesPerRow=selectedOptions.length+1;for(let i=0;i<froms.length;i++){const from=froms[i];if(ranges[from].length===nRangesPerRow){rangesResult[from]=ranges[from].reduce((acc,obj)=>{acc.basePrice=(acc.basePrice||0)+obj.basePrice;acc.retailPrice=(acc.retailPrice||0)+obj.retailPrice;acc.from=obj.from;acc.message=undefined;return acc;},{});}
if(ranges[from].length<nRangesPerRow){const thisRanges=ranges[from];let missingItems=nRangesPerRow-ranges[from].length,beforeIndex=i-1,toReduceArray=thisRanges;while(missingItems>0&&beforeIndex>=0){const beforeRanges=ranges[froms[beforeIndex]];const validBeforeRanges=beforeRanges.filter(beforeRange=>beforeRange.optionValueId!==thisRanges[0].optionValueId);toReduceArray=[...toReduceArray,...validBeforeRanges];beforeIndex--;missingItems-=validBeforeRanges.length;}
rangesResult[from]=toReduceArray.reduce((acc,obj)=>{acc.basePrice=(acc.basePrice||0)+obj.basePrice;acc.retailPrice=(acc.retailPrice||0)+obj.retailPrice;acc.from=parseInt(from);acc.message=undefined;return acc;},{});}}
const rangesResultArr=Object.values(rangesResult);for(let i=0;i<rangesResultArr.length;i++){const range=rangesResultArr[i];if(i===rangesResultArr.length-1){range.message=LC.global.languageSheet.equalOrGreaterNUnits.replace('{{n}}',range.from);}else if(i===0&&rangesResultArr[i+1].from===2){range.message=LC.global.languageSheet.oneUnit.replace('{{n}}',range.from);}else if(i===0){range.message=LC.global.languageSheet.equalOrGreaterNUnits.replace('{{n}}',1);}else if(range.from+1===rangesResultArr[i+1].from){range.message=LC.global.languageSheet.nUnits.replace('{{n}}',range.from);}else{range.message=LC.global.languageSheet.equalOrGreaterNUnits.replace('{{n}}',range.from);}
let price=rangesResultArr[i].basePrice,basePriceData='';if(this.data.definition.offer&&rangesResultArr[i].basePrice>rangesResultArr[i].retailPrice&&rangesResultArr[i].retailPrice!=0){price=rangesResultArr[i].retailPrice;basePriceData=`data-base-price="${rangesResultArr[i].basePrice}"`;}
tbody+=`<tr><td class="messageColumn">${range.message}</td><td class="priceColumn" ${basePriceData}>${outputHtmlCurrency(price)}</td></tr>`;}
this.el.$priceByQuantityBox.html(`<table class="${tableClass}"><tbody>${tbody}</tbody></table>`);},fillForm:function(data){this.trigger('fillDataBefore',data);let totalQuantity=0;for(var combinationId in data.combinations){this.gridData.combinations.values[combinationId].quantity=data.combinations[combinationId].quantity;totalQuantity+=data.combinations[combinationId].quantity;this.el.$form.find(`#gridCombination${combinationId}`).find('input[type="text"][name="quantity"]').attr('value',data.combinations[combinationId].quantity);}
this.setGridTotalQuantity(totalQuantity);this.gridData.hasNoCombinableOptions=data.noCombinableOptions.length?true:false;data.noCombinableOptions.forEach(noCombinableOption=>{let optionInput=this.el.$form.find(`[name="optionValue${noCombinableOption.id}"]`);optionInput.each((index,el)=>{if($(el).prop('checked')){$(el).click();}});if(['MULTIPLE_SELECTION','MULTIPLE_SELECTION_IMAGE'].includes(noCombinableOption.type)){noCombinableOption.valueList.forEach((value)=>{optionInput.each((index,el)=>{if(($(el).val()==value.id)){$(el).click();}});});}else if(['BOOLEAN','SINGLE_SELECTION','SINGLE_SELECTION_IMAGE','SELECTOR'].includes(noCombinableOption.type)){optionInput.each((index,el)=>{if(($(el).val()=='true'&&noCombinableOption.value)||($(el).val()=='false'&&!noCombinableOption.value)){$(el).click();}});}else if(noCombinableOption.type=='SHORT_TEXT'||noCombinableOption.type=='LONG_TEXT'){optionInput.val(noCombinableOption.value);}else if(noCombinableOption.type=='DATE'){optionInput.val(noCombinableOption.value);this.el.$form.find(`[id="viewDateValue${noCombinableOption.id}"]`).val(moment(noCombinableOption.value).format(optionInput.parent().find('[data-format]').attr('data-format')));}else if(noCombinableOption.type=='ATTACHMENT'){this.el.$form.find(`[id="productOptionAttachmentValue${noCombinableOption.id}"]`).hide();this.el.$form.find(`[id="optionValueInputFile${noCombinableOption.id}"]`).prop('disabled',true);this.el.$form.find(`[id="productOptionAttachmentButtons${noCombinableOption.id}"]`).show();this.el.$form.find(`[id^="viewOptionAttachment${noCombinableOption.id}_"]`).hide();noCombinableOption.values.forEach((value,index)=>{this.el.$form.find(`[id="optionValue${noCombinableOption.id}_${index + 1}"]`).val(value);let $viewOptionAttachment=this.el.$form.find(`[id="viewOptionAttachment${noCombinableOption.id}_${index + 1}"]`);$viewOptionAttachment.attr('data-lc-attachment-path',value);$viewOptionAttachment.html(value.split('_',2)[1]);$viewOptionAttachment.show();LC.global.languageSheet.attachFileOpen.replace('{{fileName}}',value);});}});if(totalQuantity>0){this.filledForm=true;}
this.onChange(false);this.trigger('callback',data);},},LC.buyFormResources);LC.FilterShoppingListRows=LC.Form.extend({name:'filterShoppingListRows',submitted:false,initialize:function(form){if(this.el.$form.data('lc-autosubmit')){this.el.$form.on('change','select',(event)=>{this.submit(event);});}else{this.el.$form.on('submit',this.submit.bind(this));}},hasBeenSubmitted:function(){return this.submitted;},submit:function(event){this.trigger('submitBefore');event.preventDefault();this.submitted=true;this.el.form.submit();this.trigger('submitCallback');},});LC.CountriesLinksForm=LC.Form.extend({name:'countriesLinksForm',initialize:function(form){this.$country=this.el.$form.find('#country');this.$country.prop('disabled',false);this.$language=this.el.$form.find('#language');this.$languageOptions=this.$language.find('option');this.$languageOptions.hide();this.submitButton=this.el.$form.find('button[type="submit"], input[type="submit"]');if(this.$country.val()!='default'){this.$language.prop('disabled',false);if(this.$language.val()!='default'){this.submitButton.prop('disabled',false);}}else{this.submitButton.prop('disabled',true);}
this.$country.on('change',(event)=>{this.$languageOptions.hide();this.submitButton.prop('disabled',true);if($(event.target).val()=='default'){this.$language.prop('disabled',true);}else{this.$languageOptions.each((index,el)=>{if($(el).val().startsWith($(event.target).val()+'-')||$(el).val()=='default'){$(el).show();}});this.$language.prop('disabled',false);}
this.$language.val('default');});this.$language.on('change',(event)=>{this.submitButton.prop('disabled',false);if($(event.target).val()=='default'){this.submitButton.prop('disabled',true);}});},submit:function(event){this.trigger('submitBefore',this);if(this.el.$form.data('lc-accept-route-warning')){LC.dataEvents.acceptRouteWarning();}
event.preventDefault();this.data=this.el.$form.find(`[value='${this.$language.val()}']`).data('lc');if(this.data.needCallSetCountry){this.el.$form.find('input[name="countryCode"]').val(this.$country.val());this.superForm('submit',event);}else{window.location=this.data.url;}},onReceive:function(data){this.trigger('onReceiveBefore',data);if(data.data.response.success==1){window.location=this.data.url;}
this.superForm('onReceive',data);this.trigger('onReceiveAfter',data);}});
'use strict';LC.fn('box',{options:{uid:null,showFooter:true,showHeader:false,showClose:true,source:'',type:'html',triggerOnClick:true,params:false,modalClass:'',verticalPosition:true,backdrop:true,keyboard:true,size:'medium',callback:null,keepSrc:false,headerTitle:'',},Constructor:function(element,options){var type=element.data('lcModalType')||options.type;options.showFooter=element.data('lcModalShowfooter')||options.showFooter;options.showHeader=element.data('lcModalShowheader')||options.showHeader;options.size=element.data('lcModalSize')||options.size;options.triggerOnClick=element.data('lcModalTriggeronclick')||options.triggerOnClick;options.verticalPosition=element.data('lcModalVerticalposition')||options.verticalPosition;options.keepSrc=element.data('lcModalKeepSrc')||options.keepSrc;var modalSize='';if(options.size=='small')modalSize=' modal-sm';if(options.size=='large')modalSize=' modal-lg';var uid=element.data('lcModalUid')
if(!uid)uid=options.uid||String.fromCharCode(65+Math.floor(Math.random()*26))+Date.now();this.init=function(){var source=options.source||element.data('lcModal');var $box=(this.box=_createBox());var $container=$($box.find('div.lcModalContainer')[0]);var callback=options.callback||element.data('lcModalCallback');element.data('target','#'+uid);if(options.triggerOnClick){element.off('click.boxTrigger').on('click.boxTrigger',(event)=>{event.preventDefault();_trigger(type,source,$container,$box,callback);});}else{_trigger(type,source,$container,$box,callback);this.dataTrigger={type:type,source:source,container:$container,box:$box,callback:callback,};}
element.data('boxuid',uid);if(!options.keepSrc){$box.on('hidden.bs.modal',function(ev){$container.html('');});}};this.close=function(){if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(this.box).hide();}else{this.box.modal('hide');}};this.openBox=function(){if(this.dataTrigger){var data=this.dataTrigger;_trigger(data.type,data.source,data.container,data.box,data.callback);}};function _createBox(){var $body=$('body');var $box=$body.children('#'+uid);if(!$box.length){var box='<div id="'+uid+'" class="lcModal lcModalDynamic modal fade  '+options.modalClass+'" tabindex="-1" role="dialog" aria-hidden="true">';box+='<div class="modal-dialog '+modalSize+(options.verticalPosition?' modal-dialog-centered':'')+'">';box+='<div class="modal-content">';if(options.showHeader){box+=`<div class="modal-header">`;if(options.headerTitle.length){box+=`<div class="modal-title">${options.headerTitle}</div>`;}
if(options.showClose&&options.backdrop!='static'){box+=`<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="${LC.global.languageSheet.close}"></button>`;}
box+=`</div>`;}
box+='<div class="modal-body">';if(options.showClose&&options.backdrop!='static'&&!options.showHeader){box+=`<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="${LC.global.languageSheet.close}"></button>`;}
box+='<div class="lcModalContainer"></div>';if(options.showFooter&&options.backdrop!='static'){box+='<div class="modal-footer">';box+='<button type="button" class="'+BTN_SECONDARY_CLASS+' lcModalClose" data-dismiss="modal" data-bs-dismiss="modal">'+LC.global.languageSheet.close+'</button>';box+='</div>';}
box+='</div></div></div></div>';$body.append(box);$box=$body.children('#'+uid);}
return $box;}
function _trigger(type,source,$container,$box,callback){const modalOptions={show:true,keyboard:options.keyboard,backdrop:options.backdrop,keepSrc:options.keepSrc};switch(type){case'html':$container.html(source);modal($box,modalOptions);_callback(callback,element,$box);break;case'internal':$container.html(element);modal($box,modalOptions);_callback(callback,element,$box);break;case'url':default:const loadCallback=()=>{if($container.html().length>1){modal($box,modalOptions);$container.ready(function(){_callback(callback,element,$box);});}};if((!modalOptions.keepSrc)||(modalOptions.keepSrc&&$container.html().length==0)){const intTimeStamp=new Date().getTime();source+=(source.indexOf('?')>0?'&':'?')+'noCache='+intTimeStamp;$container.load(source,options.params,loadCallback);}else{loadCallback();}
break;}}
function _callback(callback,element,$box){if(!callback)return;if(typeof callback==='function')callback(element,$box);else if(typeof LC.modalCallbacks[callback]==='function')LC.modalCallbacks[callback](element,$box);}
function modal(element,options){if(typeof bootstrap!=='undefined'){var modalInstance=bootstrap.Modal.getInstance(element)??new bootstrap.Modal(element,options);modalInstance.show();}else{element.modal(options);}}},});LC.initializeModals=function(){$('[data-lc-required]').each(function(index,el){if(!$($(this).data('lc-required').el).length)
console.error('Missing "'+$(this).data('lc-required').el+'" modal of "'+$(this).data('lc-required').macro+'" macro!');});$('.lcModal').not('.lcModalDynamic').on('show.bs.modal',function(event){var callbackName=$(this).data('lc-modal-callback');if(typeof LC.modalCallbacks[callbackName]==='function')LC.modalCallbacks[callbackName]($(event.target),$(this));});$('.legalPopup[data-lc-modal]').box({type:"url",size:"large",});};LC.modalCallbacks={userSendWishlistCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({submit:function(event){event.preventDefault();if(!this.el.$form.find('input[name="productId"]:checked').length){LC.notify(LC.global.languageSheet.sendWishlistSelectProductError,{type:'danger'});return false;}
this.superForm('submit',event);},callback:function(data){let message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}
modal.find('form')[0].reset();modal.find('.wishlistProduct .active').removeClass('active');}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.find('input[type="checkbox"]').on('click',function(){const $label=$(this).closest('label');if(this.checked)$label.addClass('active');else $label.removeClass('active');const productIdList=Array.from(modal[0].querySelectorAll('input[type=checkbox]:checked')).map((el)=>el.value).join(',');modal.find('[name="productIdList"]').val(productIdList);});modal.data('init',true);}},userDeleteWishlistCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({submit:function(event){event.preventDefault();if(!this.el.$form.find('input[name="productIdList"]')[0].value.length){LC.notify(LC.global.languageSheet.deleteWishlistSelectProductError,{type:'danger'});return false;}
this.superForm('submit',event);},callback:function(data){let message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}
location.reload();}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.find('input[type="checkbox"]').on('click',function(){const $label=$(this).closest('label');if(this.checked)$label.addClass('active');else $label.removeClass('active');const productIdList=Array.from(modal[0].querySelectorAll('input[type=checkbox]:checked')).map((el)=>el.value).join(',');modal.find('[name="productIdList"]').val(productIdList);});modal.data('init',true);}},userSendShoppingListRowsCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({submit:function(event){event.preventDefault();if(!this.el.$form.find('input[name="shoppingListRow"]:checked').length){LC.notify(LC.global.languageSheet.sendShoppingListRowsSelectRowError,{type:'danger'});return false;}
this.superForm('submit',event);},callback:function(data){let message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}
const $name=modal.find('input[name="name"]'),$email=modal.find('input[name="email"]'),$nameVal=$name.val(),$emailVal=$email.val();modal.find('form')[0].reset();$name.val($nameVal);$email.val($emailVal);modal.find('.shoppingListRow .active').removeClass('active');}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.find('input[type="checkbox"]').on('click',function(){const $label=$(this).closest('label');if(this.checked)$label.addClass('active');else $label.removeClass('active');var items=[];modal.find('input[name="shoppingListRow"]:checked').each(function(index,el){items.push(JSON.parse($(el).val()));});modal.find('[name="items"]').val(JSON.stringify(items));});modal.data('init',true);}},userDeleteShoppingListRowsCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({submit:function(event){event.preventDefault();if(!this.el.$form.find('input[name="rowIdList"]')[0].value.length&&!this.el.$form.find('input[name="productIdList"]')[0].value.length&&!this.el.$form.find('input[name="bundleIdList"]')[0].value.length){LC.notify(LC.global.languageSheet.deleteShoppingListSelectRowError,{type:'danger'});return false;}
this.superForm('submit',event);},callback:function(data){let message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}
location.reload();}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.find('input[type="checkbox"]').on('click',function(){const $label=$(this).closest('label');if(this.checked)$label.addClass('active');else $label.removeClass('active');const rowIdList=Array.from(modal[0].querySelectorAll('input[name=deleteShoppingListRowId][type=checkbox]:checked')).map((el)=>el.value).join(',');modal.find('[name="rowIdList"]').val(rowIdList);const productIdList=Array.from(modal[0].querySelectorAll('input[name=deleteShoppingListProductId][type=checkbox]:checked')).map((el)=>el.value).join(',');modal.find('[name="productIdList"]').val(productIdList);const bundleIdList=Array.from(modal[0].querySelectorAll('input[name=deleteShoppingListBundleId][type=checkbox]:checked')).map((el)=>el.value).join(',');modal.find('[name="bundleIdList"]').val(bundleIdList);});modal.data('init',true);}},userEditShoppingListRowNotesCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({submit:function(event){event.preventDefault();this.superForm('submit',event);},callback:function(data){let message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}
const shoppingListRow=data.data;let importance=shoppingListRow.importance.toLowerCase();importance=importance.charAt(0).toUpperCase()+importance.slice(1);$('[data-lc=editShoppingListRowNotesComment'+shoppingListRow.id+']').html(shoppingListRow.comment);$('[data-lc=editShoppingListRowNotesQuantity'+shoppingListRow.id+']').html(shoppingListRow.quantity);$('[data-lc=editShoppingListRowNotesImportance'+shoppingListRow.id+']').html(LC.global.languageSheet['shoppingListRowImportance'+importance]);$('[data-lc=editShoppingListRowNotesButton'+shoppingListRow.id+']').data("lc-data",shoppingListRow);}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.data('init',true);}},userAddShoppingListRowNotesCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({submit:function(event){event.preventDefault();this.superForm('submit',event);},callback:function(data){let message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(LC.global.languageSheet.saved,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}
let $newRow=$.parseHTML(JSON.parse(message).replaceAll('&#39;',"'"));$('#'+$('#addShoppingListRowNotesButton').data("lc-rows-container-id")).prepend($newRow);LC.initializeForms();$('[data-lc-quantity]').quantity();$('[data-lc-event]').dataEvent();LC.initializeModals();}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.data('init',true);}},userSetShoppingListCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({submit:function(event){event.preventDefault();this.superForm('submit',event);},callback:function(data){let message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}
const shoppingList=data.data;$('[data-lc=setShoppingListName'+shoppingList.id+']').html(shoppingList.name);$('[data-lc=setShoppingListDescription'+shoppingList.id+']').html(shoppingList.description);$('[data-lc=setShoppingListKeepPurchasedItems'+shoppingList.id+']').html(shoppingList.keepPurchasedItems?LC.global.languageSheet.shoppingListKeepPurchasedItems:'');$('[data-lc=setShoppingListDefaultOne'+shoppingList.id+']').html(shoppingList.defaultOne?LC.global.languageSheet.shoppingListDefaultOne:'');$('[data-lc=setShoppingListButton'+shoppingList.id+']').data("lc-data",shoppingList);if(shoppingList.defaultOne){$('[data-lc=deleteShoppingListButton'+shoppingList.id+']').hide();}else{$('[data-lc=deleteShoppingListButton'+shoppingList.id+']').show();}}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.data('init',true);}},productRecommendCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({callback:function(data){var message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.data('init',true);}},recommendCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({callback:function(data){var message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.data('init',true);}},productContactCallback:function(element,modal){const initialized=modal.data('init');if(typeof initialized==='undefined'){const Form=LC.Form.extend({callback:function(data){var message=LC.global.languageSheet.error,success=0;if(typeof data!=='undefined'){if(data.data)data=data.data;if(data.response){message=data.response.message;success=data.response.success?data.response.success:0;}}
if(success){LC.notify(message,{type:'success'});if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}}else{LC.notify(message,{type:'danger'});}},});$.validate(LC.validateFormConf);new Form(modal.find('form')[0]);modal.data('init',true);}},legalPopup:function(element,modal){$(modal).find('[data-lc-event]').dataEvent();},orderReturnCallback:function(element,modal){modal.on('hidden.bs.modal',function(){if(modal.form.hasBeenSubmitted())location.reload();});modal.form=new LC.OrderReturnForm(F('#orderReturnForm'));},newsletterPopup:function(element,modal){},selectCountryPopup:function(element,modal){new LC.CountrySelectorForm($(modal).find('form')[0]);},confirmAgePopupFormCallback:function(element,modal){new LC.ConfirmAgePopupForm($(modal).find('form')[0]);},selectMapKind:function(element,modal){new LC.SelectMapKindForm($(modal).find('form')[0]);},modalUserAddressBook:function(element,modal){var objUserAddressBookForm=F('#userAddressBookForm');new LC.userAddressBookForm(objUserAddressBookForm);},newsletterCustomRegistration:function(element,modal){var objUserForm=F('#userForm');new LC.UserForm(objUserForm);},stockLockPopup:function(element,modal){LC.initializeCountdowns();modal.find('[data-lc-event]').dataEvent();},incidenceFormCallback:function(element,modal){new LC.incidenceForm(modal.find('form')[0]);},settingsUserLostPasswordCallback:function(element,modal){new LC.LostPasswordForm(modal.find('form')[0]);},deleteAddressBookConfirmCallback:function(element,modal){modal.find('.deleteAddressButtonConfirm').click(function(event){var data=element.data('lc-data');if(data.defaultAddress){LC.notify(LC.global.languageSheet.cantDeleteDefaultAddress,{type:'danger'});return false;}
var deleteAddressBookCallback=function(response){if(response.data.response.success===1){var addressId=response.data.data.id;var $address=$('#addressBookContainer_'+addressId);var $container=$address.closest('.content');if(typeof bootstrap!=='undefined'){bootstrap.Modal.getInstance(modal).hide();}else{modal.modal('hide');}
$address.remove();if($container.find('.addressBook').length===0){$container.html('<span class="notAvailableAddress">'+LC.global.languageSheet.notAvailableAddress+'</span>');}}};$.post(LC.global.routePaths.USER_INTERNAL_DELETE_ADDRESS_BOOK,{data:JSON.stringify({id:data.id})},deleteAddressBookCallback,'json');});},};LC.productCountdown=function(idAttr){this.init(idAttr);};$.extend(true,LC.productCountdown.prototype,{counter:0,template:null,elementId:null,categoryId:null,callbackType:'reload',endDate:null,currentTime:null,diffTime:null,duration:null,interval:1000,init:function(idAttr){if(typeof moment==='undefined'){throw"Moment JS library doesn't exist";}
this.$element=$(`#${idAttr}`);if(typeof this.$element.data('lc-initialized')!=='undefined')return
if(!this.$element.length)return;const data=this.$element.data('lc-countdown');this.$element.data('lc-initialized',true);if(typeof data!=='object'||!'startDate'in data||!'endDate'in data||!'template'in data){throw"[data-lc-countdown] error";}
if('callbackType'in data)this.callbackType=data.callbackType;if(this.callbackType=='goBack'&&'categoryId'in data)this.categoryId=data.categoryId;this.template=data.template;this.endDate=moment(data.endDate).unix();this.currentTime=moment(data.startDate).unix();this.diffTime=this.endDate-this.currentTime;this.duration=moment.duration(this.diffTime*this.interval,'milliseconds');this.$element.find('.countdown-content').html('');this.showTime();},showTime:function(){this.duration=moment.duration(this.duration-this.interval,'milliseconds');if(this.duration.as('milliseconds')===0){switch(this.callbackType){case'reload':location.reload();break;case'goBack':if(!isNaN(this.categoryId))location.href=LC.global.routePaths.CATEGORY+this.categoryId.toString();else location.reload();break;default:this.$element.find('.countdown-content').html('');}
return;}
this.$element.find('.countdown-content').html(this.formatTime(this.duration));setTimeout(()=>{this.showTime();},this.interval);},formatTime:function(duration){return this.template.replace(/{{years}}/gi,duration.years()).replace(/{{months}}/gi,duration.months()).replace(/{{weeks}}/gi,duration.weeks()).replace(/{{days}}/gi,duration.days()).replace(/{{hours}}/gi,duration.hours()<10?'0'+duration.hours():duration.hours()).replace(/{{minutes}}/gi,duration.minutes()<10?'0'+duration.minutes():duration.minutes()).replace(/{{seconds}}/gi,duration.seconds()<10?'0'+duration.seconds():duration.seconds())},});LC.fn('dataEvent',{Constructor:function(element,options){var strElementEvent=element.data('lcEvent');var strElementFunction=element.data('lcFunction');if(typeof LC.dataEvents[strElementFunction]!=='function')return;switch(strElementEvent){case'click':element.click(LC.dataEvents[strElementFunction].bind(this));break;case'keypress':element.keypress(LC.dataEvents[strElementFunction].bind(this));break;case'change':element.on('change',LC.dataEvents[strElementFunction].bind(this));break;case'load':LC.dataEvents[strElementFunction](element,options);break;}
element.data('lcEvent',null);},});LC.dataEvents={};LC.dataEvents.viewDocument=function(event){var data=$(event.currentTarget).data('lc-data'),documentPath='',name='_blank',properties='';if(data.pdf===true){if(data.documentType=='order')documentPath=LC.global.routePaths.RESOURCES_INTERNAL_ORDER_PDF;else if(data.documentType=='deliveryNote')documentPath=LC.global.routePaths.USER_INTERNAL_DELIVERY_NOTE_PDF;else if(data.documentType=='invoice')documentPath=LC.global.routePaths.USER_INTERNAL_INVOICE_PDF;else if(data.documentType=='rma')documentPath=LC.global.routePaths.USER_INTERNAL_RMA_PDF;else if(data.documentType=='return')documentPath=LC.global.routePaths.USER_INTERNAL_RMA_RETURNS_PDF;else if(data.documentType=='correctiveInvoice')documentPath=LC.global.routePaths.USER_INTERNAL_RMA_CORRECTIVE_INVOICE_PDF;}else{name='viewDocument',properties='menubar=1,resizable=1,scrollbars=1,width=800,height=600';if(data.documentType=='order')documentPath=data.session?LC.global.routePaths.USER_ORDER+data.documentId:LC.global.routePaths.USER_ORDER+data.documentId+'?token='+data.token;else if(data.documentType=='deliveryNote')documentPath=LC.global.routePaths.USER_INTERNAL_DELIVERY_NOTE;else if(data.documentType=='returnTracing')documentPath=LC.global.routePaths.USER_INTERNAL_RETURN_TRACING;else if(data.documentType=='invoice')documentPath=LC.global.routePaths.USER_INTERNAL_INVOICE;else if(data.documentType=='returnForm')documentPath=LC.global.routePaths.USER_INTERNAL_RETURN;else if(data.documentType=='rma')documentPath=LC.global.routePaths.USER_INTERNAL_RMA;else if(data.documentType=='return')documentPath=LC.global.routePaths.USER_INTERNAL_RMA_RETURNS;else if(data.documentType=='correctiveInvoice')documentPath=LC.global.routePaths.USER_INTERNAL_RMA_CORRECTIVE_INVOICE;}
if(data.pdf===true||data.documentType!='order'){documentPath=documentPath+'?id='+data.documentId+(data.session?'':'&token='+data.token);}
window.open(documentPath,name,properties);};LC.dataEvents.getReturnRequestForm=function(event){const data=$(event.currentTarget).data('lc-data');const documentPath=LC.global.routePaths.USER_INTERNAL_RETURN+'?id='+data.documentId+(data.session?'':'&token='+data.token);const url=documentPath;const returnOrderPopup=$(`#returnProductsPopup${data.documentId} .lcModalContainer`).html(DEFAULT_LOADING_SPINNER);$().ready(function(){$.ajax({type:"GET",url:url,crossDomain:true,success:function(data){returnOrderPopup.html(data);const form=returnOrderPopup.find('[data-lc-form="returnRequestForm"]')[0];if(typeof form!=='undefined'){new LC.ReturnRequestForm(form);}},error:function(xhr,ajaxOptions,thrownError){console.log('xHR: '+xhr);console.log('ajaxOption: '+ajaxOptions);console.log('thrownError: '+thrownError);}});});};LC.dataEvents.oauth=function(event){event.preventDefault();var data=$(event.currentTarget).data('lc-data');var name='_blank';var documentPath=LC.global.routePaths.USER_OAUTH+'?pluginModule='+data.plugin;var properties='menubar=1,resizable=1,scrollbars=1,width=800,height=600';window.open(documentPath,name,properties);}
LC.dataEvents.expressCheckout=function(event){event.preventDefault();var lcData=$(event.currentTarget).data('lc-data');$.post(LC.global.routePaths.CHECKOUT_INTERNAL_EXPRESS_CHECKOUT,{data:JSON.stringify({id:lcData.id,action:lcData.action,pluginModule:lcData.pluginModule})},(data)=>{lcData.preventSubmit=false;LC.resources.pluginListener('beforeExpressCheckoutRedirect',event,data,lcData);if(lcData.preventSubmit==true){return;}
if(data.data.response.success===1&&data.data.data.redirectUrl&&data.data.data.redirectUrl.length>0){window.location.href=data.data.data.redirectUrl;return;}else{LC.notify(data.data.response.message,{type:'danger'});}},'json');}
LC.dataEvents.viewAllShipments=function(event){event.preventDefault();const data=$(event.currentTarget).data('lc-data'),documentPath=LC.global.routePaths.USER_INTERNAL_ORDER_SHIPMENTS,popup=$('#viewShipmentsOrder'+data.documentId).html(DEFAULT_LOADING_SPINNER),url=documentPath+'?id='+data.documentId;$().ready(function(){$.ajax({type:"GET",url:url,crossDomain:true,success:function(html){popup.html(html);},error:function(xhr,ajaxOptions,thrownError){console.log('xHR: '+xhr);console.log('ajaxOption: '+ajaxOptions);console.log('thrownError: '+thrownError);}});});}
LC.dataEvents.viewDocumentPopup=function(event){event.preventDefault();var data=$(event.currentTarget).data('lc-data');var documentType=data.documentType;var documentPath;switch(documentType){case'order':documentPath=LC.global.routePaths.USER_ORDER;break;case'invoice':documentPath=LC.global.routePaths.USER_INTERNAL_INVOICE;break;case'rma':documentPath=LC.global.routePaths.USER_INTERNAL_RMA;break;case'return':documentPath=LC.global.routePaths.USER_INTERNAL_RMA_RETURNS;break;case'correctiveInvoice':documentPath=LC.global.routePaths.USER_INTERNAL_RMA_CORRECTIVE_INVOICE;break;}
var url=documentPath;if(documentType!='order'){url+='?id='+data.documentId;}else{url+=data.documentId;}
var popup=$('#viewpopup'+documentType+data.documentId).html(DEFAULT_LOADING_SPINNER);$().ready(function(){$.ajax({type:"GET",url:url,crossDomain:true,success:function(html){var document=$(html).find('.document');popup.html(document);},error:function(xhr,ajaxOptions,thrownError){console.log('xHR: '+xhr);console.log('ajaxOption: '+ajaxOptions);console.log('thrownError: '+thrownError);}});});};LC.dataEvents.salesAgentSales=function(event){event.preventDefault();var data=$(event.currentTarget).data('lc-data');var tokenParam=(data.session?'':'&token='+data.token);var url=`${LC.global.routePaths.USER_INTERNAL_SALES_AGENT_CUSTOMER_ORDERS}?customerId=${data.customerId}&fromDate=${moment(data.fromDate).format('YYYY-MM-DD')}&toDate=${moment(data.toDate).format('YYYY-MM-DD')}${tokenParam}`;var popup=$('#salesAgentSales'+data.customerId).html(DEFAULT_LOADING_SPINNER);$().ready(function(){$.ajax({type:"GET",url:url,crossDomain:true,success:function(html){var salesAgentCustomersOrders=$(html).find('.salesAgentCustomersOrders');popup.html(salesAgentCustomersOrders);popup.find('[data-lc-event]').dataEvent();},error:function(xhr,ajaxOptions,thrownError){console.log('xHR: '+xhr);console.log('ajaxOption: '+ajaxOptions);console.log('thrownError: '+thrownError);}});});}
LC.dataEvents.salesAgentSaleOrder=function(event){event.preventDefault();var name='_blank';var data=$(event.currentTarget).data('lc-data');var documentPath=LC.global.routePaths.USER_ORDER+data.documentId+(data.session?'':'&token='+data.token);var properties='menubar=1,resizable=1,scrollbars=1,width=1100,height=800';window.open(documentPath,name,properties);}
LC.dataEvents.recoverOrder=function(event){event.preventDefault();var data=$(event.currentTarget).data('lc-data');$.post(LC.global.routePaths.USER_INTERNAL_RECOVERY_BASKET+'?id='+data.documentId,{},function(data){if(data.data.response.success===1){location.href=LC.global.routePaths.CHECKOUT_BASKET;}},'json');};LC.dataEvents.setCurrency=function(event){event.preventDefault();var data=$(event.currentTarget).data('lc-data');$.post(LC.global.routePaths.USER_INTERNAL_SET_CURRENCY,{data:JSON.stringify({code:escape(data.code)}),},function(data){if(data.data.response.success===1){location.reload();}},'json');};LC.dataEvents.deleteProductComparison=function(event){event.preventDefault();var id=$(event.currentTarget).data('lc-data');$.post(LC.global.routePaths.PRODUCT_COMPARISON_INTERNAL_DELETE_COMPARISON_PRODUCT,{data:JSON.stringify({id:id})},function(data){var notifyType=data.data.response.success==1?'success':'danger',notifyMsg=data.data.response.message;if(data.data.response.success===1){LC.productComparisonDetail.deleteTableItem(id);LC.productComparisonDetail.reload();}
if('errorCode'in data.data.data){notifyType='danger';}
if(data.data.data.errorCode==='A01000-PRODUCT_NOT_FOUND'){notifyMsg=LC.global.languageSheet.errorCodeProductComparisonProductNotFound;}else if(data.data.data.errorCode==='A01000-PRODUCT_COMPARISON_ADD_PRODUCT_EXISTS'){notifyMsg=LC.global.languageSheet.errorCodeProductComparisonProductAlreadyExists;}
LC.notify(notifyMsg,{type:notifyType});},'json');};LC.dataEvents.logout=function(event){event.preventDefault();$.post(LC.global.routePaths.USER_INTERNAL_LOGOUT,{},function(data){if(data.data.response.success===1){location.href=LC.global.routePaths.HOME;}},'json');};LC.dataEvents.loginSimulation=function(event){event.preventDefault();var data=$(event.currentTarget).data('lc-data');$.post(LC.global.routePaths.USER_INTERNAL_LOGIN_SIMULATION+'?customerId='+data.customerId,{},function(data){if(data.data.response.success===1){location.href=LC.global.routePaths.HOME;}},'json');};LC.dataEvents.logoutSimulation=function(event){event.preventDefault();$.post(LC.global.routePaths.USER_INTERNAL_LOGOUT_SIMULATION,{},function(data){if(data.data.response.success===1){location.href=LC.global.routePaths.HOME;}},'json');};LC.fn('quantity',{Constructor:function(element,options){this.fieldName=LC.uniqueId.get(element.data('lcQuantity'));this.init=function(){this.forceMinZero=element.data('force-min-zero');this.minValue=parseInt(element.attr('min'));this.maxValue=parseInt(element.attr('max'));this.multipleValue=parseInt(element.attr('multipleValue'))||1;this.multipleFrom=parseInt(element.attr('multipleFrom'))||1;this.$container=$('<div/>',{class:'input-group input-group-quantity'});this.$minus=$('<span/>',{class:'input-group-btn'});this.$plus=$('<span/>',{class:'input-group-btn'});this.$minusBtn=$('<button />',{type:'button',class:BTN_SECONDARY_CLASS+' btn-number','data-type':'minus','data-field':this.fieldName,html:'<span class="glyphicon glyphicon-minus"></span>',}).appendTo(this.$minus).click(this.clickBtn.bind(this));this.$plusBtn=$('<button />',{type:'button',class:BTN_SECONDARY_CLASS+' btn-number','data-type':'plus','data-field':this.fieldName,html:'<span class="glyphicon glyphicon-plus"></span>',}).appendTo(this.$plus).click(this.clickBtn.bind(this));if(!element[0].hasAttribute('name')){element.attr({name:this.fieldName});}
element.attr('type','text').addClass(FORM_CONTROL_CLASS+' input-number').after(this.$container).change(this.changeField.bind(this)).focus(this.focusField.bind(this)).blur(this.changeField.bind(this));element.removeAttr('data-lc-quantity');this.$container.append(this.$minus).append(element).append(this.$plus);};this.destroy=function(){this.$container.after(element);this.$container.remove();};this.clickBtn=function(event){event.preventDefault();var $this=$(event.currentTarget),type=$this.attr('data-type'),currentVal=parseInt(element.val()),resultVal=!isNaN(currentVal)?currentVal:this.minValue,difference=parseInt(currentVal)+parseInt(this.multipleValue),difference=difference%this.multipleValue;if(!isNaN(currentVal)){if(type==='minus'){if(currentVal<=this.minValue){if(this.forceMinZero){resultVal=0;}else{resultVal=this.minValue;}}else if(currentVal>this.minValue){if(this.multipleValue>1){if(difference!=0){var value=currentVal-difference;}else{var value=currentVal-this.multipleValue-difference;}
if(value<this.multipleFrom&&currentVal>this.multipleFrom){resultVal=this.minValue;}else if(value>=this.minValue){if(this.multipleFrom<=value){resultVal=value;}else{resultVal=currentVal-1;}}else{resultVal=currentVal-1;}}else{resultVal=currentVal-1;}}}else if(type==='plus'){if(currentVal<this.minValue){resultVal=this.minValue;}else if(currentVal<this.maxValue){if(this.multipleValue>1){var value=(currentVal+this.multipleValue)-difference;if(value<=this.maxValue){if(this.multipleFrom<=value&&(currentVal+1)>=this.multipleFrom){resultVal=value;}else{resultVal=currentVal+1;}}}else{resultVal=currentVal+1;}}}
$this.attr('disabled',resultVal<=this.minValue);$this.attr('disabled',resultVal>=this.maxValue);}
element.val(resultVal).change();};this.focusField=function(){element.data('oldValue',element.val());this.oldValue=element.val();};this.isValidCurrentValue=function(currentVal){if(currentVal>this.maxValue){return false;}else{if(currentVal<this.minValue){if(this.forceMinZero){if(currentVal===0){return true;}else{return false;}}else{return false;}}else{if(this.multipleValue>1){if(this.multipleFrom){if(currentVal>=this.multipleFrom){if(currentVal%this.multipleValue===0){return true;}else{return false;}}else{return true;}}else{if(currentVal%this.multipleValue===0){return true;}else{return false;}}}else{return true;}}}};this.changeField=function(){var currentVal=parseInt(element.val());if(currentVal>=this.minValue){this.$minusBtn.removeAttr('disabled');}
if(currentVal<=this.maxValue){this.$plusBtn.removeAttr('disabled');}
if(!this.isValidCurrentValue(currentVal)){if(this.oldValue!=undefined){element.val(this.oldValue);}}};},});LC.fn('notify',{options:LC.config.notify,Constructor:function(element,options){var notify=this;notify.init=function(){if(LC.global.settings.isMobile===true)options.type='info';element.addClass('lcNotify lcNotify-'+options.type);notify.notes=0;};notify.show=function(opts){var opts=$.extend({id:'note-'+notify.notes++,type:false,title:false,message:'',sticky:false,speed:options.speed,delay:options.delay,easing:options.easing,effect:options.effect,icon:false,successIcon:options.successIcon,dangerIcon:options.dangerIcon,removeIcon:options.removeIcon,},opts);var $note=$('<div />',{class:'note '+opts.id+(opts.type?' note-'+opts.type:''),});if(opts.icon){$('<span />',{class:'icon',html:$(opts.icon),}).appendTo($note);}
if(opts.type==='success'&&opts.successIcon.length){$(opts.successIcon).prependTo($note);}
if(opts.type==='danger'&&opts.dangerIcon.length){$(opts.dangerIcon).prependTo($note);}
var $content=$('<div>',{class:'content',});if(opts.title){$('<strong />',{class:'title',html:opts.title,}).appendTo($content);}
$content.append(opts.message);$note.append($content);$('<button />',{type:'button',class:'notifyRemove',html:opts.removeIcon,}).appendTo($note);element.prepend($note);if(!opts.sticky){var noteTimer=new closeTimer($note,opts);element.on('mouseover','.'+opts.id,function(){noteTimer.pause();});element.on('mouseout','.'+opts.id,function(){noteTimer.resume();});}
element.on('click','.notifyRemove',function(){$(this).closest('.note').animate({opacity:0,},opts.speed,opts.easing).slideUp(opts.speed,function(){$(this).remove();});});};notify.close=function(content,opts){switch(opts.effect){case'fade':content.animate({opacity:0,},opts.speed,opts.easing).slideUp(opts.speed,function(){$(this).remove();});break;case'slide':content.slideToggle(opts.speed,function(){$(this).remove();});break;default:content.toggle(opts.speed,function(){$(this).remove();});break;}};function closeTimer(content,opts){var timerId,start,remaining=opts.delay;this.pause=function(){window.clearTimeout(timerId);remaining-=new Date()-start;};this.resume=function(){start=new Date();timerId=window.setTimeout(function(){notify.close(content,opts);},remaining);};this.resume();}},});LC.initQueue.enqueue(function(){var $notifyElement=$('#lcNotify');if(!$notifyElement.length)throw'Notify error, container element "#lcNotify" not found!';var notifyElement=$notifyElement.notify(LC.config.notify);LC.notify=function(message,options){notifyElement.notify('show',$.extend({message:message},options));};});LC.initQueue.enqueue(function(){$.each(LC.global.languageSheet,function(index,value){if(index.startsWith('JsFormUtils_')){$.formUtils.LANG[index.replace("JsFormUtils_","")]=value;}});});LC.countdown=function(options){this.init=function(){if(typeof moment==='undefined'){throw"Moment JS library doesn't exist";}
this.endDate=moment(options.endDate).unix();this.callback=options.callback||function(){this.$container.remove();}.bind(this);this.$container=options.container||$('<span></span>');this.template=options.template||this.$container.html()||'{{hours}}:{{minutes}}:{{seconds}}';this.interval=setInterval(this.draw.bind(this),1000);this.draw();};this.draw=function(){var JSDate=moment().unix();var currentDate=this.endDate-JSDate;if(currentDate<0){this.destroy();this.callback();return;}
var stcTimeObj=this.formatTime(currentDate);this.$container.html(this.template.replace(/{{days}}/gi,stcTimeObj.days).replace(/{{hours}}/gi,stcTimeObj.hours).replace(/{{minutes}}/gi,stcTimeObj.minutes).replace(/{{seconds}}/gi,stcTimeObj.seconds));};this.formatTime=function(ms){var two=function(x){return(x>9?'':'0')+x;};var response={};response.days=parseInt(ms/60/60/24);response.hours=two(parseInt(ms/60/60)%24);response.minutes=two(parseInt(ms/60)%60);response.seconds=two(parseInt(ms)%60);return response;};this.destroy=function(){clearInterval(this.interval);};this.init();};LC.basketCountdown=function(element){element=$(element);var $elActive=element.find('.active'),options={container:$elActive,endDate:element.attr('data-lc-basket-expires'),callback:function(){element.removeClass('active').addClass('expired');},};if(!element.hasClass('expired')){element.addClass('active');}
return new LC.countdown(options);};LC.basketLockCountdown=function(element){element=$(element);var options={container:element,endDate:element.data('lock-countdown').expires,callback:function(){$(document.body).addClass('basket-check-availability');var dummy=$('<span/>');var button=$('<button></button>').html(languageSheet.lockedStockCheckAvailability).attr('data-lc-event','click').attr('data-lc-function','updateBasket').attr('data-data','{"action":"recalculate"}').appendTo(dummy);element.html(languageSheet.lockedStockCheckProductAvailability.replace(/{{name}}/gi,element.data('lock-countdown').productName).replace(/{{button}}/gi,dummy.html()));element.find('[data-lc-event]').dataEvent();},};return new LC.countdown(options);};LC.basketExpiration={expirationTimeout:0,expirationPopupTimeout:0,warningPopupTimeout:0,initialized:false,warningBox:null,init:function(){if(this.initialized)
return;if(!(LC.global.settings.basketStockLocking.active&&logicommerceGlobal.session.lockedStocksAggregateData.length))
return;this.initialized=true;const now=moment();const closestExpiresAt=logicommerceGlobal.session.lockedStocksAggregateData.filter(item=>item.expiresAt).map(item=>({...item,expiresAtDate:moment(item.expiresAt)})).reduce((closest,current)=>{return(!closest||(current.expiresAtDate.diff(now)>0&&current.expiresAtDate.diff(now)<closest.expiresAtDate.diff(now)))?current:closest;},null);if($('[data-lc-basket-expires]').length){this.checkNewExpirationDate();}else{this.setExpirationDate(closestExpiresAt.expiresAt);}},setExpirationDate:function(expDate){if(!this.initialized)return;var remainingSeconds=moment(expDate).diff(moment(),'seconds'),expired=false;clearTimeout(this.expirationTimeout);clearTimeout(this.expirationPopupTimeout);clearTimeout(this.warningPopupTimeout);this.expirationTimeout=setTimeout(this.expireBasket,remainingSeconds*1000);if(themeConfiguration?.commerce?.lockedStock.expiredPopup){if(remainingSeconds>0){this.expirationPopupTimeout=setTimeout(this.adviceExpireBasket,remainingSeconds*1000);expired=true;}else{this.adviceExpireBasket();expired=true;}}
if(themeConfiguration?.commerce?.lockedStock.warningPopup){const remainingWarningSeconds=remainingSeconds-themeConfiguration?.commerce?.lockedStock.warningPopupTimeThreshold*60;if(remainingWarningSeconds>0){this.warningPopupTimeout=setTimeout(this.warnExpireBasket,remainingWarningSeconds*1000);}else if(remainingWarningSeconds<=0&&!expired){this.warnExpireBasket();}}},checkNewExpirationDate:function(){const stockLockData=$('[data-lc-basket-expires]').data('lc-basket-expires');if(!stockLockData)return;LC.basketExpiration.setExpirationDate(stockLockData);},expireBasket:function(){$(document.body).addClass('basket-expired');$('[data-lc-basket-expired="remove"]').remove();},adviceExpireBasket:function(){if(!readCookie('closedPopupBasketExpired')){$('#popupWarningBasketExpires').modal('hide');$(document.body).box({uid:'popupBasketExpired',source:LC.global.routePaths.BASKET_INTERNAL_LOCKED_STOCK+'?type=expired',showFooter:false,type:'url',callback:'stockLockPopup',triggerOnClick:false});$('#popupBasketExpired').find('.btn-close').click(function(){writeCookie('closedPopupBasketExpired',true);});}},warnExpireBasket:function(){if(!readCookie('closedPopupWarningBasketExpires')){$('#popupBasketExpired').modal('hide');$(document.body).box({uid:'popupWarningBasketExpires',source:LC.global.routePaths.BASKET_INTERNAL_LOCKED_STOCK+'?type=warning',showFooter:false,type:'url',callback:'stockLockPopup',triggerOnClick:false});$('#popupWarningBasketExpires').find('.btn-close').click(function(){writeCookie('closedPopupWarningBasketExpires',true);});}},};LC.dataEvents.renewReserve=function(event){var data=$(event.target).data('lc-renewreserve');if(data.action=='renewReserve'){if(globalThis?.lcCommerceData&&lcCommerceData.navigation.type==='CHECKOUT'){var callback=function(){lcOneStepCheckout.moduleCalls('refreshModule');if(LC.hasOwnProperty('miniBasket'))LC.miniBasket.reload();$('#popupWarningBasketExpires').modal('hide');$('#popupWarningBasketExpires').remove();};}else{var callback=function(){location.reload();};}
$.post(LC.global.routePaths.BASKET_INTERNAL_LOCKED_STOCK_RENEW,{data:JSON.stringify(data)},callback,'json');}else if(themeConfiguration?.commerce?.useOneStepCheckout){window.location=LC.global.routePaths.CHECKOUT;}else{window.location=LC.global.routePaths.CHECKOUT_BASKET;}};LC.dataEvents.printContent=function(event){var data=$(event.currentTarget).data('lc-data');var toPrint=document.getElementById(data.contentId);var popupWin=window.open('',data.hrefType,data.windowAttributes);popupWin.document.open();popupWin.document.write('<html>');popupWin.document.write('<title>'+data.title+'</title>');popupWin.document.write('<body onload="window.print()">');popupWin.document.write(toPrint.innerHTML);popupWin.document.write('</html>');popupWin.document.close();};LC.dataEvents.editShoppingListRowNotes=function(event){const data=$.parseJSON($(event.currentTarget).attr('data-lc-data')),$popup=$($(event.currentTarget).data('bs-target')),$priority=$popup.find('input[name="priority"]');$popup.find('input[name="shoppingListId"]').val('');$popup.find('input[name="type"]').val('PUT');$popup.find('input[name="id"]').val(data.id);$popup.find('textarea[name="comment"]').val(data.comment);$popup.find('input[name="quantity"]').val(data.quantity);$popup.find('select[name="importance"]').val(data.importance);$popup.find('input[name="reference"]').val(data.reference);$priority.attr({'max':$(event.currentTarget).data('lc-total-items')});$priority.val(data.priority);}
LC.dataEvents.addShoppingListRowNotes=function(event){const data=$.parseJSON($(event.currentTarget).attr('data-lc-data')),$popup=$($(event.currentTarget).data('bs-target')),$priority=$popup.find('input[name="priority"]');$popup.find('input[name="shoppingListId"]').val(data.id);$popup.find('input[name="type"]').val('POST');$popup.find('input[name="id"]').val('');$popup.find('textarea[name="comment"]').val('');$popup.find('input[name="quantity"]').val(1);$popup.find('select[name="importance"]').val('MEDIUM');$popup.find('input[name="reference"]').val('');$popup.find('input[name="template"]').val($(event.currentTarget).data('lc-note-row-template'));let maxPriority=$(event.currentTarget).data('lc-total-items')+1;$priority.attr({'max':maxPriority});$priority.val(maxPriority);}
LC.dataEvents.setShoppingList=function(event){const data=$(event.currentTarget).data('lc-data'),$popup=$($(event.currentTarget).data('bs-target')),$priority=$popup.find('input[name="priority"]');$popup.find('input[name="name"]').val(data.name);$popup.find('input[name="description"]').val(data.description);$popup.find('input[name="keepPurchasedItems"]').val(data.keepPurchasedItems);$popup.find('input[name="keepPurchasedItemsCheckbox"]')[0].checked=data.keepPurchasedItems;$popup.find('input[name="keepPurchasedItemsCheckbox"]').click(function(e){$popup.find('input[name="keepPurchasedItems"]').val($(e.target)[0].checked);});if($(event.currentTarget).data('lc-total-items')<=1){$popup.find('input[name="defaultOne"]').val('true');$popup.find('input[name="defaultOneCheckbox"]').prop('disabled',true);$priority.val(1);$priority.attr({'max':1});}else{if(data.defaultOne){$popup.find('input[name="defaultOneCheckbox"]').prop('disabled',true);}
$popup.find('input[name="defaultOne"]').val(data.defaultOne);$popup.find('input[name="defaultOneCheckbox"]')[0].checked=data.defaultOne;$popup.find('input[name="defaultOneCheckbox"]').click(function(e){$popup.find('input[name="defaultOne"]').val($(e.target)[0].checked);});$priority.attr({'max':$(event.currentTarget).data('lc-total-items')});$priority.val(data.priority);}}
LC.dataEvents.deleteShoppingListRow=function(event){event.preventDefault();const data=$.parseJSON($(event.currentTarget).attr('data-lc-data'));$.post(LC.global.routePaths.USER_INTERNAL_DELETE_SHOPPING_LIST_ROWS,{data:JSON.stringify({shoppingListId:data.shoppingListId,rowIdList:data.rowId})},function(response){LC.notify(response.data.response.message,{type:response.data.response.success===1?'success':'danger'});if(response.data.response.success===1){$(`#${data.containerId}`).remove();}},'json');};LC.dataEvents.moveShoppingListRow=function(event){const data=$(event.currentTarget).data('lc-data');let list='';$.each(data.shoppingLists,(index,item)=>{list+=`<div class="form-check">
            <input class="form-check-input" type="radio" name="moveShoppingListRowId" id="moveShoppingListRowId${item.id}" data-lc-shopping-list-id="${item.id}">
            <label class="form-check-label" for="moveShoppingListRowId${item.id}">${item.name}</label>
        </div>`;});const $boxContent=$(`
        <div class="moveShoppingListRowContainer">${list}</div>
        <div class="moveShoppingListButtons">
            <button type="button" class="${BTN_SECONDARY_CLASS} moveShoppingListButton moveShoppingListButtonDismiss" data-dismiss="modal" data-bs-dismiss="modal">${LC.global.languageSheet.cancel}</button>
            <button type="button" class="${BTN_PRIMARY_CLASS} moveShoppingListButton moveShoppingListButtonConfirm">${LC.global.languageSheet.save}</button>
        </div>
    `);let $confirmButton=$($boxContent.find('.moveShoppingListButtonConfirm'));$confirmButton.on('click',function(event){$.post(LC.global.routePaths.USER_INTERNAL_SET_SHOPPING_LIST_ROW,{data:JSON.stringify({shoppingListId:$('[name="moveShoppingListRowId"]:checked').data('lc-shopping-list-id'),id:data.rowId,type:'PUT'})},function(response){LC.notify(response.data.response.message,{type:response.data.response.success===1?'success':'danger'});if(response.data.response.success===1){$(`#${data.containerId}`).remove();}},'json');$('#moveShoppingListRow'+data.rowId).modal('hide');});$(event.currentTarget).box({uid:'moveShoppingListRow'+data.rowId,modalClass:'moveShoppingListRow',showFooter:false,triggerOnClick:false,source:$boxContent,type:'html',showClose:true,size:'small',showHeader:true,headerTitle:LC.global.languageSheet.shoppingListRowMoveButton,});}
LC.dataEvents.setShoppingListRow=function(event){event.preventDefault();const data=$.parseJSON($(event.currentTarget).attr('data-lc-data'));$.post(LC.global.routePaths.USER_INTERNAL_SET_SHOPPING_LIST_ROW,{data:JSON.stringify({shoppingListId:data.shoppingListId,id:data.rowId,type:'PUT'})},function(response){LC.notify(response.data.response.message,{type:response.data.response.success===1?'success':'danger'});if(response.data.response.success===1){$(`#${data.containerId}`).remove();}},'json');};LC.dataEvents.deleteShoppingList=function(event){let $boxContent=$(`
        <div class="titleDeleteShoppingListConfirm">${LC.global.languageSheet.deleteShoppingListConfirmTitle}</div>
        <div class="textDeleteShoppingListConfirm">${LC.global.languageSheet.deleteShoppingListConfirmText}</div>
        <div class="deleteShoppingListButtons">
            <button type="button" class="${BTN_SECONDARY_CLASS} deleteShoppingListButton deleteShoppingListButtonDismiss" data-dismiss="modal" data-bs-dismiss="modal">${LC.global.languageSheet.cancel}</button>
            <button type="button" class="${BTN_DANGER_CLASS} deleteShoppingListButton deleteShoppingListButtonConfirm">${LC.global.languageSheet.delete}</button>
        </div>`);let $confirmButton=$($boxContent.find('.deleteShoppingListButtonConfirm'));var data=$(event.currentTarget).data('lc-data');$confirmButton.on('click',function(event){$.post(LC.global.routePaths.USER_INTERNAL_DELETE_SHOPPING_LIST,{data:JSON.stringify({id:data.id})},function(response){if(response.data.response.success===1){location.href=LC.global.routePaths.USER_SHOPPING_LISTS;}else{LC.notify(response.data.response.message,{type:'danger'});}},'json');$('#deleteShoppingListConfirm').modal('hide');});$(event.currentTarget).box({uid:'deleteShoppingListConfirm',showFooter:false,triggerOnClick:false,source:$boxContent,type:'html',showClose:true,size:'small'});};LC.dataEvents.deleteFormSaveForLaterRow=function(event){event.preventDefault();var id=$(event.currentTarget).data('lc-id');$.post(LC.global.routePaths.BASKET_INTERNAL_DELETE_SAVE_FOR_LATER_ROW,{data:JSON.stringify({id:id}),},function(data){if(data.data.response.success===1){$('[data-lc-saveForLaterRow-id="'+id+'"]').remove();}else{LC.notify(response.data.response.message,{type:'danger'});}},'json');};LC.dataEvents.transferToBasketSaveForLaterRow=function(event){event.preventDefault();var id=$(event.currentTarget).data('lc-id');$.post(LC.global.routePaths.BASKET_INTERNAL_TRANSFER_TO_BASKET_SAVE_FOR_LATER_ROW,{data:JSON.stringify({id:id}),},function(data){if(data.data.response.success===1){location.reload();}},'json');};LC.dataEvents.openAttachmentPath=function(event){event.preventDefault();var attachmentPath=$(event.currentTarget).data('lc-attachment-path');$.post(LC.global.routePaths.BASKET_INTERNAL_ATTACHMENT,{data:JSON.stringify({path:attachmentPath})},(response)=>{if(response.data.response&&response.data.response.success==1){let newWindow=window.open("");newWindow.document.write(`<html><head><title>${response.data.data.fileName}</title></head><body><iframe frameborder="0" title="${response.data.data.fileName}"  width="100%" height="100%" src="${encodeURI(response.data.data.value)}" sandbox></iframe></body></html>`);}else{LC.notify(response.data.response.message,{type:'danger'});}},'json');};LC.dataEvents.unsubscribeSubscription=function(event){const subscriptionType=$(event.currentTarget).data('lc-subscription-type');$.post(LC.global.routePaths.USER_INTERNAL_UNSUBSCRIBE_SUBSCRIPTION,{data:JSON.stringify({subscriptionType})},(response)=>{if(response?.data?.response?.success===1){LC.notify(response.data.response.message,{type:'success'});$(event.currentTarget).remove();}else{LC.notify(response.data.response.message,{type:'danger'});}},'json');};LC.dataEvents.reloadCustomize=function(){if(globalThis?.lcCommerceData){var params=new urlParameterEncoder();params.addParameter('type',globalThis.lcCommerceData.navigation.type);params.addParameter('id',globalThis.lcCommerceData.navigation.id);var url=LC.global.routePaths.RESOURCES_INTERNAL_CUSTOMIZE_JS+'/'+params.getParameters();$.get(url,{},'html');}};LC.dataEvents.changeQuantityEvent=function(items,newItems){if(newItems&&newItems.length){newItems=LC.dataEvents.parseRows(newItems);}
for(let i=0;i<items.length;i++){for(let j=0;j<newItems.length;j++){if(items[i].hash==newItems[j].hash){let data={hash:items[i].hash}
let difference=items[i].quantity-newItems[j].quantity;data.quantity=Math.abs(difference);if(difference<0){LC.resources.pluginListener('onAddProduct',{},data);}else if(difference>0){LC.resources.pluginListener('onRemoveProduct',{},data);}}}}};LC.dataEvents.parseRows=function(rows){let rowsArray=[];for(const[key,value]of Object.entries(rows)){let row={hash:key,quantity:value.quantity};rowsArray.push(row);}
return rowsArray;};LC.dataEvents.acceptRouteWarning=function(event=null){if(event){event.preventDefault();}
$.ajax({type:'POST',url:LC.global.routePaths.RESOURCES_INTERNAL_ACCEPT_ROUTE_WARNING,success:(data)=>{if(data.data.response.success===1){if(event&&$(event.target).data('lc-warning-url')){window.location=$(event.target).data('lc-warning-url');}
if(event){$('#routeWarning').modal('hide');}}},async:false,dataType:'json'});};LC.dataEvents.userVerifyResend=function(event=null){if(event){event.preventDefault();}
$.ajax({type:'POST',url:LC.global.routePaths.USER_INTERNAL_VERIFY_RESEND,data:{data:JSON.stringify({'username':$(event.currentTarget).attr('data-lc-username')})},success:(response)=>{if(response?.data?.response?.success===1){let modalId='modalVerifyUser',modalClass='verifyUser',boxMainDiv=$('<div/>',{class:'question '+modalId+' '+modalClass,html:'<div class="questionText '+modalClass+'Text">'+response.data.response.message+'</div>',});$('#userVerifyAccountFormContainer #verifyAccountForm').appendTo(boxMainDiv);boxMainDiv.box({uid:modalId,showFooter:false,type:'internal',size:'medium',triggerOnClick:false,});}else{LC.notify(response.data.response.message,{type:'danger'});}},async:false,dataType:'json'});}
LC.initializeForms=function(wrap){const container=wrap??document;const submitButtons=document.querySelectorAll('button[type=submit]:not(.initializeDisabled)');if(submitButtons){for(let i=0;i<submitButtons.length;i++){const el=submitButtons[i];el.disabled=false;el.removeAttribute("disabled");}}
const forms=container.querySelectorAll('form:not([data-lc-form-ignore])');if(!forms)return;for(let i=0;i<forms.length;i++){const form=forms[i];if(form.initialized)continue;const dataLCForm=form.dataset.lcForm;if(dataLCForm){if(dataLCForm==='oneStepCheckout'){lcOneStepCheckout=new LC.OneStepCheckout(form);continue;}
const dataLCFormClass=dataLCForm.charAt(0).toUpperCase()+dataLCForm.slice(1);if(LC[dataLCFormClass]){new LC[dataLCFormClass](form);continue;}}
const modal=form.closest('.modal');if(!modal||(modal&&!modal.dataset.lcModalCallback)){new LC.Form(form);}}};LC.initQueue.enqueue(function(){$.validate(LC.validateFormConf);LC.initializeCountdowns();LC.basketExpiration.init();LC.initializeForms();LC.initializeRangeSliders();$('[data-lc-quantity]').quantity();$('[data-lc-event]').dataEvent();LC.initializeModals();});
'use strict';LC.events={callbacks:{},scroll:{},resize:{},scroll_rates:[],resize_rates:[],addEvent:function(name,config){var self=this,event=config.event&&(config.event==='scroll'||config.event==='resize')?config.event:false,method=config.method||false,rate=config.rate||50,trailing=typeof config.trailing==='boolean'?config.trailing:false;if(!event||!method){throw'Bad formed event config in config.json events';}
self[event][name]=$[method].apply($[method],[rate,trailing,function(){$(window).trigger(name);},]);self.callbacks[name]=[];self[event+'_rates'].push({rate:rate,name:name});},addCallback:function(event,cb,args){if(!Array.isArray(LC.events.callbacks[event])){return;}
LC.events.callbacks[event].push([cb,args]);},removeCallback:function(event,cb){var self=this,arr=self.callbacks[event];if(Array.isArray(arr)){arr.forEach(function(e,i){if(e[0]===cb){arr.splice(i,1);}});}else{return false;}},getMinimumRate:function(event){var self=this;var rates=self[event+'_rates'].map(function(ev){return ev.rate;});var events=self[event+'_rates'].map(function(ev){return ev.name;});if(rates.length===0){return-1;}
var min=rates[0];var minIndex=0;for(var i=1;i<rates.length;i++){if(rates[i]<min){minIndex=i;min=rates[i];}}
self.addCallback(events[minIndex],self[event+'_cb'].bind(self));return true;},resize_cb:function(){this.windowWidth=document.documentElement.clientWidth;this.windowHeight=document.documentElement.clientHeight;},scroll_cb:function(){this.scrollTop=$(this.scrollContainer).scrollTop();},init:function(){if(typeof themeConfiguration.events!=='object'||typeof themeConfiguration.events.setup!=='object'){return;}
var self=this;self.scrollContainer=themeConfiguration.events.scrollContainer||window;Object.keys(themeConfiguration.events.setup).forEach(function(name){self.addEvent(name,themeConfiguration.events.setup[name]);});self.getMinimumRate('scroll');self.getMinimumRate('resize');self.resize_cb();self.scroll_cb();$(self.scrollContainer).on('scroll',function(){Object.keys(LC.events.scroll).forEach(function(key){LC.events.scroll[key]();});});$(window).on('resize',function(){Object.keys(LC.events.resize).forEach(function(key){LC.events.resize[key]();});});Object.keys(LC.events.callbacks).forEach(function(key){$(window).on(key,function(){LC.events.callbacks[key].forEach(function(cb){if(typeof cb[0]!=='undefined'&&typeof cb[0]=='function'){cb[0].apply(cb[0],cb[1]);}});});});},};LC.initQueue.enqueue(function(){LC.events.init();});
(function($){'use strict';LC.fn('lcScroll',{options:{baseUrl:'',autoTrigger:true,launchBase:true,dataType:'html',loadingHtml:'<div>Loading...</div>',loadingClass:'lc-scroll-isLoading',wrapper:'div',callback:false,padding:100,debug:false,},Constructor:function(element,options){var self=this;var $window,$document,loading,request,loadingHtml;self.init=function(){debug('info',options);$window=$(window);$document=$(document);loadingHtml='<div class="lc-scroll-loading">'+options.loadingHtml+'</div>';if(options.autoTrigger)self.initScroll();};self.initScroll=function(){setNextUrl();setLoading(false);if(options.launchBase)scroll(true);$window.scroll(scroll.bind(self,false));};function scroll(ignorePosition){if(!canLoad(ignorePosition))return;setLoading(true);var $wrapper=prepareWrapper();request=getData(getNextUrl());request.done(function(data,status,jqXHR){debug('info','request.done',arguments);onLoad($wrapper,data,status,jqXHR);});request.fail(function(){debug('error','request.fail',arguments);$wrapper.remove();});}
function getData(url){return $.ajax({url:url,dataType:options.dataType,method:'GET',});}
function canLoad(ignorePosition){if(isLoading()||!getNextUrl())return false;if(ignorePosition)return true;return $window.scrollTop()>=$document.height()-$window.height()-options.padding;}
function isLoading(){return loading;}
function setLoading(status){loading=status;if(status)element.addClass(options.loadingClass);else element.removeClass(options.loadingClass);}
function onLoad($wrapper,data,status,jqXHR){setLoading(false);if(status=='success'){var nextUrl=$(data).data('lcScrollNextpage');if(!nextUrl)nextUrl=jqXHR.getResponseHeader('lc-nextPage');setNextUrl(nextUrl);$wrapper.html(data);}else $wrapper.remove();if(options.callback&&typeof options.callback==='function')
options.callback(element,$wrapper,data,status,jqXHR);}
function setNextUrl(nextUrl){if(!nextUrl&&!self.hasOwnProperty('nextUrl'))nextUrl=options.baseUrl||element.data('lcScroll');else if(typeof nextUrl==='object')nextUrl=nextUrl.data('nexturl');self.nextUrl=nextUrl;}
this.setNextUrl=setNextUrl;function getNextUrl(){return self.nextUrl?self.nextUrl:'';}
function prepareWrapper(){var wrapperTag='<'+(options.wrapper||div)+'/>';var $wrapper=$(wrapperTag,{html:loadingHtml}).appendTo(element);return $wrapper;}
function debug(dbg){if(options.debug&&typeof console==='object'&&(typeof dbg==='object'||typeof console[dbg]==='function')){if(typeof dbg==='object'){var args=[];for(var prop in dbg){if(typeof console[prop]==='function'){args=dbg[prop].length?dbg[prop]:[dbg[prop]];console[prop].apply(console,args);}else{console.log.apply(console,args);}}}else{console[dbg].apply(console,Array.prototype.slice.call(arguments,1));}}}},});LC.initQueue.enqueue(function(){$('[data-lc-scroll]').each(function(index,el){var $el=$(el);var baseUrl=$el.data('lcScroll');if(!baseUrl)return;$el.lcScroll({baseUrl:baseUrl,launchBase:$el.data('lcScrollLaunchbase')||true,autoTrigger:$el.data('lcScrollAutotrigger')||true,padding:$el.data('lcScrollPadding'),debug:$el.data('lcScrollDebug'),dataType:$el.data('lcScrollDatatype'),loadingHtml:$el.data('lcScrollLoadinghtml'),loadingClass:$el.data('lcScrollLoadingclass'),wrapper:$el.data('lcScrollWrapper'),callback:LC.carryMethod($el.data('lcScrollCallback')),});});});})(jQuery);
LC.OneStepCheckout=LC.Form.extend({name:'oneStepCheckout',options:{},tracking:[],submitButton:[],dataModules:{basket:{autoRefresh:true,initializeMethod:'initializeBasket',modulesToRefresh:['basket','buttons','discounts','gifts','linkeds','lockedStocks','payments','rewardPoints','shippings','discountPrediction','saveForLater','selectableGifts',],},buttons:{autoRefresh:true,initializeMethod:'initializeButtons',},comments:{},userForm:{initializeMethod:'initializeUserForm',createAccount:true,modulesToRefresh:['basket','buttons','discounts','gifts','linkeds','lockedStocks','payments','rewardPoints','shippings','discountPrediction','saveForLater','selectableGifts'],},discounts:{autoRefresh:true,initializeMethod:'initializeDiscounts',},linkeds:{modulesToRefresh:['basket','buttons','discounts','gifts','linkeds','lockedStocks','payments','rewardPoints','shippings','saveForLater','selectableGifts'],},lockedStocks:{modulesToRefresh:['basket','buttons','discounts','gifts','linkeds','lockedStocks','payments','rewardPoints','shippings','saveForLater','selectableGifts'],},gifts:{autoRefresh:true,modulesToRefresh:['basket','buttons','discounts','gifts','linkeds','lockedStocks','payments','rewardPoints','shippings','saveForLater','selectableGifts'],},payments:{autoRefresh:true,initializeMethod:'initializePayments',modulesToRefresh:['basket','buttons','discounts','gifts','linkeds','lockedStocks','payments','rewardPoints','shippings','saveForLater','selectableGifts'],},shippings:{autoRefresh:true,initializeMethod:'initializeShippings',modulesToRefresh:['basket','buttons','discounts','gifts','linkeds','lockedStocks','payments','rewardPoints','shippings','saveForLater','selectableGifts'],},saveForLater:{modulesToRefresh:['basket','buttons','discounts','gifts','linkeds','lockedStocks','payments','rewardPoints','shippings','saveForLater','selectableGifts'],},rewardPoints:{autoRefresh:true,initializeMethod:'initializeRewardPoints'},legalCheck:{initializeMethod:'initializeLegalCheck',},discountPrediction:{autoRefresh:true,initializeMethod:'initializeDiscountPrediction',},miniBasket:{autoRefresh:true,initializeMethod:'initializeMiniBasket',},selectableGifts:{modulesToRefresh:['basket','buttons','discounts','gifts','linkeds','lockedStocks','payments','rewardPoints','shippings','saveForLater'],},},additionalContent:{specialProducts:{autoRefresh:true,initializeMethod:'initializeSpecialProducts',},discountPrediction:{autoRefresh:true,initializeMethod:'initializeDiscountPrediction',},linkeds:{autoRefresh:true,initializeMethod:'initializeLinkeds',},lockedStocks:{autoRefresh:true,initializeMethod:'initializeLockedStocks',},saveForLater:{autoRefresh:LC.global.session.login||globalThis?.lcCommerceSession?.userId?true:false,initializeMethod:'initializeSaveForLater',},selectableGifts:{autoRefresh:true,initializeMethod:'initializeSelectableGifts',},},userVerified:false,endOrder:undefined,emailInputDelay:500,emailInputValue:'',notifyMode:LC.notifyMode,userEmailExistsError:`${LC.global.languageSheet.userEmailExistsOsc} <a class="emailErrorLoginCall" data-bs-toggle="modal" data-bs-target="#userLogin" role="button">${LC.global.languageSheet.oneStepCheckoutLogin}</a>`,moduleCallsStatus:{},initialize:function(){if(LC.oneStepCheckoutConfig?.emailInputDelay&&typeof LC.oneStepCheckoutConfig.emailInputDelay==='number'){this.emailInputDelay=LC.oneStepCheckoutConfig.emailInputDelay;}
if(LC.oneStepCheckoutConfig?.notifyMode&&typeof LC.oneStepCheckoutConfig.notifyMode==='boolean'){this.notifyMode=LC.oneStepCheckoutConfig.notifyMode;}
this.trigger('initializeBefore');this.initializeMiniBasket();this.el.$form.find('[data-lc-checkout]').each(function(index,el){var $el=$(el);var key=$el.data('lcCheckout');var module=this.dataModules[key];if(!module){var moduleProperties=$el.data('lcCheckoutProperties');if($.isPlainObject(moduleProperties)){module=moduleProperties;this.dataModules[key]=module;}}
if(module){module.active=true;module.el=$el;module.params=$el.data('lcCheckoutParams');if(module.initializeMethod&&$.isFunction(this[module.initializeMethod]))
this[module.initializeMethod](module);}}.bind(this));$('div[data-lc-oscac]').each(function(index,el){var $el=$(el);var key=$el.data('lcOscac');var content=this.additionalContent[key];if(content){content.active=true;content.el=$el;if(content.initializeMethod&&$.isFunction(this[content.initializeMethod]))
this[content.initializeMethod](content);}}.bind(this));const userLoginModal=document.getElementById('userLogin');if(userLoginModal){userLoginModal.addEventListener('shown.bs.modal',(event)=>{const inputEmail=$(userLoginModal.querySelector('#username')),inputPassword=$(userLoginModal.querySelector('#password')),delaySetFocus=400;if(this.loginEmailValue){inputEmail.val(this.loginEmailValue);this.loginEmailValue='';setTimeout(function(){inputPassword.focus();},delaySetFocus);}else{setTimeout(function(){inputEmail.focus();},delaySetFocus);}});}
LC.BuyProductForm.prototype.callback=LC.BuyForm.prototype.callback=function(data){if(data.status.code!=200){this.notify(LC.global.languageSheet.oneStepCheckoutProductAddedError,'danger');return false;}else if(data.data.response.success){this.notify(LC.global.languageSheet.oneStepCheckoutProductAdded,'success');this.moduleCalls('refreshModule');}else{this.moduleCalls('loadingIndicator',false);this.notify(LC.global.languageSheet.oneStepCheckoutProductAddedError,'danger');return false;}}.bind(this);if(logicommerceGlobal.settings.useOSCAsync){this.moduleCalls('refreshModule');}
this.el.$customTagAttachment=this.el.$form.find('.lcCustomTagAttachment');if(this.el.$customTagAttachment.length){LC.CheckoutForm.prototype.attachmentFields(this.el.$customTagAttachment);}
LC.CheckoutForm.prototype.initCalendar.call(this);this.trigger('initializeCallback');this.trigger('onLoad');this.el.$form.removeClass('unload');$.formUtils.addValidator({name:'userEmailExists',validatorFunction:function(value,$elem,conf,language,$form){const data=$elem.data('userEmailExistsOsc');if(typeof data==='undefined'){return true;}else if(data===true){return false}
return true;},errorMessage:this.userEmailExistsError,errorMessageKey:'userEmailExists'});},initializeButtons:function(module){this.trigger('initializeButtonsBefore');this.submitButton=module.el.find('#basketEndOrder');if(this.submitButton.length)this.submitButton.each((index,$el)=>{$el.disabled=true;});this.trigger('initializeButtonsCallback');return;},initializeBasket:function(module){this.trigger('initializeBasketBefore');module.el.find('[data-lc-basketdeleterow],[data-lc-basketdeleterows]').click(this.deleteRow.bind(this));module.el.find('[data-lc-basketdeletediscount]').click(this.deleteDiscount.bind(this));module.el.find('[data-lc-basketsaveforlaterrow]').click(this.saveForLater.bind(this));var quantityElements=module.el.find('input.basketQuantity:text,select.basketQuantity');quantityElements.change(this.onChangeOption.bind(this)).keypress(function(event){if(event.keyCode==13){event.preventDefault();this.onChangeOption(event);}}.bind(this));module.el.find('input[data-lc-quantity]').quantity();module.el.find('select[data-lc-quantity]').quantity();var optionsElements=module.el.find('select.productOptionSelectValue, input.productOptionCheckboxValue, input.productOptionBooleanValue, input.productOptionTextValue');optionsElements.change(this.onChangeOption.bind(this));module.el.find('input[type="text"]').keypress(function(event){if(event.keyCode==13)return false;});LC.initializeCountdowns();LC.basketExpiration.checkNewExpirationDate();this.el.$customTagAttachment=this.el.$form.find('.lcCustomTagAttachment');if(this.el.$customTagAttachment.length){LC.CheckoutForm.prototype.attachmentFields(this.el.$customTagAttachment);}
LC.CheckoutForm.prototype.initCalendar.call(this);this.trigger('initializeBasketCallback');},initializeMiniBasket:function(module){var key='miniBasket';module=module||this.dataModules[key];if(!module.active){LC.miniBasket.oneStepCheckoutCallback=function(){this.moduleCalls('refreshModule');}.bind(this);module.active=true;return;}
if(LC.hasOwnProperty(key)){if(LC.miniBasket.exists()){LC.miniBasket.reload(function(){this.moduleCallDone('refreshModule',key,function(){this.trigger('onLoad');}.bind(this));}.bind(this));}else{this.moduleCallDone('refreshModule',key,function(){this.trigger('onLoad');}.bind(this));}}},initializeUserForm:function(module){module.el.find('[data-lc-event]').dataEvent();this.trigger('initializeUserFormBefore');var userFormElement=module.el.find('.userForm ')[0];this.userForm=new LC.UserForm(userFormElement);var $signInCheckbox=module.el.find('#createAccountCheck');this.inputEmail=this.getInputEmail();this.restoreUserFormValidation();this.userForm.el.$form.find('.userFieldGroupEmail input[type="email"]').on('input',(event)=>{var inputEmail=event.target;$(inputEmail).data('userEmailExistsOsc',false);if(this.emailInputValue===inputEmail.value)return;if(this.emailInputTimeout)clearTimeout(this.emailInputTimeout);this.emailInputValue=inputEmail.value;if(!this.isValid('email',inputEmail.value)){$(inputEmail.parentNode).removeClass('has-success').addClass('has-error').find('.form-error').remove().end().append('<span class="help-block form-error">'+LC.global.languageSheet.JsFormUtils_badEmail+'</span>');return;}
$(inputEmail.parentNode).removeClass('has-error').addClass('has-success').find('.form-error').remove();this.fillDataForm(this.dataModules.userForm);this.emailInputTimeout=setTimeout(function(){this.recalculateBasket(this.dataModules.userForm,true,function(response){$(inputEmail.parentNode).removeClass('lcLoading');}.bind(this));}.bind(this),this.emailInputDelay);});this.userForm.selectPostalCodeCallback('userInfo',function(){this.recalculateBasket(module,true,this.restoreUserFormValidation.bind(this));}.bind(this));this.userForm.selectPostalCodeCallback('shippingAddress',function(){this.recalculateBasket(module,true,this.restoreUserFormValidation.bind(this));}.bind(this));this.userForm.el.$useShippingAddress.on('change',function(){this.recalculateBasket(module,true,this.restoreUserFormValidation.bind(this));}.bind(this));this.userForm.el.$form.find('.userFieldGroupBirthday .date').on('dp.change',function(event){if(event.target.outerHTML.indexOf('required')>=0){event.target.name='birthDay';if(this.validateFilledUserForm(function(){},event)===true){this.recalculateBasket(module,true,this.restoreUserFormValidation.bind(this));}}}.bind(this));if(!module.createAccount&&$signInCheckbox[0].checked)$signInCheckbox.click();$signInCheckbox.on('click',function(event){module.createAccount=event.target.checked;if(this.inputEmail.value.length&&this.isValid('email',this.inputEmail.value))
this.recalculateBasket(module,true);}.bind(this));this.el.$form.on('change',this.validateFilledUserForm.bind(this,function(){this.recalculateBasket(module,true);}.bind(this)));if(this.userForm.el.useShippingAddressBook){this.userForm.el.useShippingAddressBook.addEventListener('change',function(){this.recalculateBasket(module,true,this.restoreUserFormValidation.bind(this));}.bind(this));}
module.el.find('input:radio[name="shippingAddress"], input:radio[name="billingAddress"]').on('change',function(){this.recalculateBasket(module,true,this.restoreUserFormValidation.bind(this));}.bind(this));var addressFormCallbackBefore=function(result){this.userForm.el.$form.find('.blockAddressBook:not([class*="SectionSeparator"])').addClass('loading');if(result.data.response&&result.data.response.success){this.userForm.el.$form.find('input:radio[name="shippingAddress"]').off('change');}};LC.BillingAddressBookForm.addEvent('oscCallbackBefore',addressFormCallbackBefore.bind(this));LC.ShippingAddressBookForm.addEvent('oscCallbackBefore',addressFormCallbackBefore.bind(this));var addressCallback=function(result){if(result.data.response&&result.data.response.success){this.userForm.el.$form.find('div.addressBook input#billingAddress_'+result.data.data.data.id+', div.addressBook input#shippingAddress_'+result.data.data.data.id).on('change',function(){this.recalculateBasket(module,true,this.restoreUserFormValidation.bind(this));}.bind(this));this.recalculateBasket(module,true,this.restoreUserFormValidation.bind(this));}else{this.userForm.el.$form.find('.blockAddressBook').removeClass('loading');}};LC.BillingAddressBookForm.addEvent('oscCallback',addressCallback.bind(this));LC.ShippingAddressBookForm.addEvent('oscCallback',addressCallback.bind(this));this.trigger('initializeUserFormCallback');},getInputEmail:function(){const inputEmail=this.userForm.el.$form.find('.userFieldGroupEmail input[type="email"]:visible')[0];$(inputEmail).attr('data-validation',function(){const thisAttr=$(this).attr('data-validation');if(thisAttr.includes('userEmailExists')){return thisAttr;}else{return(thisAttr?thisAttr+',':'')+'userEmailExists';}});return inputEmail;},initializeShippings:function(module){this.trigger('initializeShippingsBefore');$lcModalContainerPhysicalLocationsPoints=module.el.find('.physicalLocations.physicalLocationsPoints').parent();$physicalLocationsLcModalBody=$('#physicalLocations').find('.lcModalContainer');if($lcModalContainerPhysicalLocationsPoints.length&&$physicalLocationsLcModalBody.length){$physicalLocationsLcModalBody.html($lcModalContainerPhysicalLocationsPoints);}
$lcModalContainerPickupPointProviders=module.el.find('.physicalLocations.pickupPointProviders').parent();$pickupPointProvidersLcModalBody=$('#pickupPointProviders').find('.lcModalContainer');if($lcModalContainerPickupPointProviders.length&&$pickupPointProvidersLcModalBody.length){$pickupPointProvidersLcModalBody.html($lcModalContainerPickupPointProviders);}
this.shippingData={};this.el.shippingSection=module.el.find('input.shippingTypeSelector:radio');this.el.shippingSection=$.merge($('#physicalLocations button.savePickingSelectionButton'),this.el.shippingSection);this.el.shippingSection.each(function(index,el){let $el=$(el);if(!$el.prop('init')){$el.prop('init',true);el.addEventListener('click',this.setShippingSection.bind(this,el));el.disabled=false;}}.bind(this));this.el.shippingSection=module.el.find('#pickupPointProviders').find('input.shippingTypeSelector:radio');this.el.shippingSection=$.merge($('#pickupPointProviders button.savePickingSelectionButton'),this.el.shippingSection);this.el.shippingSection.each(function(index,el){let $el=$(el);if(!$el.prop('init')){$el.prop('init',true);el.addEventListener('click',this.setShippingSection.bind(this,el));el.disabled=false;}}.bind(this));$('[data-lc-event]').dataEvent();this.trigger('initializeShippingsCallback');},initializePayments:function(module){this.trigger('initializePaymentsBefore');LC.resources.pluginListener('initializePaymentsBefore',this.el.$form,true);module.el.find('[data-lc-event]').dataEvent();this.el.paymentSystemSelectors=module.el.find('input.basketSelectorPaymentInput:radio');this.el.paymentSystemSelectors.each(function(index,el){if(!$(el).data('lc-express-checkout')){el.addEventListener('click',this.setPaymentSystem.bind(this));el.disabled=false;}}.bind(this));this.trigger('initializePaymentsCallback');LC.resources.pluginListener('initializePaymentsCallback',this.el.$form,true);},initializeDiscounts:function(module){this.trigger('initializeDiscountsBefore');this.el.$discountCode=module.el.find('#voucherField');this.el.$discountCode.keypress(function(event){if(event.keyCode===13){event.preventDefault();this.addDiscount();}}.bind(this));var deleteVoucherCode=module.el.find('span.deleteVoucherCode');deleteVoucherCode.each(function(index,el){$(el).on('click',this.deleteVoucherCode.bind(this,el));}.bind(this));module.el.find('#voucherButton').click(this.addDiscount.bind(this));if($('.ticketCodesGroup .outputDiscountName').length==0){$('.ticketCodesTitle').remove();}
this.loadingIndicator('loadingIndicator',module,false);this.trigger('initializeDiscountsCallback');},initializeDiscountPrediction:function(module){module.el.find('[data-lc-event]').dataEvent();module.el.find('[data-lc-form="buyForm"]').each(function(index,form){if(!form.initialized)new LC.BuyForm(form);});module.el.find('[data-lc-form="buyProductForm"]').each(function(index,form){if(!form.initialized)new LC.BuyProductForm(form);});},initializeLegalCheck:function(module){if(!module)module=this.dataModules.legalCheck;if(!module.active)return;this.trigger('initializeLegalCheckBefore');if(!module.elCheckbox)module.elCheckbox=module.el.find('input[name="agreement"]');module.elCheckbox[0].setAttribute('data-validation','required');module.elCheckbox.on('click',function(event){if(!this.submitButton)this.submitButton=this.dataModules.buttons.el.find('#basketEndOrder');const endOrder=event.target.checked&&(this.endOrder||this.submitButton.data('endOrder'));if(this.submitButton.length)this.submitButton.each((index,$el)=>{$el.disabled=!endOrder;});}.bind(this));this.trigger('initializeLegalCheckCallback');},initializeSpecialProducts:function(module){this.trigger('initializeSpecialBefore');module.el.find('[data-lc-event]').dataEvent();module.el.find('[data-lc-form="buyForm"]').each(function(index,form){if(!form.initialized)new LC.BuyForm(form);});module.el.find('[data-lc-form="buyProductForm"]').each(function(index,form){if(!form.initialized)new LC.BuyProductForm(form);});module.needToRefresh=true;this.trigger('initializeSpecialCallback');},initializeLinkeds:function(module){this.trigger('initializeLinkedsBefore');module.el.find('[data-lc-event]').dataEvent();module.el.find('[data-lc-form="buyForm"]').each(function(index,form){if(!form.initialized)new LC.BuyForm(form);});module.el.find('[data-lc-form="buyProductForm"]').each(function(index,form){if(!form.initialized)new LC.BuyProductForm(form);});module.needToRefresh=true;this.trigger('initializeLinkedCallback');},initializeLockedStocks:function(module){this.trigger('initializeLockedStocksBefore');module.el.find('[data-lc-event]').dataEvent();LC.initializeCountdowns();LC.basketExpiration.checkNewExpirationDate();module.needToRefresh=true;this.trigger('initializeLockedStocksLinkedCallback');},initializeSaveForLater:function(module){this.trigger('initializeSaveForLaterBefore');LC.dataEvents.transferToBasketSaveForLaterRow=(event)=>{event.preventDefault();var id=$(event.currentTarget).data('lc-id');this.request(LC.global.routePaths.BASKET_INTERNAL_TRANSFER_TO_BASKET_SAVE_FOR_LATER_ROW,'POST',{id:id},function(result){this.moduleCalls('loadingIndicator',false);if(result.status.code==200&&result.data.response.success===1){this.moduleCalls('refreshModule');}else{this.notify(result.data.response.message,'danger');}}.bind(this));};module.el.find('[data-lc-event]').dataEvent();module.needToRefresh=true;this.trigger('initializeSaveForLaterCallback');},initializeSelectableGifts:function(module){this.trigger('initializeSelectableGiftsBefore');module.el.find('[data-lc-event]').dataEvent();module.el.find('[data-lc-form="buyForm"]').each(function(index,form){if(!form.initialized)new LC.BuyForm(form);});module.el.find('[data-lc-form="buyProductForm"]').each(function(index,form){if(!form.initialized)new LC.BuyProductForm(form);});module.needToRefresh=true;this.trigger('initializeSelectableGiftsCallback');},initializeRewardPoints:function(module){this.trigger('initializeRewardPointsBefore');module.el.find('.rewardPointButton').each(function(index,el){el.addEventListener('click',this.applyRewardPoints.bind(this,$(el).data('lc-id')));el.disabled=false;}.bind(this));const quantityElements=module.el.find('input.rewardPointQuantity, select.rewardPointQuantity');quantityElements.keypress(function(event){if(event.keyCode===13){event.preventDefault();this.applyRewardPoints($(event.target).data('lc-id'))}}.bind(this));module.el.find('input[data-lc-quantity]').quantity();module.el.find('select[data-lc-quantity]').quantity();module.needToRefresh=true;this.trigger('initializeRewardPointsCallback');},moduleCalls:function(callback){var functionCallback=this[callback];if(!$.isFunction(functionCallback))return;var args=Array.prototype.slice.call(arguments,1);for(var key in this.dataModules){var module=this.dataModules[key];if(module.active&&((callback=='loadingIndicator'&&module.autoRefresh)||(callback=='refreshModule'&&module.autoRefresh)||callback=='lockModule')){var moduleArr=[key,module];this.moduleCallStart(callback,key);functionCallback.apply(this,moduleArr.concat(args));}}
for(var key in this.additionalContent){var content=this.additionalContent[key];if(content.active&&((callback=='loadingIndicator'&&content.autoRefresh)||(callback=='refreshModule'&&content.autoRefresh)||callback=='lockModule')){this.moduleCallStart(callback,key);functionCallback.apply(this,[key,content].concat(args));}}},moduleCallStart:function(type,name){if(!this.moduleCallsStatus[type])this.moduleCallsStatus[type]={};this.moduleCallsStatus[type][name]=true;return true;},moduleCallDone:function(type,name,lastCallback){if(!this.moduleCallsStatus[type])return false;if(this.moduleCallsStatus[type].hasOwnProperty(name)&&this.moduleCallsStatus[type][name]){delete this.moduleCallsStatus[type][name];}
if(lastCallback&&typeof lastCallback==='function'){var objLen=Object.keys(this.moduleCallsStatus[type]).length;if(objLen===1){lastCallback();if(this.submitButton.length)this.submitButton.each((index,$el)=>{$el.disabled=!this.submitButton.data('endOrder');});}else{return false;}}
return true;},loadingIndicator:function(key,module,show){if(!module||typeof module!=='object')module=this.dataModules[key];if(!module.active||!module.hasOwnProperty('el'))return;if(show)module.el.addClass('loading');else module.el.removeClass('loading');},lockModule:function(key,module,blocked,forceChange){if(!module||typeof module!=='object')module=this.dataModules[key];if(!module.active)return;if(blocked)module.el.addClass('blocked');else module.el.removeClass('blocked');},setTracking:function(moduleName){this.tracking.push(moduleName);this.trigger('tracking',moduleName,this.tracking);},onChangeOption:function(event){this.setTracking('changeOption');if(!this.trigger('onChangeOption')){this.trigger('onChangeOptionBefore');this.recalculateBasket(this.dataModules.basket);this.trigger('onChangeOptionCallback',event.target);}},deleteRow:function(event){event.preventDefault();let position=$(event.currentTarget).data('lcBasketdeleterow'),positions=$(event.currentTarget).data('lcBasketdeleterows');this.moduleCalls('loadingIndicator',true);this.setTracking('deleteRow');this.fillDataForm('basket');let data={};data.id=$(event.currentTarget).parent().attr('id');data.hash=position;LC.resources.pluginListener('onRemoveProduct',event,data);this.request(LC.global.routePaths.CHECKOUT_INTERNAL_OSC_RECALCULATE,'POST',{deleteRow:position,deleteRows:positions,dataForm:this.dataForm},function(result){if(result.status.code!=200){this.moduleCalls('loadingIndicator',false);this.notify(LC.global.languageSheet.oneStepCheckoutProductDeletedError,'danger');return false;}
if(result.data?.response?.success){if(result.data?.data?.totalItems===0){window.location=LC.global.routePaths.CHECKOUT;return;}
this.notify(LC.global.languageSheet.oneStepCheckoutProductDeleted,'success');this.moduleCalls('refreshModule');LC.dataEvents.reloadCustomize();}else{this.moduleCalls('loadingIndicator',false);this.notify(LC.global.languageSheet.oneStepCheckoutProductDeletedError,'danger');}
this.trigger('onDeleteRowCallback',result);}.bind(this));},deleteDiscount:function(event){event.preventDefault();this.setTracking('deleteDiscount');var discountData=$(event.currentTarget).data('lcBasketdeletediscount');if(discountData.hasOwnProperty('giftId')){discountData.deleteGift=1;}
this.moduleCalls('loadingIndicator',true);this.request(LC.global.routePaths.CHECKOUT_INTERNAL_OSC_RECALCULATE,'POST',discountData,function(data){if(data.statusCode!=200){this.moduleCalls('loadingIndicator',false);this.notify(LC.global.languageSheet.oneStepCheckoutProductDeletedError,'danger');return false;}
if(data.response&&data.response.DELETED){this.notify(LC.global.languageSheet.oneStepCheckoutProductDeleted,'success');this.moduleCalls('refreshModule');}else{this.moduleCalls('loadingIndicator',false);this.notify(LC.global.languageSheet.oneStepCheckoutProductDeletedError,'danger');}}.bind(this));},saveForLater:function(event){event.preventDefault();const hash=$(event.currentTarget).attr('data-lc-basketSaveForLaterRow');this.moduleCalls('loadingIndicator',true);this.setTracking('saveForLater');this.fillDataForm('basket');this.request(LC.global.routePaths.CHECKOUT_INTERNAL_OSC_RECALCULATE,'POST',{saveForLater:hash},function(result){if(result.status.code!=200){this.moduleCalls('loadingIndicator',false);this.notify(LC.global.languageSheet.savedForLaterError,'danger');return false;}
if($.isEmptyObject(result.data?.data?.saveForLater?.incidences)&&$.isEmptyObject(result.data?.data?.saveForLater?.error)){if(result.data?.data?.totalItems===0){window.location=LC.global.routePaths.CHECKOUT;return;}
this.notify(LC.global.languageSheet.savedForLater,'success');this.moduleCalls('refreshModule');}else{this.moduleCalls('loadingIndicator',false);this.notify(LC.global.languageSheet.savedForLaterError,'danger');}}.bind(this));},setPaymentSystem:function(ev){this.setTracking('setPaymentSystem');LC.resources.pluginListener('setPaymentSystem',ev,ev.target.value,true);this.dataModules.payments.data=JSON.parse(ev.target.value);var inputsForAdditionalData={};$('.basketSelectorPaymentAdditionalData_'+this.dataModules.payments.data.id).each((index,el)=>{inputsForAdditionalData[el.name]=el.value;el.remove();})
this.dataModules.payments.data['additionalData']=JSON.stringify(inputsForAdditionalData);this.recalculateBasket(this.dataModules.payments);},setShippingSection:function(el){const $el=$(el);if($el.closest('.shippingSelectorSelected').length){return;}
if($el.hasClass('savePickingSelectionButton')){const lcData=$el.closest('.modal-content').find('input[name="physicalLocation"]:checked').data('lc');if(lcData?.hash){this.shippingData.deliveryHash=lcData.hash;this.shippingData.providerPickupPointHash=lcData.mode=='PROVIDER_PICKUP_POINT'?lcData.delivery.mode.providerPickupPoint.hash:'no'
this.shippingData.type='PICKING';bootstrap.Modal.getOrCreateInstance($el.closest('.modal-dialog').parent()).hide();}else{LC.notify(LC.global.languageSheet.deliveryPickingNoSelectedError,{type:'danger'});}}else{this.shippingData.type=$el.data('lc-delivery-type');this.shippingData.deliveryHash=$el.data('lc-delivery-hash');this.shippingData.shipments=[];$el.closest('.delivery').find('input.shippingTypeSelector:checked').each((index,shipping)=>{this.shippingData.shipments.push({shippingHash:$(shipping).data('lc-shipping-hash'),shipmentHash:$(shipping).data('lc-shipment-hash'),});});}
this.setTracking('setShippingSection');LC.resources.pluginListener('setShippingSection',el,{id:el.value},true);this.recalculateBasket(this.dataModules.shippings);},setWarehouse:function(event){this.setTracking('setWarehouse');this.recalculateBasket(this.dataModules.shippings);},addDiscount:function(){if(!this.el.$discountCode)return;var code=this.el.$discountCode.val();if(code.length>0){this.moduleCalls('loadingIndicator',true);this.setTracking('addDiscount');var jsonToSend={code:escape(code),mode:'ADD'};this.request(LC.global.routePaths.CHECKOUT_INTERNAL_OSC_RECALCULATE,'POST',{voucher:jsonToSend},function(result){this.moduleCalls('loadingIndicator',false);if(result.status.code!=200){return false;}
if(result.data.data.voucher.error){if(result.data.data.voucher.error.indexOf('VOUCHER_CODE_EXISTS')!==-1){this.notify(LC.global.languageSheet.errorCodeVoucherCodeExists,'danger');}else if(result.data.data.voucher.error.indexOf('DISCOUNT_CODE_EXISTS')!==-1){this.notify(LC.global.languageSheet.errorCodeDiscountCodeExists,'danger');}else{this.notify(LC.global.languageSheet.errorCodeVoucherCodeNotFound,'danger');}}else{this.el.$discountCode.val('');this.moduleCalls('refreshModule');this.showMessage(LC.global.languageSheet.voucherAdded,'success');}}.bind(this));}},deleteVoucherCode:function(el){var data=$(el).data('lcData');var callbackDeleteVoucher=function(response){if(response.data.response.success===1){this.moduleCalls('refreshModule');}else{this.showMessage(response.data.response.message,'danger');}}.bind(this);$.post(LC.global.routePaths.BASKET_INTERNAL_DELETE_VOUCHER,{data:JSON.stringify({code:data.code}),},callbackDeleteVoucher,'json');},applyRewardPoints:function(id){const value=$('#rewardPointQuantity_'+id).val();if(value===undefined)return;this.moduleCalls('loadingIndicator',true);this.setTracking('applyRewardPoints');const jsonToSend={id:id,value:value};this.request(LC.global.routePaths.CHECKOUT_INTERNAL_OSC_RECALCULATE,'POST',{rewardPoints:jsonToSend},function(result){this.moduleCalls('loadingIndicator',false);if(result.status.code!=200){return false;}
if(result.data.data.rewardPoints.error.length){this.notify(result.data.data.rewardPoints.error,'danger');}else{this.moduleCalls('refreshModule');this.showMessage(LC.global.languageSheet.oneStepCheckoutRewardPointsRedeemed,'success');}}.bind(this));},refreshModule:function(key,module,force){if(!module||typeof module!=='object')module=this.dataModules[key];this.loadingIndicator(key,module,true);var routeKey=key.replace(/\.?([A-Z]+)/g,(x,y)=>"_"+y).replace(/^_/,"").toUpperCase();var url='';if(LC.global.routePaths['CHECKOUT_INTERNAL_OSC_'+routeKey]){url=LC.global.routePaths['CHECKOUT_INTERNAL_OSC_'+routeKey];}else if(LC.global.routePaths['BASKET_INTERNAL_'+routeKey]){url=LC.global.routePaths['BASKET_INTERNAL_'+routeKey];}
if(url.length&&module.hasOwnProperty('el')){module.el.load(url,module.params,function(data){this.loadingIndicator(key,module,false);if(module.initializeMethod&&$.isFunction(this[module.initializeMethod]))
this[module.initializeMethod](module);this.moduleCallDone('refreshModule',key,function(){this.trigger('onLoad');}.bind(this));}.bind(this));}else if(module.initializeMethod&&$.isFunction(this[module.initializeMethod])){this[module.initializeMethod](module);}else{this.loadingIndicator(key,module,false);}},recalculateBasket:function(module,preventUserRefresh,callback){preventUserRefresh=preventUserRefresh||false;callback=callback||function(){};if(typeof preventUserRefresh==='function'){callback=preventUserRefresh;preventUserRefresh=false;}
if(this.trigger('recalculateBasket')){return;}
this.trigger('recalculateBasketBefore');this.moduleCalls('loadingIndicator',true);this.el.$form.find('button[type=submit]').attr('disabled',true);this.fillDataForm(module);this.dataForm.recalculateUser=!preventUserRefresh;this.tmpProducts=globalThis?.lcCommerceSession?.basket?.rows;this.trigger('initializePaymentsCallback');this.request(LC.global.routePaths.CHECKOUT_INTERNAL_OSC_RECALCULATE,'POST',this.dataForm,function(result){var response=result.response?result.response:result;let items=response.data?.data?.basket.items;if(this.tmpProducts){LC.dataEvents.changeQuantityEvent(this.tmpProducts,items);this.tmpProducts=[];}
if(module&&module.initializeMethod=='initializeUserForm'){if(callback&&typeof callback==='function')callback(response);if(!response.success){}
if(response.user){if(!response.user.success){this.moduleCalls('loadingIndicator',false);if(!preventUserRefresh){var message=response.user.message?response.user.message:'__USER NOT VERIFIED__';this.notify(message,'danger');}
return false;}}
let locationPath='';if(response.data?.data?.checkoutPath.final.search('//')>=0){locationPath=window.location.protocol+"//"+window.location.host;}
locationPath+=window.location.pathname;if(response.data?.data?.checkoutPath.original!=response.data?.data?.checkoutPath.final||(locationPath)!=response.data?.data?.checkoutPath.final){window.location=response.data.data.checkoutPath.final;return;}}
LC.dataEvents.reloadCustomize();this.moduleCalls('refreshModule');if(response.data&&globalThis?.lcCommerceData){globalThis.lcCommerceData.folcsVersion=response.data?.data.folcsVersion;}
this.trigger('recalculateBasketCallback');}.bind(this));},clearBasket:function(){this.moduleCalls('loadingIndicator',true);this.setTracking('clearBasket');$.post(LC.global.routePaths.CHECKOUT_INTERNAL_OSC_RECALCULATE,JSON.stringify({clear:true}),function(data){if(data.response&&data.response.REDIRECT)window.location=data.response.REDIRECT;},'json');},submit:function(ev){ev.preventDefault();if(this.el.$form.find('.address-complete:visible').length!=this.el.$form.find('.userFieldGroupCountry:visible').length){var $result=this.el.$form.find('.userFieldGroupCountry:visible').not('.address-complete:visible');$result.addClass('address-incomplete');$([document.documentElement,document.body]).animate({scrollTop:$result.offset().top-200},1000);return false;}
if(!this.el.$form.isValid(document.documentElement.lang||'en',LC.validateFormConf))return false;this.submitButton.prop('disabled',true);this.el.$form.preventSubmit=false;this.el.$form.activeButton=false;$('<input />',{type:'hidden',name:'ACTION10',value:1}).appendTo(this.el.$form);$('<input />',{type:'hidden',name:'oneStepCheckout',value:1}).appendTo(this.el.$form);LC.resources.pluginListener('beforeSubmitEndOrder',ev,this,true);this.trigger('beforeSubmit');this.setTracking('endOrder');if(this.userForm.el.$form.isValid()&&this.el.$form.isValid()&&!this.el.$form.preventSubmit){if(!this.el.$form.preventSubmit){$.post(LC.global.routePaths.CHECKOUT_INTERNAL_NEXT_STEP,{data:JSON.stringify($.extend(this.dataForm,{updateBasketRows:this.updateBasketRows,action:this.submitButton.val(),osc:true}))},(function(response){if(response.status.code===200){if(response.data.data.redirect.length){window.location=response.data.data.redirect;}}else{this.submitButton.prop('disabled',false);this.notify(LC.global.languageSheet.errorCodeUserExistsEmail,'danger',true);}}).bind(this),'json');}}
if(this.el.$form.activeButton){this.submitButton.prop('disabled',false);}
return;},fillDataForm:function(module){this.dataForm={};const arrDataForm=this.el.$form.find(':not(.userForm *)').serializeArray(),arrDataUserForm=this.el.$form.find(':not(:not(.userForm *))').serializeArray(),arrAddress=['locationList'],noFillFields=[];for(let i=0;i<arrDataForm.length;i++){let name=arrDataForm[i].name;if(this.dataForm[name]&&!isNaN(this.dataForm[name])&&!isNaN(arrDataForm[i].value)){this.dataForm[name]=parseInt(this.dataForm[name])+parseInt(arrDataForm[i].value);}else{if(name.indexOf('quantity')===0){name=name.replace('quantity','');if(name.startsWith("Grid")){let $el=this.el.$form.find(`[name="quantity${name}"]`);this.dataForm[name]={type:$el.data('lc-row-type'),quantity:arrDataForm[i].value,options:$el.data('lc-row-options'),id:$el.closest('[data-lc-grid-product-id]').data('lc-grid-product-id'),};}else{this.dataForm[name]={type:$('[data-lc-hash="'+name+'"]').data('lc-type'),quantity:arrDataForm[i].value};}}else{this.dataForm[name]=arrDataForm[i].value;}}}
if(this.shippingData&&Object.keys(this.shippingData).length){this.dataForm['shippingType']=this.shippingData;}
const inputCustomTags=this.el.$form.find('input[name^="customTags_"]').serializeArray();let customTags=[];for(let i=0;i<inputCustomTags.length;i++){customTags[inputCustomTags[i].name.replace("customTags_","")]=inputCustomTags[i].value;}
this.dataForm.customTags=customTags;let userDataForm={};if(module&&module.initializeMethod==='initializeUserForm'){for(let i=0;i<arrDataUserForm.length;i++){const inNoFillFields=noFillFields.some(el=>arrDataUserForm[i].name.includes(el));if(inNoFillFields){continue;}
const inArrAddress=arrAddress.some(el=>arrDataUserForm[i].name.includes(el));if(arrDataUserForm[i].value.length||inArrAddress)
userDataForm[arrDataUserForm[i].name]=arrDataUserForm[i].value;}}
this.dataForm.userForm=userDataForm;if(module&&module.initializeMethod==='initializePayments'){this.dataForm.paymentSystem=module.data;}
return this.dataForm;},request:function(url,method,data,async,callback){if(typeof async=='function'){callback=async;async=true;}
$.ajax({url:url,type:method,async:async,dataType:'json',data:{data:JSON.stringify(data)}}).done((result,status,xhr)=>{this.responseActions(result);}).fail(function(){}).always(callback.bind(this));},responseActions:function(response){this.validateAddressBook();if(this.hasOwnProperty('inputEmail')){this.inputEmail=this.getInputEmail();if(response?.data?.data?.user?.userExists===true){const formError=`<span class="help-block form-error">${this.userEmailExistsError}</span>`;$(this.inputEmail).data('userEmailExistsOsc',true).closest('.form-group').addClass('has-error').removeClass('has-success').find('span.form-error').remove().end().append(formError);if(document.getElementById('userLogin')){this.loginEmailValue=this.emailInputValue||'';}}else if(response?.data?.data?.user?.userExists===false){$(this.inputEmail).data('userEmailExistsOsc',false).closest('.form-group').addClass('has-success').removeClass('has-error').find('span.form-error').remove();}}},validateAddressBook:function(){this.userForm.el.$form.find('.useShippingAddressGroup').removeClass('has-error');let $useShippingAddress=this.userForm.el.$form.find('input[name="useShippingAddress"]'),$shippingAddress=this.userForm.el.$form.find('input[name="shippingAddress"]');if($useShippingAddress.length&&$useShippingAddress.prop('checked')&&$shippingAddress.length==0){this.userForm.el.$form.find('.useShippingAddressGroup').addClass('has-error');this.notify(LC.global.languageSheet.notAvailableAddress,'danger',true);}},restoreUserFormValidation:function(){this.userForm.el.$form.find('#userEmailField').off('blur');this.userForm.el.$form.find('.blockAddressBook').removeClass('loading');},isValid:function(type,value){if(type=='number')return!isNaN(value);if(type=='email')return $.formUtils.validators.validate_email.validatorFunction(value);else return false;},notify:function(message,type,notifyMode){type=type||'danger';if(typeof notifyMode!=='boolean')notifyMode=this.notifyMode;if(notifyMode)LC.notify(message,{type:type});else this.el.$message.html(message).addClass('alert alert-'+type);},validateFilledUserForm:function(callback,event){if(typeof callback!=='function')callback=function(){};const targetName=event?event.target.name.toLowerCase():'';let inputBelongsToUserForm=false;this.fillDataForm(this.dataModules.userForm);for(let i=0;i<this.userForm.el.$userFieldElements.length;i++){let item=this.userForm.el.$userFieldElements[i];item.name=$(item).attr('name')||'';let inArray=['country','email'].some(el=>item.name.includes(el));if(!item.hasOwnProperty('required')||!item.hasOwnProperty('name')||!item.required||inArray){if(targetName===item.name.toLowerCase()){return false;}
continue;}
if(!this.dataForm.userForm.hasOwnProperty(item.name)){let inArray=['locationList'].some(el=>item.name.includes(el));if(inArray){return false;}}else if(!this.dataForm.userForm[item.name].length){return false;}
if(targetName===item.name.toLowerCase()){inputBelongsToUserForm=true;}}
if(this.userForm.el.hasOwnProperty('$shippingFieldElements')&&typeof this.userForm.el.$shippingFieldElements!=='undefined'&&this.userForm.el.$shippingFieldElements.length&&this.userForm.el.hasOwnProperty('$useShippingAddress')&&this.dataForm.userForm.useShippingAddress){for(let i=0;i<this.userForm.el.$shippingFieldElements[1].length;i++){item=this.userForm.el.$shippingFieldElements[1][i];let inArray=['country','locationList'].some(el=>item.name.includes(el));if(!item.hasOwnProperty('required')||!item.hasOwnProperty('name')||!item.required||inArray){if(targetName===item.name.toLowerCase()){return false;}
continue;}
if(!this.dataForm.userForm.hasOwnProperty(item.name)){let inArray=['locationList'].some(el=>item.name.includes(el));if(!inArray){return false;}}else if(!this.dataForm.userForm[item.name].length){return false;}
if(targetName===item.name.toLowerCase()){inputBelongsToUserForm=true;}}}
if(!inputBelongsToUserForm){return false;}
if(typeof callback==='function'){callback();}
return true;},});
LC.mediaqueries={registerMQ:function(name,mq){if(typeof name!=='string'||typeof mq!=='string'||typeof this[name]==='object')return false;this[name]={firstime:true,match_cb:[],unmatch_cb:[],setup_cb:[],init:function(){LC.mediaqueries.setupMQ.call(this,mq);},setup:function(cb,args){if(typeof cb==='function'){if(!this.firstime){cb.apply(cb,args);}else{this.setup_cb.push([cb,args]);}}},match:function(cb,args){if(this.mediaQuery.matches){cb.apply(cb,args);}
if(typeof cb==='function'){this.match_cb.push([cb,args]);}},unmatch:function(cb,args){if(typeof cb==='function'){this.unmatch_cb.push([cb,args]);}},remove:function(type,cb){LC.mediaqueries.removeCallback(this[type+'_cb'],cb);},};this[name].init();},setupMQ:function(mq){var self=this;self.mediaQuery=window.matchMedia(mq);self.mediaQuery.addListener(function(changed){if(changed.matches){if(self.firstime){LC.mediaqueries.run(self.setup_cb);self.firstime=false;}
LC.mediaqueries.run(self.match_cb);}else{LC.mediaqueries.run(self.unmatch_cb);}});},removeCallback:function(arr,cb){if(Array.isArray(arr)){arr.forEach(function(e,i){if(e[0]===cb){arr.splice(i,1);return arr;}});}else{return false;}},run:function(cbs){cbs.forEach(function(cb){cb[0].apply(cb[0],cb[1]);});},};
LC.initQueue.enqueue(function(agents,userAgent){agents=prepareAgents();userAgent=prepareUserAgent();if(isChecked())return;var agentName,dimensions;for(var i=0;i<agents.length;i++){agentName=getAgentName(agents[i]);dimensions=getDimensions(agents[i]);if(agentName=='*'||userAgent.indexOf(agentName)>-1){if(screen.width<=dimensions.width||screen.height<=dimensions.height){if(agents[i].split('=')[1]==0){setCookie();changeLocation();}
return;}}}
function prepareAgents(){agents=agents||LC.global.settings.mobileAgents||'';return agents.toUpperCase().split(',');}
function prepareUserAgent(){userAgent=userAgent||navigator.userAgent;return userAgent.toUpperCase();}
function getAgentName(agent){var agentName;if(agent.indexOf('[')>-1)agentName=agent.split('[')[0];else agentName=agent.split('=')[0];return agentName;}
function getDimensions(agent){var dimensions='10000X10000';if(agent.indexOf('[')>-1)dimensions=agent.split('[')[1].split(']')[0];return{width:dimensions.split('X')[0]||10000,height:dimensions.split('X')[1]||10000,};}
function isChecked(){if(location.search.indexOf('classic=')>-1)return true;if(window.hasOwnProperty('Cookies')&&Cookies.get(COOKIE_GO_DESKTOP))return true;return false;}
function setCookie(){if(!window.hasOwnProperty('Cookies'))return;Cookies.set(COOKIE_GO_DESKTOP,'1');}
function changeLocation(){var locationSearch=(location.search?location.search+'&':'?')+'classic=true';location.href=location.pathname+locationSearch;}});
'use strict';LC.loadMapsJs=(element)=>{return new Promise((resolve,reject)=>{if(element){const data=$(element).data('lc-data');if(data?.mapKind==='gmap'&&data?.googleApiKey){if(typeof window.google==='undefined'){const locale=LC.global.session.locale.split('_'),language=locale[0]??'en',region=locale[1]??'EN',url=`//maps.googleapis.com/maps/api/js?key=${data.googleApiKey}&language=${language}&region=${region}&libraries=places,marker`;LC.require.js(url,()=>{resolve();});}else{resolve();}}else{reject(Error('mapKind or googleApiKey data not exists'));}}
else{reject(Error('LC.loadMapsJs {element} is null'));}});};LC.dataEvents.getPhysicalLocations=function(event){const $element=$(event.currentTarget),selectData=$element.data('lc'),optionData=$element.find('option:selected').data('lc'),params=new urlParameterEncoder();if(!(selectData.physicalLocationsFilter instanceof Array)){for(const param in selectData.physicalLocationsFilter){params.addParameter(param,selectData.physicalLocationsFilter[param]);}}
params.addParameter('countryCode',optionData.code);$.get(LC.global.routePaths.PHYSICAL_LOCATION+params.getParameters(),(result)=>{LC.maps.reloadModules(result,optionData.code);},'html').fail(function(result){LC.notify(LC.global.languageSheet.errorCodeInternalError,{type:'danger'});});};LC.modalCallbacks.physicalLocationsProviderCallback=function($element,$modal){$modal.find('#pickupPointProviderId, #country, #postalCode').on('change keyup',(event)=>{if($modal.find('#pickupPointProviderId').val().length&&$modal.find('#country').val().length&&$modal.find('#postalCode').val().length){$modal.find('#getPickingDeliveryPoints').attr('disabled',false);}else{$modal.find('#getPickingDeliveryPoints').attr('disabled',true);}});const physicalLocationsMap=$modal.find('.physicalLocationsMap')[0];if(physicalLocationsMap){LC.loadMapsJs(physicalLocationsMap).then(()=>{LC.maps.initialize($modal.find('.lcModalContainer')[0]);});}
if($modal.find('.physicalLocationItem').length==0&&$modal.find('.physicalLocationNoItems').length==0&&globalThis?.lcCommerceSession?.postalCode.length){$modal.find('input[id="postalCode"]').val(lcCommerceSession.postalCode).change();$modal.find('button[id="getPickingDeliveryPoints"]').click();}};LC.dataEvents.getPickingDeliveryPoints=function(event){const $element=$(event.currentTarget),params=new urlParameterEncoder(),$pickingDeliveryPointsSearch=$element.closest('.pickingDeliveryPointsSearch');$element.attr('disabled',true);params.addParameter('pickupPointProviderId',$pickingDeliveryPointsSearch.find('#pickupPointProviderId').val());params.addParameter('countryCode',$pickingDeliveryPointsSearch.find('#country').val());params.addParameter('postalCode',$pickingDeliveryPointsSearch.find('#postalCode').val());$.get(LC.global.routePaths.CHECKOUT_INTERNAL_PICKING_DELIVERY_POINTS+params.getParameters(),(result)=>{let data=$pickingDeliveryPointsSearch.find('#pickupPointProviderId').data('lc');if(data&&data.showPickupPointProviderMapMarkers){let pId=$pickingDeliveryPointsSearch.find('#pickupPointProviderId').find(':selected')?.data('lc')?.pId;LC.maps.icon=`${LC.global.settings.commerceCdnPath}/img/maps/icon_${pId}.png`;LC.maps.iconSelected=`${LC.global.settings.commerceCdnPath}/img/maps/marker_selected_icon_${pId}.png`;}
LC.maps.reloadModules(result);LC.maps.setMarkers();LC.maps.centerMarkersOnMap();$element.attr('disabled',false);},'html').fail(function(result){LC.notify(LC.global.languageSheet.errorCodeInternalError,{type:'danger'});$element.attr('disabled',false);});};LC.dataEvents.filterPhysicalLocations=function(event){const $element=$(event.currentTarget);let optionValue=$element.find('option:selected').val(),optionData=JSON.parse($element.find('option:selected').attr('data-lc')),$childrenSelector=[],$selectors=$element.closest('.physicalLocationSelectors'),setDefault=0,$locationSearch=$selectors.find('#locationSearch');if($locationSearch.length){$locationSearch.data('lc-country',optionData.countryCode);}
if($element.prop('setDefault')!=undefined){setDefault=$element.prop('setDefault');$element.prop('setDefault',0);$element.find('option').each((index,element)=>{let data=JSON.parse($(element).attr('data-lc'));if($.inArray('physicalLocation'+setDefault,data.ids)>=0){$(element).prop('selected',true);}});}
if($element.attr("name")==='country'){$childrenSelector=$selectors.find('#state');if(!$childrenSelector.length)
$childrenSelector=$selectors.find('#city');if(!$childrenSelector.length)
$childrenSelector=$selectors.find('#postalCode');}
if($element.attr("name")==='state'){$childrenSelector=$selectors.find('#city');if(!$childrenSelector.length)
$childrenSelector=$selectors.find('#postalCode');}else if($element.attr("name")==='city'){$childrenSelector=$selectors.find('#postalCode');}
if($childrenSelector.length){let selectDefault=false,allOptionIds=[];$childrenSelector.find('option').each((i,element)=>{const data=JSON.parse($(element).attr('data-lc')),$physicalLocationItem=$(element).closest('.physicalLocationItem');if(data.parent===optionValue||$(element).val()==='ALL'){$(element).prop('disabled',false).show();$physicalLocationItem.addClass('show');if(!selectDefault&&(setDefault===0||(setDefault>0&&$.inArray('physicalLocation'+setDefault,data.ids)>=0))){$childrenSelector.val($(element).val());selectDefault=true;}
if($(element).val()!='ALL'){allOptionIds=$.merge(allOptionIds,data.ids);}}else{$(element).prop('disabled',true).hide();$physicalLocationItem.removeClass('show');}});if($childrenSelector.find('option[value="ALL"]').length){if(!allOptionIds.length){$childrenSelector.find('option[value="ALL"]').attr('data-lc',$element.find('option:selected').attr('data-lc'));}else{$childrenSelector.find('option[value="ALL"]').attr('data-lc',JSON.stringify({ids:allOptionIds,parent:optionValue}));}}
if(setDefault>0){$childrenSelector.prop('setDefault',setDefault);}
$childrenSelector.change();}else{let selectDefault=false,$physicalLocationItems=$element.closest('.physicalLocations').find('.physicalLocationItems');if(!$physicalLocationItems.length){$physicalLocationItems=$('.physicalLocations').find('.physicalLocationItems');}
$physicalLocationItems.find('.physicalLocationItem').removeClass('show selected');$physicalLocationItems.find('[name="physicalLocation"]').prop('checked',false);for(let i=0;i<optionData.ids.length;i++){const $physicalLocation=$physicalLocationItems.find(`input#${optionData.ids[i]}`),$physicalLocationItem=$physicalLocation.closest('.physicalLocationItem');$physicalLocationItem.addClass('show');if(!selectDefault&&(setDefault>0&&optionData.ids[i]===`physicalLocation${setDefault}`)){$physicalLocationItem.addClass('selected');selectDefault=true;}}}
if(LC.maps.map){LC.maps.setMarkers();LC.maps.centerMarkersOnMap();}};LC.modalCallbacks.physicalLocationsCallback=function(element,modal){LC.dataEvents.initFilterPhysicalLocations($(modal.find('[name="initSelectors"]')[0]));};LC.dataEvents.initFilterPhysicalLocations=function(element){const $element=$(element),data=$element.data('lc'),$selector=$element.closest('.physicalLocationSelectors').find('#'+data);$element.closest('.modal-content').find('button.savePickingSelectionButton').prop('disabled',true);if($element.val()>0){$selector.prop('setDefault',$element.val());$element.closest('.modal-content').find('button.savePickingSelectionButton').prop('disabled',false);}
$selector.change();const physicalLocationsMap=element.closest('.physicalLocations')[0].querySelector('.physicalLocationsMap');if(physicalLocationsMap){LC.loadMapsJs(physicalLocationsMap).then(()=>{LC.maps.initialize(physicalLocationsMap);});}};LC.dataEvents.selectPhysicalLocation=function(event){const $element=$(event.currentTarget),data=$element.data('lc'),$physicalLocationItems=$element.closest('.physicalLocations').find('.physicalLocationItems'),$physicalLocationItem=$element.closest('.physicalLocationItem');$physicalLocationItems.find('.physicalLocationItem').removeClass('selected');$physicalLocationItem.addClass('selected');const physicalLocationsMap=event.currentTarget.closest('.physicalLocationsMap');if(physicalLocationsMap){LC.maps.selectPhysicalLocation($(event.currentTarget),true,data.id);}
$element.closest('.modal-content').find('button.savePickingSelectionButton').prop('disabled',false);};LC.maps={options:{zoom:4,zoomControl:false,mapTypeControl:false,scaleControl:true,streetViewControl:true,rotateControl:false,fullscreenControl:false,dragging:true,scrollWheelZoom:true,doubleClickZoom:true,keyboard:true,show:true,showMap:true,maxZoom:18,showMarkerInfo:false,showMarkerInfoTemplate:null,infoWindowOptions:{maxWidth:350,},mapId:''},infoWindow:null,container:null,mapLayer:null,mapKind:'gmap',icon:`${LC.global.settings.commerceCdnPath}/img/maps/icon.png`,iconSelected:`${LC.global.settings.commerceCdnPath}/img/maps/marker_selected_icon.png`,userIcon:`${LC.global.settings.commerceCdnPath}/img/maps/user_icon.png`,markers:[],map:null,markerSelectedOnLoad:false,userMarker:null,directionsService:null,directionsRenderer:null,initialize(target,options={}){if(target){this.options={...this.options,...options};this.container=target;this.mapLayer=target.querySelector('.mapInstance');if(this.mapLayer){if(options.mapKind){this.mapKind=options.mapKind;}
if(this.mapKind==='gmap'){this.initGoogleMaps();}
if(!$(this.container).find('.physicalLocationItem.show').length){$(this.container).find('.mapPhysicalLocationsList').hide();}else{$(this.container).find('.mapPhysicalLocationsList').show();}}}},initGoogleMaps(){this.options.mapId=$(this.mapLayer).attr('id')?$(this.mapLayer).attr('id'):'gmap';this.map=new google.maps.Map(this.mapLayer,this.options);this.setMarkers();const modal=document.getElementById('physicalLocations');const modalPickupPointProviders=document.getElementById('pickupPointProviders');if(modal){modal.addEventListener('shown.bs.modal',(event)=>{this.whereCenterTheMap();this.getCurrentPosition();})}
if(modalPickupPointProviders){modalPickupPointProviders.addEventListener('shown.bs.modal',(event)=>{this.whereCenterTheMap();this.getCurrentPosition();})}
else if(document.querySelector('.returnProductsPopupModal.show')){this.whereCenterTheMap();this.getCurrentPosition();}else if(document.querySelector('.physicalLocationsMap')){this.whereCenterTheMap();this.getCurrentPosition();}
this.placesAutocomplete.init();$(this.container).on('click','.physicalLocationItem .directions',(event)=>{event.preventDefault();this.setDirections();});$(this.container).on('click','.traceTravelToolbar .driving',(event)=>{event.preventDefault();this.setDirections('DRIVING');});$(this.container).on('click','.traceTravelToolbar .walking',(event)=>{event.preventDefault();this.setDirections('WALKING');});$(this.container).on('click','.showAllMapMarkers',(event)=>{event.preventDefault();this.centerMarkersOnMap();});if($(this.container).find('[data-lc-check-visibility="true"]').length){this.map.addListener('bounds_changed',this.checkVisiblePoints);}},checkVisiblePoints(){let bounds=LC.maps.map.getBounds(),$container=$(LC.maps.container),countLocations=0;if(!bounds)return;for(let i=0;i<LC.maps.markers.length;i++){let latLng=new google.maps.LatLng(LC.maps.markers[i].lat,LC.maps.markers[i].lng),$physicalLocation=$container.find(`#physicalLocation${LC.maps.markers[i].id}`),$physicalLocationItem=$physicalLocation.closest('.physicalLocationItem');if(!$physicalLocationItem.hasClass('selected')){if(bounds.contains(latLng)){$physicalLocationItem.show();countLocations+=1;}else{$physicalLocationItem.hide();}}else{countLocations+=1;}}
$container.find('.physicalLocationsMapResults').html(`${countLocations} ${LC.global.languageSheet.locatorResults}`);},whereCenterTheMap(){if(this.markerSelectedOnLoad){let $selected=$(this.container).find('.physicalLocationItem.selected').find('input[name="physicalLocation"');if(!$selected.length){$selected=$(this.container).find('[name="physicalLocation"]:checked');}
const selectedMarker=this.getMarker();if($selected.length&&selectedMarker){LC.maps.selectPhysicalLocation($selected,true,selectedMarker.id);}}else{this.centerMarkersOnMap();}},placesAutocomplete:{autocomplete:null,autocompleteService:null,placesAutocompleteInput:null,init(){this.placesAutocompleteInput=document.querySelector('[name="placesAutocomplete"]');if(this.placesAutocompleteInput){this.autocomplete=new google.maps.places.Autocomplete(this.placesAutocompleteInput,{types:['geocode']});this.autocompleteService=new google.maps.places.AutocompleteService();LC.maps.map.addListener("bounds_changed",()=>{this.autocomplete.setBounds(LC.maps.map.getBounds());});this.placesChanged();}},placesChanged(){this.autocomplete.addListener("place_changed",()=>{let place=this.autocomplete.getPlace();if(!place.geometry||!place.geometry.location){this.autocompleteService.getPlacePredictions({input:this.placesAutocompleteInput.value,types:['geocode'],},(predictions,status)=>{if(status!=google.maps.places.PlacesServiceStatus.OK){this.placesAutocompleteInput.closest('.form-group').classList.add('has-error');return;}
const placeService=new google.maps.places.PlacesService(document.createElement('div'));placeService.getDetails({placeId:predictions[0].place_id},(result,status)=>{place=result;this.submitPlace(place);});});}else{this.submitPlace(place);}});},submitPlace(place){if(place.geometry.viewport){LC.maps.map.fitBounds(place.geometry.viewport);}else{LC.maps.map.setCenter(place.geometry.location);}},},setMarkers(){this.removeMarkers();$(this.container).find('.physicalLocationItem.show').each((index,el)=>{const data=$(el).find('input[name="physicalLocation"], input[name="returnDelivery"]').data('lc'),latitude=data.location.coordinate.latitude,longitude=data.location.coordinate.longitude;let icon=document.createElement('img');icon.src=this.icon;const marker=new google.maps.marker.AdvancedMarkerElement({id:index,map:this.map,position:{lat:latitude,lng:longitude},content:icon});this.addEventMarker(marker,'click','centerAndDisplay',data);if(this.options.showMarkerInfo){this.addEventMarker(marker,'click','showMarkerInfo',data);}
this.markers.push({id:data.id,obj:marker,lat:latitude,lng:longitude});if($(el).hasClass('selected')||$(el).find('[name="physicalLocation"]:checked').length){this.markerSelectedOnLoad=true;}});this.setTotalResults();$(this.container).find('button.savePickingSelectionButton');if($(this.container).find('.physicalLocationItem.show').length&&$(this.container).find('[name="physicalLocation"]:checked').length){$(this.container).closest('.modal-content').find('button.savePickingSelectionButton').prop('disabled',false);this.whereCenterTheMap();}else{$(this.container).closest('.modal-content').find('button.savePickingSelectionButton').prop('disabled',true);}},bounceMarker(marker){if(marker.animation!=google.maps.Animation.BOUNCE){marker.animation=google.maps.Animation.BOUNCE;setTimeout(function(){marker.animation=null;},1475);}},setTotalResults(){$(this.container).find('.physicalLocationsMapResults').html(`${this.markers.length} ${LC.global.languageSheet.locatorResults}`);},getMarker(physicalLocationId){if(!physicalLocationId){let $selected=$(this.container).find('.physicalLocationItem.selected');if(!$selected.length){physicalLocationId=$(this.container).find('[name="physicalLocation"]:checked').data('lc').id;}else{physicalLocationId=$selected.find('input[name="physicalLocation"], input[name="returnDelivery"]').data('lc').id;}}
for(let i=0;i<this.markers.length;i++){if(this.markers[i].id===physicalLocationId){return this.markers[i];}}
return null;},showMarkers(){for(let i=0;i<this.markers.length;i++){this.markers[i].obj.map=this.map;}},removeMarkers(){for(let i=0;i<this.markers.length;i++){this.markers[i].obj.map=null;}
this.markerSelectedOnLoad=false;this.removeDirectionsRender();this.markers=[];},removeDirectionsRender(){if(this.directionsRenderer){this.directionsRenderer.setMap(null);this.directionsRenderer.setPanel(null);}},centerMarkersOnMap(){const bounds=new google.maps.LatLngBounds();for(let i=0;i<this.markers.length;i++){const marker=this.markers[i].obj;bounds.extend(marker.position);}
if(this.userMarker){bounds.extend(this.userMarker.position);}
this.map.setCenter(bounds.getCenter());this.map.fitBounds(bounds);},centerMarkerOnMap(marker){const latLng=new google.maps.LatLng(marker.position.lat,marker.position.lng);this.map.panTo(latLng);this.setMapSmoothZoom(this.options.maxZoom,this.map.getZoom());},centerLatLngOnMap(lat,lng,zooms,minResults=0,maxResults=0){this.centerMarkersOnMap();const latLng=new google.maps.LatLng(lat,lng);this.map.panTo(latLng);this.setMapSmoothZoom(zooms,this.map.getZoom(),minResults,maxResults);},addEventMarker(marker,eventType,action,data={}){if(action==='centerAndDisplay'){marker.addListener(eventType,(item)=>{const $physicalLocation=$(this.container).find('[name="physicalLocation"], input[name="returnDelivery"]').filter((index,el)=>parseInt(el.value)===data.id);this.selectPhysicalLocation($physicalLocation,false,data.id);this.bounceMarker(marker);for(var i=0;i<this.markers.length;i++){let icon=document.createElement('img');icon.src=this.icon;this.markers[i].obj.content=icon;}
let iconSelected=document.createElement('img');iconSelected.src=this.iconSelected;marker.content=iconSelected;});}else if(action==='center'){marker.addListener(eventType,(item)=>{this.centerMarkerOnMap(marker);this.bounceMarker(marker);});}else if(action==='showMarkerInfo'){marker.addListener(eventType,(item)=>{this.showMarkerInfo(marker,data);});}},showMarkerInfo(marker,data){this.closeOpenInfoWindow();this.infoWindow=new google.maps.InfoWindow({...{content:this.getInfoWindowContent(data),},...this.options.infoWindowOptions});this.infoWindow.open({anchor:marker,map:this.map,shouldFocus:false,});},closeOpenInfoWindow(){if(this.infoWindow){this.infoWindow.close();this.infoWindow=null;}},updateMapOptions(options){this.map.setOptions(options);this.options={...this.options,...options};},selectPhysicalLocation($physicalLocation,centerMap,physicalLocationId){const $physicalLocationItems=$physicalLocation.closest('.physicalLocationItems'),marker=this.getMarker(physicalLocationId);$physicalLocationItems.find('.physicalLocationItem').removeClass('selected');$physicalLocation.click();$physicalLocation.closest('.physicalLocationItem').addClass('selected');$physicalLocationItems.animate({scrollTop:$physicalLocationItems.scrollTop()+$physicalLocation.closest('.physicalLocationItem').position().top,},500);this.toggleTraceToolbar(false);this.removeDirectionsRender();this.setSelectedIconMarker(marker);marker.obj.map=this.map;if(this.options.showMarkerInfo){setTimeout(()=>{this.showMarkerInfo(marker.obj,$physicalLocation.data('lc'));},this.getZoomDurationTime());}
if(centerMap){this.centerMarkerOnMap(marker.obj);}},setSelectedIconMarker(marker){for(var i=0;i<this.markers.length;i++){let icon=document.createElement('img');icon.src=this.icon;this.markers[i].obj.content=icon;}
let iconSelected=document.createElement('img');iconSelected.src=this.iconSelected;marker.obj.content=iconSelected;},checkZoomMarkers(newZoomLevel){const currentZoom=this.map.getZoom();this.map.setZoom(newZoomLevel);const newBounds=this.map.getBounds();this.map.setZoom(currentZoom);const visibleMarkers=this.markers.filter(marker=>newBounds.contains(new google.maps.LatLng(marker.lat,marker.lng)));return visibleMarkers.length;},setMapSmoothZoom(max,cnt,minResults=0,maxResults=0){let shouldZoom=cnt<max;if(minResults>0||maxResults>0){let newZoomMarkers=this.checkZoomMarkers(cnt);if(shouldZoom&&minResults>0&&newZoomMarkers<minResults){shouldZoom=false;}
if(cnt>=max&&maxResults>0){shouldZoom=newZoomMarkers>=maxResults;}}
if(!shouldZoom){return;}else{const z=google.maps.event.addListener(this.map,'zoom_changed',(event)=>{google.maps.event.removeListener(z);this.setMapSmoothZoom(max,cnt+1,minResults,maxResults);});setTimeout(()=>{this.map.setZoom(cnt,{duration:50});},80);}},getZoomDurationTime(){const currentZoom=(18-this.map.getZoom());let zoomResponseTime=100;if(currentZoom!==0){const timeOutZoomDuration=currentZoom*80;const zoomDuration=currentZoom*50;zoomResponseTime=(timeOutZoomDuration+zoomDuration);}
return zoomResponseTime},getCurrentPosition(){const errorMessage=LC.global.languageSheet.locatorTraceTravelBrowserUnavailable;if(navigator.geolocation){navigator.geolocation.getCurrentPosition((position)=>{let userIcon=document.createElement('img');userIcon.src=this.userIcon;this.userMarker=new google.maps.marker.AdvancedMarkerElement({position:new google.maps.LatLng(position.coords.latitude,position.coords.longitude),map:this.map,content:userIcon});this.addEventMarker(this.userMarker,'click','center');$(this.container).find('.physicalLocationItem .directions').removeClass('d-none');this.whereCenterTheMap();},(error)=>{this.showCurrentPositionError(error.message,error);},{timeout:100000,});}else{this.showCurrentPositionError(errorMessage);}},showCurrentPositionError(errorMessage,error=null){if(error&&error.code!==error.PERMISSION_DENIED){LC.notify(errorMessage,{type:'danger'});}else if(errorMessage.length&&error==null){LC.notify(errorMessage,{type:'danger'});}},setDirections(mode='DRIVING'){if(!this.userMarker){this.getCurrentPosition();return;}
this.setMarkers();if(!this.directionsService||!this.directionsRenderer){this.directionsService=new google.maps.DirectionsService();this.directionsRenderer=new google.maps.DirectionsRenderer();}
const selectedMarker=this.getMarker().obj,request={origin:this.userMarker.position,destination:selectedMarker.position,travelMode:google.maps.TravelMode[mode],};this.directionsService.route(request,(response,status)=>{if(status===google.maps.DirectionsStatus.OK){selectedMarker.map=null;this.toggleTraceToolbar(true,mode,response.routes[0].legs[0].duration.text,response.routes[0].legs[0].distance.text);this.directionsRenderer.setDirections(response);this.directionsRenderer.setMap(this.map);}else{const errorMessage=LC.global.languageSheet.locatorTraceTravelUnavailable;LC.notify(errorMessage,{type:'danger'});}});const bounds=new google.maps.LatLngBounds();bounds.extend(this.userMarker.position);bounds.extend(selectedMarker.position);this.map.fitBounds(bounds);},toggleTraceToolbar(show,mode,duration,distance){if(show){$(this.container).find('.traceTravelToolbarButton').removeClass('active');if(mode==='DRIVING'){$(this.container).find('.driving').addClass('active');}else{$(this.container).find('.walking').addClass('active');}
$(this.container).find('.traceTravelToolbarData .duration').html(duration);$(this.container).find('.traceTravelToolbarData .distance').html(distance);$(this.container).find('.traceTravelToolbar').slideDown(function(){$(this).attr('aria-hidden',false);});}else{$(this.container).find('.traceTravelToolbar').slideUp(function(){$(this).attr('aria-hidden',true);});}},getInfoWindowContent(data){let content='';if(typeof this.options.showMarkerInfoTemplate==='string'){content=this.options.showMarkerInfoTemplate;content=content.replaceAll('{{name}}',data.name??'');content=content.replaceAll('{{address}}',data.address??'');content=content.replaceAll('{{postalCode}}',data.postalCode??'');content=content.replaceAll('{{city}}',data.city??'');content=content.replaceAll('{{state}}',data.state??'');content=content.replaceAll('{{country}}',data.country??'');content=content.replaceAll('{{phone}}',data.phone??'');content=content.replaceAll('{{email}}',data.email??'');content=content.replaceAll('{{information}}',data?.language?.information??'');}else{if(data?.name)content+=`<div class="marker name"><b>${data?.name}</b></div>`;if(data?.address)content+=`<div class="marker address">${data?.address}</div>`;if(data?.postalCode||data?.city||data?.state||data?.country)
content+=`<div class="marker proximity">${data?.postalCode} ${data?.city} ${data?.state} ${data?.country}</div>`;if(data?.phone)content+=`<div class="marker phone">${data.phone}</div>`;if(data?.email)content+=`<div class="marker email">${data.email}</div>`;if(data?.language?.information)content+=`<div class="marker info">${data.language.information}</div>`;}
return content;},reloadModules(html,countryCode=''){const $result=$(html);const $noItems=$result.find('.physicalLocationNoItems');const $locationSearch=$result.find('#locationSearch');if(countryCode.length&&$locationSearch){$locationSearch.data('lc-country',countryCode);}
$(this.container).find('.mapPhysicalLocationsList').show();if($noItems.length){if(LC.maps.map){LC.maps.removeMarkers();}
if(document.querySelector('.returnProductsPopupModal.show')||location.pathname.includes(LC.global.routePaths.PHYSICAL_LOCATION_STORES)){LC.notify(LC.global.languageSheet.physicalLocationNone,{type:'danger',});}
$(this.container).find('.mapPhysicalLocationsList').html($noItems);}
let physicalLocations=$(this.container).find('.physicalLocations');if(physicalLocations.length===0){physicalLocations=$(this.container).closest('.physicalLocations');}
physicalLocations.each((index,el)=>{const $physicalLocationSelectors=$(el).find('.physicalLocationSelectors');const $traceTravelToolbar=$(el).find('.traceTravelToolbar');const $mapPhysicalLocationsList=$(el).find('.mapPhysicalLocationsList');if($result.find('.physicalLocationSelectors').length){$physicalLocationSelectors.replaceWith($result.find('.physicalLocationSelectors'));}else{$physicalLocationSelectors.html('');}
if($result.find('.traceTravelToolbar').length){$traceTravelToolbar.replaceWith($result.find('.traceTravelToolbar'));}else{$traceTravelToolbar.html('');}
if($result.find('.mapPhysicalLocationsList').length){$mapPhysicalLocationsList.replaceWith($result.find('.mapPhysicalLocationsList'));}else if(!$noItems.length){$mapPhysicalLocationsList.html('');}}).find('[data-lc-event]').dataEvent();},};